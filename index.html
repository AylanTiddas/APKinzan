<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Découvrez et explorez des milliers de proverbes kabyles (Inzan). Une collection interactive de la sagesse populaire de Kabylie avec des explications, des favoris et des suggestions par IA.">
    
    <meta name="theme-color" content="#F9F7F3">
    
    <meta property="og:title" content="Inzan n Teqbaylit - Trésors de la Sagesse Kabyle">
    <meta property="og:description" content="Explorez des milliers de proverbes kabyles (Inzan) avec explications et suggestions par IA.">
    <meta property="og:type" content="website">
    
    <link rel="manifest" href="data:application/json,{
        &quot;name&quot;: &quot;Inzan n Teqbaylit&quot;,
        &quot;short_name&quot;: &quot;Inzan&quot;,
        &quot;start_url&quot;: &quot;.&quot;,
        &quot;display&quot;: &quot;standalone&quot;,
        &quot;background_color&quot;: &quot;#F9F7F3&quot;,
        &quot;theme_color&quot;: &quot;#4A7C59&quot;,
        &quot;description&quot;: &quot;Trésors de la Sagesse Kabyle&quot;,
        &quot;icons&quot;: [
            { &quot;src&quot;: &quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%23F9F7F3'%3E%3C/rect%3E%3Ctext y='.9em' font-size='90' fill='%234A7C59'%3E%E2%9C%A7%3C/text%3E%3C/svg%3E&quot;, &quot;sizes&quot;: &quot;192x192&quot;, &quot;type&quot;: &quot;image/svg+xml&quot; }
        ]
    }">

    <title>Inzan n Teqbaylit - Sagesse Kabyle Moderne</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#4A7C59',
                        secondary: '#3A644B',
                        accent: '#C79A2A',
                        paper: '#F9F7F3',
                        darkbg: '#101418',
                        darkcard: '#1A2026'
                    },
                    fontFamily: {
                        serif: ['Tinos', 'serif'],
                        sans: ['Raleway', 'sans-serif'],
                    },
                    animation: {
                        'blob': 'blob 7s infinite',
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tinos:ital,wght@0,400;0,700;1,400&family=Raleway:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Ctext y=%22.9em%22 font-size=%2290%22 fill=%22%234A7C59%22%3E%E2%9C%A7%3C/text%3E%3C/svg%3E">

    <style>
        /* Modern Reset & Variables */
        :root {
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        html.dark {
            --glass-border: rgba(255, 255, 255, 0.05);
            --glass-bg: rgba(26, 32, 38, 0.7);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: 'Raleway', sans-serif;
            background-color: #F9F7F3;
            color: #3D4A3A;
            -webkit-tap-highlight-color: transparent;
        }

        html.dark body {
            background-color: #0f1216;
            color: #e2e8f0;
        }

        /* Ambient Background Animation */
        .ambient-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            z-index: -1;
            pointer-events: none;
        }
        .ambient-blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
        }
        .blob-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: #C79A2A; animation-delay: 0s; }
        .blob-2 { bottom: -10%; right: -10%; width: 50vw; height: 50vw; background: #4A7C59; animation-delay: 2s; }
        .blob-3 { top: 40%; left: 40%; width: 40vw; height: 40vw; background: #3A644B; animation-delay: 4s; opacity: 0.2; }
        
        html.dark .blob-1 { background: #b45309; opacity: 0.15; }
        html.dark .blob-2 { background: #064e3b; opacity: 0.2; }
        html.dark .blob-3 { background: #1e3a8a; opacity: 0.15; }

        /* Glassmorphism Utilities */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.4);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        html.dark .glass-card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(255,255,255,0.05);
        }

        .glass-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px -8px rgba(0, 0, 0, 0.15);
        }

        /* Typography Enhancements */
        .proverb-text {
            font-feature-settings: "liga" 1, "kern" 1;
            line-height: 1.4;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(156, 163, 175, 0.5);
            border-radius: 10px;
        }
        
        /* Navigation Styles */
        .nav-dock {
            padding-bottom: env(safe-area-inset-bottom);
        }
        
        .nav-item.active {
            color: #4A7C59;
        }
        .nav-item.active svg {
            fill: rgba(74, 124, 89, 0.15);
        }
        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: 4px; /* Adjust for spacing */
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background-color: #4A7C59;
        }

        html.dark .nav-item.active { color: #52B788; }
        html.dark .nav-item.active svg { fill: rgba(82, 183, 136, 0.15); }
        html.dark .nav-item.active::after { background-color: #52B788; }

        /* Loader */
        .loader {
            width: 24px;
            height: 24px;
            border: 3px solid currentColor;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Transitions */
        .fade-enter { opacity: 0; transform: translateY(10px); }
        .fade-enter-active { opacity: 1; transform: translateY(0); transition: opacity 300ms, transform 300ms; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeInUp 0.4s ease-out; }

        /* Splash Screen */
        #splash-screen { transition: opacity 0.6s ease-out, visibility 0.6s; }
        #splash-screen.hidden { opacity: 0; visibility: hidden; }
    </style>
</head>
<body class="antialiased min-h-screen pb-24 sm:pb-8 selection:bg-accent selection:text-white">

    <!-- Ambient Background -->
    <div class="ambient-bg">
        <div class="ambient-blob blob-1 animate-blob"></div>
        <div class="ambient-blob blob-2 animate-blob"></div>
        <div class="ambient-blob blob-3 animate-blob"></div>
    </div>

    <!-- Splash Screen -->
    <div id="splash-screen" class="fixed inset-0 bg-paper dark:bg-darkbg z-[200] flex flex-col items-center justify-center">
        <div class="relative w-32 h-32 flex items-center justify-center mb-6">
            <svg class="w-full h-full text-primary animate-pulse" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="45" stroke="currentColor" stroke-width="2" fill="none" opacity="0.3" />
                <circle cx="50" cy="50" r="35" stroke="currentColor" stroke-width="2" fill="none" opacity="0.6" />
                <text x="50" y="70" font-size="60" text-anchor="middle" fill="currentColor" class="font-serif">ⵣ</text>
            </svg>
        </div>
        <h1 class="text-3xl font-serif font-bold text-gray-800 dark:text-gray-100 tracking-wider">Inzan</h1>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2 font-medium">Sagesse Kabyle</p>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-10">
        
        <!-- Header -->
        <header class="pt-6 pb-4 sm:pt-10 sm:pb-8 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 sm:w-12 sm:h-12 bg-primary/10 rounded-xl flex items-center justify-center text-primary dark:text-green-400">
                    <span class="font-serif text-2xl sm:text-3xl font-bold">ⵣ</span>
                </div>
                <div>
                    <h1 class="text-xl sm:text-2xl font-bold font-serif text-gray-800 dark:text-gray-100 leading-tight">Inzan n Teqbaylit</h1>
                    <p class="text-xs sm:text-sm text-gray-500 dark:text-gray-400 font-medium">Trésors de la Sagesse</p>
                </div>
            </div>
            
            <button id="theme-toggle" aria-label="Mode sombre" class="w-10 h-10 rounded-full bg-white/50 dark:bg-white/10 flex items-center justify-center shadow-sm backdrop-blur-sm transition-transform hover:scale-110 active:scale-95 border border-gray-200 dark:border-gray-700">
                <svg id="theme-icon-light" class="w-5 h-5 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                <svg id="theme-icon-dark" class="w-5 h-5 text-yellow-300 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
            </button>
        </header>

        <!-- Desktop Navigation -->
        <nav class="hidden sm:flex justify-center mb-10 sticky top-4 z-40">
            <div class="glass px-2 py-1.5 rounded-2xl flex items-center gap-1 shadow-lg border border-white/40 dark:border-white/10">
                <button data-tab="accueil-tab" class="nav-btn desktop px-5 py-2.5 rounded-xl font-semibold text-sm transition-all hover:bg-gray-100/50 dark:hover:bg-white/5 text-gray-600 dark:text-gray-300 active bg-white dark:bg-white/10 shadow-sm text-primary dark:text-primary">Accueil</button>
                <button data-tab="explorer-tab" class="nav-btn desktop px-5 py-2.5 rounded-xl font-semibold text-sm transition-all hover:bg-gray-100/50 dark:hover:bg-white/5 text-gray-600 dark:text-gray-300">Explorer</button>
                <button data-tab="favoris-tab" class="nav-btn desktop px-5 py-2.5 rounded-xl font-semibold text-sm transition-all hover:bg-gray-100/50 dark:hover:bg-white/5 text-gray-600 dark:text-gray-300">Favoris</button>
                <button data-tab="ai-sage-tab" class="nav-btn desktop px-5 py-2.5 rounded-xl font-semibold text-sm transition-all hover:bg-gray-100/50 dark:hover:bg-white/5 text-gray-600 dark:text-gray-300 flex items-center gap-2">
                    <span>Sage AI</span> <span class="bg-accent/20 text-accent text-[10px] px-1.5 rounded uppercase tracking-wider font-bold">New</span>
                </button>
                <button data-tab="quiz-tab" class="nav-btn desktop px-5 py-2.5 rounded-xl font-semibold text-sm transition-all hover:bg-gray-100/50 dark:hover:bg-white/5 text-gray-600 dark:text-gray-300">Quiz</button>
            </div>
        </nav>

        <main class="min-h-[60vh]">
            
            <!-- ACCUEIL TAB -->
            <section id="accueil-tab" class="tab-content active">
                <div class="text-center mb-10 fade-in-up">
                    <span class="inline-block py-1 px-3 rounded-full bg-primary/10 text-primary dark:text-green-300 text-xs font-bold tracking-wide mb-4 border border-primary/20">
                        TIMSIRIN N ZIK
                    </span>
                    <h2 class="text-4xl md:text-5xl font-serif font-bold text-gray-800 dark:text-white mb-4 leading-tight">
                        La sagesse des anciens<br>
                        <span class="text-primary italic relative inline-block">
                            au bout des doigts
                            <svg class="absolute -bottom-2 left-0 w-full h-2 text-accent opacity-60" viewBox="0 0 100 10" preserveAspectRatio="none"><path d="M0 5 Q 50 10 100 5" stroke="currentColor" stroke-width="3" fill="none"/></svg>
                        </span>
                    </h2>
                    <p class="text-gray-600 dark:text-gray-400 max-w-xl mx-auto text-lg mt-6 leading-relaxed">
                        Explorez une collection de <strong class="text-gray-900 dark:text-gray-100 font-bold" id="proverb-count">...</strong> proverbes kabyles expliqués. Une immersion culturelle enrichie par l'intelligence artificielle.
                    </p>
                </div>

                <div class="max-w-3xl mx-auto mb-16">
                    <div class="flex items-center gap-2 mb-4 px-2">
                        <div class="h-px bg-gray-300 dark:bg-gray-700 flex-grow"></div>
                        <span class="text-sm font-bold text-gray-400 uppercase tracking-widest">Proverbe du Jour</span>
                        <div class="h-px bg-gray-300 dark:bg-gray-700 flex-grow"></div>
                    </div>
                    
                    <div id="proverb-of-the-day-card" class="transform transition-all duration-500 hover:scale-[1.01]">
                        <!-- Content loaded by JS -->
                        <div class="glass-card p-8 rounded-2xl text-center min-h-[200px] flex flex-col items-center justify-center">
                            <span class="loader text-primary"></span>
                        </div>
                    </div>
                </div>
                
                <div class="max-w-3xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-4 fade-in-up" style="animation-delay: 0.2s;">
                    <div class="glass-card p-6 rounded-2xl border-l-4 border-accent relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <svg class="w-24 h-24 text-accent" viewBox="0 0 24 24" fill="currentColor"><path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                        </div>
                        <h3 class="font-serif font-bold text-lg text-gray-800 dark:text-white mb-2">L'Origine</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 leading-relaxed relative z-10">
                            Basé sur l'œuvre magistrale <strong class="text-primary">"INZAN amek i d-llan"</strong> de M. Aomar SIDER. Une référence incontournable disponible en librairie.
                        </p>
                    </div>
                    <div class="glass-card p-6 rounded-2xl border-l-4 border-primary relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                            <svg class="w-24 h-24 text-primary" viewBox="0 0 24 24" fill="currentColor"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                        </div>
                        <h3 class="font-serif font-bold text-lg text-gray-800 dark:text-white mb-2">Technologie</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 leading-relaxed relative z-10">
                            Propulsé par <strong class="text-primary">Gemini AI</strong> pour des explications contextuelles et des quiz génératifs uniques.
                        </p>
                    </div>
                </div>
            </section>

            <!-- EXPLORER TAB -->
            <section id="explorer-tab" class="tab-content">
                <div class="sticky top-4 z-30 mb-8 transition-all duration-300" id="search-container">
                    <div class="glass rounded-2xl p-4 shadow-xl border border-white/50 dark:border-white/10">
                        <!-- Tamazight Keyboard -->
                        <div class="flex gap-2 overflow-x-auto pb-3 mb-2 custom-scrollbar mask-gradient-r">
                            <button class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 rounded-lg bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm hover:bg-primary hover:text-white hover:border-primary transition-colors text-sm sm:text-base font-bold" onclick="insertChar('ɛ')">ɛ</button>
                            <button class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 rounded-lg bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm hover:bg-primary hover:text-white hover:border-primary transition-colors text-sm sm:text-base font-bold" onclick="insertChar('ɣ')">ɣ</button>
                            <button class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 rounded-lg bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm hover:bg-primary hover:text-white hover:border-primary transition-colors text-sm sm:text-base font-bold" onclick="insertChar('ḥ')">ḥ</button>
                            <button class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 rounded-lg bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm hover:bg-primary hover:text-white hover:border-primary transition-colors text-sm sm:text-base font-bold" onclick="insertChar('ḍ')">ḍ</button>
                            <button class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 rounded-lg bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm hover:bg-primary hover:text-white hover:border-primary transition-colors text-sm sm:text-base font-bold" onclick="insertChar('ṛ')">ṛ</button>
                            <button class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 rounded-lg bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm hover:bg-primary hover:text-white hover:border-primary transition-colors text-sm sm:text-base font-bold" onclick="insertChar('ṣ')">ṣ</button>
                            <button class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 rounded-lg bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm hover:bg-primary hover:text-white hover:border-primary transition-colors text-sm sm:text-base font-bold" onclick="insertChar('ṭ')">ṭ</button>
                            <button class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 rounded-lg bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm hover:bg-primary hover:text-white hover:border-primary transition-colors text-sm sm:text-base font-bold" onclick="insertChar('ẓ')">ẓ</button>
                            <button class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 rounded-lg bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm hover:bg-primary hover:text-white hover:border-primary transition-colors text-sm sm:text-base font-bold" onclick="insertChar('č')">č</button>
                            <button class="flex-shrink-0 w-8 h-8 sm:w-10 sm:h-10 rounded-lg bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-sm hover:bg-primary hover:text-white hover:border-primary transition-colors text-sm sm:text-base font-bold" onclick="insertChar('ǧ')">ǧ</button>
                        </div>

                        <div class="flex flex-col sm:flex-row gap-3">
                            <div class="relative flex-grow group">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400 group-focus-within:text-primary transition-colors">
                                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                                </div>
                                <input type="text" id="search-input" placeholder="Rechercher (mot, thème...)" class="w-full pl-10 pr-10 py-3 bg-white/70 dark:bg-gray-900/60 border border-gray-200 dark:border-gray-700 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all placeholder-gray-400 text-gray-800 dark:text-gray-100 backdrop-blur-sm">
                                <button class="clear-search-btn absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 opacity-0 pointer-events-none transition-opacity">
                                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </div>
                            <button id="random-btn" class="flex-shrink-0 bg-accent hover:bg-yellow-600 text-white px-5 py-3 rounded-xl font-semibold shadow-lg shadow-accent/20 transition-all active:scale-95 flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>
                                <span class="hidden sm:inline">Aléatoire</span>
                            </button>
                        </div>
                        
                        <!-- Tags Container -->
                        <div class="mt-4 flex items-center gap-2 overflow-x-auto custom-scrollbar pb-1" id="theme-list-container">
                            <!-- Populated via JS -->
                        </div>
                    </div>
                </div>

                <div id="results-feedback" class="h-6 mb-4 text-sm text-center text-gray-500 font-medium"></div>

                <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 auto-rows-min">
                    <!-- Empty State -->
                    <div id="initial-load-message" class="md:col-span-2 xl:col-span-3 py-20 flex flex-col items-center justify-center text-gray-400">
                        <svg class="w-16 h-16 mb-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                        <p class="text-lg">Commencez à explorer la sagesse...</p>
                    </div>
                </div>
                
                <p id="no-results" class="hidden text-center py-12 text-gray-500">Aucun proverbe trouvé.</p>

                <div id="infinite-scroll-loader" class="hidden py-8 text-center">
                    <span class="loader text-primary"></span>
                </div>
            </section>

            <!-- FAVORIS TAB -->
            <section id="favoris-tab" class="tab-content">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-3xl font-serif font-bold text-gray-800 dark:text-white">Mes Favoris</h2>
                    <span class="bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide">Collection</span>
                </div>
                <div id="favorites-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                <div id="no-favorites" class="hidden flex flex-col items-center justify-center py-20 text-gray-400">
                    <svg class="w-16 h-16 mb-4 text-gray-300 dark:text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
                    <p class="text-lg mb-4">Votre collection est vide.</p>
                    <button id="go-to-explorer-btn" class="bg-primary text-white px-6 py-2 rounded-xl shadow-lg hover:bg-secondary transition-colors">Explorer maintenant</button>
                </div>
            </section>

            <!-- AI SAGE TAB -->
            <section id="ai-sage-tab" class="tab-content">
                <div class="max-w-3xl mx-auto">
                    <div class="text-center mb-8">
                        <div class="inline-block p-3 rounded-full bg-gradient-to-br from-primary to-secondary text-white shadow-lg mb-4">
                            <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>
                        </div>
                        <h2 class="text-3xl font-serif font-bold text-gray-800 dark:text-white">Le Sage Artificiel</h2>
                        <p class="text-gray-500 mt-2">Décrivez une situation, le sage trouvera le proverbe parfait.</p>
                    </div>

                    <div class="glass-card p-6 rounded-2xl shadow-xl">
                        <textarea id="ai-context-input" rows="4" class="w-full bg-gray-50 dark:bg-darkbg border border-gray-200 dark:border-gray-700 rounded-xl p-4 text-gray-800 dark:text-gray-200 focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all resize-none mb-4" placeholder="Ex: Mon frère veut se lancer dans un grand projet sans avoir d'argent..."></textarea>
                        
                        <div class="flex justify-end">
                            <button id="ai-suggest-btn" class="bg-gradient-to-r from-primary to-secondary text-white px-8 py-3 rounded-xl font-bold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                                <span>Demander Conseil</span>
                            </button>
                        </div>

                        <div id="ai-step-feedback" class="mt-4 text-xs text-center text-primary font-medium min-h-[20px]"></div>
                    </div>

                    <div id="ai-result-feedback" class="mt-8 space-y-6"></div>
                </div>
            </section>

             <!-- QUIZ TAB -->
            <section id="quiz-tab" class="tab-content">
                <div class="max-w-2xl mx-auto">
                    <div class="text-center mb-8">
                         <h2 class="text-3xl font-serif font-bold text-gray-800 dark:text-white">Quiz de Sagesse</h2>
                         <p class="text-gray-500 mt-2">Testez vos connaissances sur la culture kabyle.</p>
                    </div>
                    
                    <div id="quiz-container" class="glass-card p-6 sm:p-8 rounded-2xl shadow-xl border-t-4 border-accent min-h-[400px] flex flex-col justify-center">
                        <div class="text-center py-10">
                            <span class="loader text-primary"></span>
                            <p class="mt-4 text-gray-500">Préparation du dojo...</p>
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- Mobile Dock Navigation -->
    <nav class="fixed bottom-0 left-0 w-full p-4 z-50 sm:hidden nav-dock pointer-events-none">
        <div class="pointer-events-auto max-w-sm mx-auto bg-white/90 dark:bg-gray-800/90 backdrop-blur-xl border border-white/20 dark:border-gray-700 shadow-2xl rounded-2xl flex justify-around items-center px-2 py-3">
            <button data-tab="accueil-tab" class="nav-btn mobile nav-item relative w-12 h-12 flex flex-col items-center justify-center text-gray-400 active">
                <svg class="w-6 h-6 mb-0.5 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
            </button>
            <button data-tab="explorer-tab" class="nav-btn mobile nav-item relative w-12 h-12 flex flex-col items-center justify-center text-gray-400">
                <svg class="w-6 h-6 mb-0.5 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
            </button>
            <button data-tab="favoris-tab" class="nav-btn mobile nav-item relative w-12 h-12 flex flex-col items-center justify-center text-gray-400">
                <svg class="w-6 h-6 mb-0.5 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
            </button>
            <button data-tab="ai-sage-tab" class="nav-btn mobile nav-item relative w-12 h-12 flex flex-col items-center justify-center text-gray-400">
                <svg class="w-6 h-6 mb-0.5 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg>
            </button>
             <button data-tab="quiz-tab" class="nav-btn mobile nav-item relative w-12 h-12 flex flex-col items-center justify-center text-gray-400">
                <svg class="w-6 h-6 mb-0.5 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
            </button>
        </div>
    </nav>
    
    <!-- UI Components -->
    <div id="toast" class="fixed top-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full bg-gray-900/90 dark:bg-white/90 text-white dark:text-gray-900 shadow-2xl z-[100] transition-all duration-300 opacity-0 -translate-y-10 flex items-center gap-2 font-medium backdrop-blur-md">
        <span>Message</span>
    </div>

    <button id="back-to-top" class="fixed bottom-24 right-5 sm:bottom-10 sm:right-10 w-12 h-12 bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 rounded-full shadow-lg flex items-center justify-center transition-all opacity-0 translate-y-10 z-40 hover:bg-primary hover:text-white dark:hover:bg-primary dark:hover:text-white border border-gray-100 dark:border-gray-700">
        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg>
    </button>
    
    <!-- Modal -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <div id="modal-content" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-xl max-h-[85vh] bg-paper dark:bg-darkcard rounded-2xl shadow-2xl z-[101] opacity-0 scale-95 pointer-events-none transition-all duration-300 flex flex-col border border-white/20">
        <header class="flex-shrink-0 p-5 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-white/50 dark:bg-black/20 rounded-t-2xl">
            <h2 id="modal-title" class="text-xl font-serif font-bold text-gray-800 dark:text-white truncate pr-4"></h2>
            <button id="modal-close-btn" class="text-gray-400 hover:text-red-500 transition-colors bg-gray-100 dark:bg-gray-800 p-1.5 rounded-full">
                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </header>
        <div id="modal-body" class="p-6 overflow-y-auto custom-scrollbar text-gray-700 dark:text-gray-300 leading-relaxed"></div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- Config & Utils ---
        const PROVERBS_PER_PAGE = 30; // Reduced slightly for performance
        const API_KEY = "AIzaSyAKpc-aRVkt_rfm96ApWJnL244C-L6mZj4"; // Your existing key

        const dom = {
            html: document.documentElement,
            splashScreen: document.getElementById('splash-screen'),
            searchInput: document.getElementById('search-input'),
            clearSearchBtn: document.querySelector('.clear-search-btn'),
            resultsContainer: document.getElementById('results-container'),
            resultsFeedback: document.getElementById('results-feedback'),
            initialLoadMessage: document.getElementById('initial-load-message'),
            loaderContainer: document.getElementById('infinite-scroll-loader'),
            favoritesContainer: document.getElementById('favorites-container'),
            noResults: document.getElementById('no-results'),
            noFavorites: document.getElementById('no-favorites'),
            goToExplorerBtn: document.getElementById('go-to-explorer-btn'),
            toast: document.getElementById('toast'),
            proverbOfTheDayCard: document.getElementById('proverb-of-the-day-card'),
            proverbCount: document.getElementById('proverb-count'),
            randomBtn: document.getElementById('random-btn'),
            backToTopBtn: document.getElementById('back-to-top'),
            themeListContainer: document.getElementById('theme-list-container'),
            navButtons: document.querySelectorAll('.nav-btn'),
            tabContents: document.querySelectorAll('.tab-content'),
            quizContainer: document.getElementById('quiz-container'),
            themeToggle: document.getElementById('theme-toggle'),
            themeIcons: { light: document.getElementById('theme-icon-light'), dark: document.getElementById('theme-icon-dark') },
            modal: { backdrop: document.getElementById('modal-backdrop'), content: document.getElementById('modal-content'), title: document.getElementById('modal-title'), body: document.getElementById('modal-body'), closeBtn: document.getElementById('modal-close-btn') },
            ai: { contextInput: document.getElementById('ai-context-input'), suggestBtn: document.getElementById('ai-suggest-btn'), stepFeedback: document.getElementById('ai-step-feedback'), resultFeedback: document.getElementById('ai-result-feedback') }
        };

        const state = {
            activeTheme: 'tous',
            searchTimeout: null,
            proverbs: [],
            favorites: new Set(JSON.parse(localStorage.getItem('inzan_favorites')) || []),
            displayedProverbs: [],
            currentPage: 0,
            isLoading: false,
            isCoreDataLoaded: false,
            totalFilteredCount: 0,
            aiQuiz: { questions: [], currentQuestionIndex: 0, score: 0, isLoading: false, preloadPromise: null }
        };

        // --- Helper Functions ---
        const normalizeText = (text) => {
            if (!text) return '';
            return text.toLowerCase().trim()
                .replace(/ɣ/g, "gh").replace(/č/g, "tch").replace(/ǧ/g, "dj").replace(/ɛ/g, "3")
                .replace(/xx/g, "kh").replace(/tt/g, "ts").replace(/ṣ/g, "s").replace(/ṭ/g, "t")
                .replace(/ẓ/g, "z").replace(/ḍ/g, "d").replace(/ḥ/g, "h")
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9\s]/g, '');
        };

        const showToast = (message, type = 'success') => {
            const toast = dom.toast;
            toast.querySelector('span').textContent = message;
            // Style adjustment based on type
            if(type === 'error') toast.className = toast.className.replace('bg-gray-900/90', 'bg-red-600/90');
            else toast.className = toast.className.replace('bg-red-600/90', 'bg-gray-900/90');
            
            toast.classList.remove('opacity-0', '-translate-y-10');
            setTimeout(() => toast.classList.add('opacity-0', '-translate-y-10'), 3000);
        };

        const highlightText = (text, query) => {
            if (!query || !text) return text;
            const normalizedQuery = normalizeText(query);
            if (!normalizedQuery) return text;
            const keywords = normalizedQuery.split(' ').filter(k => k.length > 0);
            if (!keywords.length) return text;
            const regex = new RegExp(`(${keywords.join('|')})`, 'gi'); // Simplified highlight logic for demo
            return text; // Highlighting complex Berber chars is tricky, returning plain for stability
        };

        window.insertChar = (char) => {
            const input = dom.searchInput;
            const start = input.selectionStart;
            input.value = input.value.substring(0, start) + char + input.value.substring(input.selectionEnd);
            input.selectionStart = input.selectionEnd = start + 1;
            input.focus();
            loadNextChunk(true);
        };

        // --- Core UI Components ---
        const createProverbCardHTML = (proverb, isDaily = false) => {
            if (!proverb) return '';
            const themes = (proverb.theme || '').split(/[,/]/).map(t => t.trim()).filter(Boolean);
            const isFavorited = state.favorites.has(proverb.id);
            
            // Modern Card Layout
            return `
            <div class="glass-card rounded-2xl p-6 h-full flex flex-col relative group transition-all duration-300 border-l-4 border-transparent hover:border-primary" data-id="${proverb.id}">
                <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button class="copy-btn text-gray-400 hover:text-primary" title="Copier"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>
                </div>

                <div class="mb-4">
                    <div class="flex flex-wrap gap-2 mb-3">
                        ${themes.map(t => `<span class="px-2 py-0.5 rounded-md bg-gray-100 dark:bg-gray-700 text-[10px] font-bold uppercase tracking-wider text-gray-500 dark:text-gray-400 theme-trigger cursor-pointer hover:text-primary transition-colors" data-theme="${normalizeText(t)}">${t}</span>`).join('')}
                    </div>
                    <p class="proverb-text text-xl sm:text-2xl font-serif font-bold text-gray-800 dark:text-gray-100 mb-3 leading-snug">« ${proverb.kabyle} »</p>
                    <p class="text-gray-600 dark:text-gray-400 font-light italic text-base border-l-2 border-accent/30 pl-3"> ${proverb.francais}</p>
                </div>

                <div class="mt-auto pt-4 border-t border-gray-100 dark:border-gray-700 flex items-center justify-between">
                    <button class="explain-btn text-xs font-bold text-primary hover:text-secondary uppercase tracking-widest flex items-center gap-1 group/btn">
                        <span>Décrypter</span>
                        <svg class="w-4 h-4 transform group-hover/btn:rotate-12 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    </button>
                    
                    <div class="flex gap-1">
                        <button class="tts-btn p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-400 hover:text-gray-800 transition-colors" title="Écouter">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
                        </button>
                         <button class="image-btn p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-400 hover:text-gray-800 transition-colors" title="Créer Image">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        </button>
                        <button class="favorite-btn p-2 rounded-full hover:bg-red-50 dark:hover:bg-red-900/20 text-gray-400 hover:text-red-500 transition-colors ${isFavorited ? 'text-red-500' : ''}" title="Favoris">
                            <svg class="w-5 h-5 ${isFavorited ? 'fill-current' : ''}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
                        </button>
                    </div>
                </div>
            </div>`;
        };

        const renderChunk = (container, proverbs, append = true) => {
            const html = proverbs.map(p => {
                const wrapper = document.createElement('div');
                wrapper.innerHTML = createProverbCardHTML(p);
                // Simple fade in animation
                const el = wrapper.firstElementChild;
                el.style.animation = 'fadeInUp 0.5s ease-out forwards';
                return el.outerHTML;
            }).join('');
            
            if (append) container.insertAdjacentHTML('beforeend', html);
            else container.innerHTML = html;
        };

        // --- Logic: Search & Filtering ---
        const filterProverbs = () => {
            if (!state.isCoreDataLoaded) return [];
            const query = dom.searchInput.value.trim();
            const normalizedQuery = normalizeText(query);
            const keywords = normalizedQuery.split(' ').filter(k => k.length > 0);

            return state.proverbs.filter(p => {
                const themeMatch = state.activeTheme === 'tous' || (p.theme_norm || '').includes(state.activeTheme);
                if (!themeMatch) return false;
                if (!keywords.length) return true;
                const pText = `${p.kabyle_norm} ${p.francais_norm} ${p.theme_norm}`;
                return keywords.every(k => pText.includes(k));
            });
        };

        const loadNextChunk = (reset = false) => {
            if (state.isLoading || !state.isCoreDataLoaded) return;
            
            const isSearching = dom.searchInput.value.trim().length > 0 || state.activeTheme !== 'tous';
            
            if (reset) {
                state.currentPage = 0;
                state.displayedProverbs = [];
                dom.resultsContainer.innerHTML = '';
                state.totalFilteredCount = 0;
                window.scrollTo({ top: 0 }); // Better scroll reset
            }

            // UI States
            if (!isSearching && reset) {
                dom.initialLoadMessage.classList.remove('hidden');
                dom.noResults.classList.add('hidden');
                dom.resultsFeedback.textContent = '';
                return;
            }
            dom.initialLoadMessage.classList.add('hidden');

            state.isLoading = true;
            dom.loaderContainer.classList.remove('hidden');

            // Filtering logic
            const filtered = filterProverbs();
            state.totalFilteredCount = filtered.length;

            if (filtered.length === 0 && reset) {
                dom.noResults.classList.remove('hidden');
                dom.resultsFeedback.textContent = '';
                dom.loaderContainer.classList.add('hidden');
                state.isLoading = false;
                return;
            }
            dom.noResults.classList.add('hidden');

            const start = state.currentPage * PROVERBS_PER_PAGE;
            const chunk = filtered.slice(start, start + PROVERBS_PER_PAGE);
            
            if (chunk.length > 0) {
                renderChunk(dom.resultsContainer, chunk, true);
                state.displayedProverbs.push(...chunk);
                state.currentPage++;
                dom.resultsFeedback.textContent = `${state.displayedProverbs.length} / ${state.totalFilteredCount}`;
            }

            if (state.displayedProverbs.length >= state.totalFilteredCount) dom.loaderContainer.classList.add('hidden');
            state.isLoading = false;
        };

        // --- Logic: Themes ---
        const updateThemes = () => {
            if (!state.isCoreDataLoaded) return;
            const themes = [...new Set(state.proverbs.flatMap(p => (p.theme||'').split(/[,/]/).map(t => t.trim().toLowerCase())))].sort();
            
            let html = `<button class="theme-pill px-4 py-2 rounded-full text-sm font-semibold transition-all whitespace-nowrap border ${state.activeTheme === 'tous' ? 'bg-primary text-white border-primary' : 'bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 border-gray-200 dark:border-gray-700 hover:border-primary'}" data-theme="tous">Tous</button>`;
            
            themes.forEach(t => {
                if(!t) return;
                const norm = normalizeText(t);
                const isActive = state.activeTheme === norm;
                html += `<button class="theme-pill px-4 py-2 rounded-full text-sm font-semibold transition-all whitespace-nowrap border ${isActive ? 'bg-primary text-white border-primary' : 'bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 border-gray-200 dark:border-gray-700 hover:border-primary'}" data-theme="${norm}">${t.charAt(0).toUpperCase() + t.slice(1)}</button>`;
            });
            dom.themeListContainer.innerHTML = html;
        };

        // --- Logic: API (Gemini) ---
        const callGemini = async (text, systemInstruction, isJson = false) => {
             const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${API_KEY}`;
             const body = {
                 contents: [{ parts: [{ text }] }],
                 systemInstruction: { parts: [{ text: systemInstruction }] },
                 generationConfig: isJson ? { responseMimeType: "application/json" } : {}
             };
             
             try {
                 const res = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
                 if(!res.ok) throw new Error("API Error");
                 const data = await res.json();
                 const resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                 if(!resultText) throw new Error("No Text");
                 return isJson ? JSON.parse(resultText) : resultText;
             } catch(e) { throw e; }
        };

        const explainProverb = async (proverb) => {
            const modalBody = dom.modal.body;
            dom.modal.title.textContent = "Décryptage du Sage";
            modalBody.innerHTML = `<div class="flex flex-col items-center py-8"><span class="loader text-primary"></span><p class="mt-4 text-sm text-gray-500">Consultation des archives...</p></div>`;
            dom.modal.backdrop.classList.remove('opacity-0', 'pointer-events-none');
            dom.modal.content.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
            
            try {
                const prompt = `Explique ce proverbe kabyle : "${proverb.kabyle}" ("${proverb.francais}"). Structure: ### Signification, ### Contexte d'usage. Markdown.`;
                const response = await callGemini(prompt, "Tu es un expert culturel Kabyle. Sois concis et pédagogue.");
                
                // Simple Markdown parser
                let html = response
                    .replace(/^### (.*$)/gim, '<h3 class="text-lg font-bold text-primary mt-4 mb-2">$1</h3>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n/g, '<br>');
                    
                modalBody.innerHTML = html;
            } catch (e) {
                modalBody.innerHTML = `<p class="text-red-500 text-center">Le sage est momentanément indisponible.</p>`;
            }
        };

        // --- Logic: AI Suggestion ---
        dom.ai.suggestBtn.addEventListener('click', async () => {
            const ctx = dom.ai.contextInput.value.trim();
            if(!ctx) return showToast("Décrivez une situation d'abord", 'error');
            
            const btn = dom.ai.suggestBtn;
            const originalContent = btn.innerHTML;
            btn.innerHTML = `<span class="loader text-white w-5 h-5"></span>`;
            btn.disabled = true;
            dom.ai.resultFeedback.innerHTML = '';
            
            try {
                // Step 1: Keywords
                dom.ai.stepFeedback.textContent = "Analyse sémantique...";
                const keyRes = await callGemini(`Situation: "${ctx}". Donne 5 mots-clés français pour trouver un proverbe.`, 'JSON: { "keywords": ["k1", "k2"] }', true);
                
                // Local Filter
                const keywords = keyRes.keywords.map(normalizeText);
                let candidates = state.proverbs.filter(p => keywords.some(k => (p.francais_norm + ' ' + p.theme_norm).includes(k))).slice(0, 20);
                
                if(!candidates.length) candidates = state.proverbs.sort(()=>0.5-Math.random()).slice(0, 20); // Fallback

                // Step 2: Selection
                dom.ai.stepFeedback.textContent = "Sélection du meilleur proverbe...";
                const selectionPrompt = `Situation: "${ctx}". Liste: ${JSON.stringify(candidates.map(p=>({id:p.id, txt:p.francais})))}. Choisis le meilleur. JSON: { "id": 123, "reason": "Pourquoi..." }`;
                const finalRes = await callGemini(selectionPrompt, "Expert proverbes.", true);
                
                const bestProverb = state.proverbs.find(p => p.id === finalRes.id);
                
                if(bestProverb) {
                    dom.ai.resultFeedback.innerHTML = `
                        <div class="bg-primary/5 border border-primary/20 rounded-xl p-4 mb-4">
                            <p class="text-sm italic text-gray-600 dark:text-gray-300">"${finalRes.reason}"</p>
                        </div>
                        ${createProverbCardHTML(bestProverb)}
                    `;
                } else {
                     dom.ai.resultFeedback.innerHTML = `<p class="text-center text-gray-500">Aucune correspondance évidente trouvée.</p>`;
                }

            } catch(e) {
                showToast("Erreur de connexion AI", 'error');
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
                dom.ai.stepFeedback.textContent = "";
            }
        });

        // --- Feature: Image Gen (Canvas) ---
        const generateSocialImage = (proverb) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 1080; canvas.height = 1080;
            
            // Background Gradient
            const grad = ctx.createLinearGradient(0,0, 1080, 1080);
            grad.addColorStop(0, '#F9F7F3'); grad.addColorStop(1, '#EFECE4');
            ctx.fillStyle = grad; ctx.fillRect(0,0,1080,1080);
            
            // Design Elements
            ctx.fillStyle = '#4A7C59';
            ctx.fillRect(100, 100, 880, 880); // Border frame
            ctx.clearRect(120, 120, 840, 840); // Inner cut
            
            // Text
            ctx.fillStyle = '#2F4F4F';
            ctx.textAlign = 'center';
            
            // Symbol
            ctx.font = '120px sans-serif';
            ctx.fillStyle = '#C79A2A';
            ctx.fillText("ⵣ", 540, 280);
            
            // Kabyle
            ctx.font = 'bold italic 60px serif';
            ctx.fillStyle = '#1a202c';
            const words = `« ${proverb.kabyle} »`.split(' ');
            let line = '', y = 450;
            for(let n = 0; n < words.length; n++) {
                let testLine = line + words[n] + ' ';
                if (ctx.measureText(testLine).width > 700 && n > 0) { ctx.fillText(line, 540, y); line = words[n] + ' '; y += 70; }
                else { line = testLine; }
            }
            ctx.fillText(line, 540, y);
            
            // French
            y += 80;
            ctx.beginPath(); ctx.moveTo(440, y); ctx.lineTo(640, y); ctx.strokeStyle='#C79A2A'; ctx.lineWidth=4; ctx.stroke();
            y += 80;
            ctx.font = '40px sans-serif';
            ctx.fillStyle = '#4B5563';
            const fWords = proverb.francais.split(' ');
            line = '';
            for(let n = 0; n < fWords.length; n++) {
                let testLine = line + fWords[n] + ' ';
                if (ctx.measureText(testLine).width > 700 && n > 0) { ctx.fillText(line, 540, y); line = fWords[n] + ' '; y += 50; }
                else { line = testLine; }
            }
            ctx.fillText(line, 540, y);

            // Branding
            ctx.font = 'bold 30px sans-serif';
            ctx.fillStyle = '#4A7C59';
            ctx.fillText("INZAN N TEQBAYLIT", 540, 950);

            // Download
            const link = document.createElement('a');
            link.download = `Inzan-${proverb.id}.png`;
            link.href = canvas.toDataURL();
            link.click();
        };

        // --- Logic: Text to Speech (Optimized) ---
        const speak = (text) => {
            if(!window.speechSynthesis) return showToast("Audio non supporté", 'error');
            window.speechSynthesis.cancel();
            
            // Kabyle phonetic tweaks for French engine
            const phonetic = text.toLowerCase()
                .replace(/ɣ/g, "gh").replace(/x/g, "kh").replace(/č/g, "tch")
                .replace(/ɛ/g, "âa").replace(/ḥ/g, "hhh").replace(/u/g, "ou")
                .replace(/w/g, "oua");
                
            const u = new SpeechSynthesisUtterance(phonetic);
            u.lang = 'fr-FR'; // Fallback
            u.rate = 0.9;
            window.speechSynthesis.speak(u);
        };

        // --- Event Listeners ---
        const setupEvents = () => {
            // Tabs
            dom.navButtons.forEach(btn => btn.addEventListener('click', (e) => {
                const target = e.currentTarget.dataset.tab;
                dom.tabContents.forEach(tc => tc.classList.remove('active'));
                document.getElementById(target).classList.add('active');
                
                dom.navButtons.forEach(b => b.classList.remove('active'));
                document.querySelectorAll(`[data-tab="${target}"]`).forEach(b => b.classList.add('active'));
                
                if(target === 'favoris-tab') renderFavorites();
                window.scrollTo({top:0, behavior:'smooth'});
            }));

            // Search & Themes
            dom.searchInput.addEventListener('input', () => {
                dom.clearSearchBtn.style.opacity = dom.searchInput.value ? '1' : '0';
                dom.clearSearchBtn.style.pointerEvents = dom.searchInput.value ? 'auto' : 'none';
                clearTimeout(state.searchTimeout);
                state.searchTimeout = setTimeout(()=>loadNextChunk(true), 300);
            });
            dom.clearSearchBtn.addEventListener('click', () => {
                dom.searchInput.value = '';
                loadNextChunk(true);
            });
            dom.themeListContainer.addEventListener('click', (e) => {
                if(e.target.classList.contains('theme-pill')) {
                    state.activeTheme = e.target.dataset.theme;
                    updateThemes();
                    if(document.getElementById('explorer-tab').classList.contains('active')) loadNextChunk(true);
                }
            });

            // Card Actions (Delegation)
            document.body.addEventListener('click', (e) => {
                const card = e.target.closest('[data-id]');
                if(!card) return;
                const id = parseInt(card.dataset.id);
                const p = state.proverbs.find(x => x.id === id);
                if(!p) return;

                if(e.target.closest('.favorite-btn')) {
                    if(state.favorites.has(id)) { state.favorites.delete(id); showToast("Retiré des favoris", 'error'); }
                    else { state.favorites.add(id); showToast("Ajouté aux favoris"); }
                    localStorage.setItem('inzan_favorites', JSON.stringify([...state.favorites]));
                    // Re-render button state only
                    const btn = e.target.closest('.favorite-btn');
                    btn.classList.toggle('text-red-500');
                    btn.querySelector('svg').classList.toggle('fill-current');
                    if(document.getElementById('favoris-tab').classList.contains('active')) renderFavorites();
                }
                if(e.target.closest('.copy-btn')) {
                    navigator.clipboard.writeText(`${p.kabyle}\n${p.francais}`);
                    showToast("Copié !");
                }
                if(e.target.closest('.tts-btn')) speak(p.kabyle);
                if(e.target.closest('.image-btn')) generateSocialImage(p);
                if(e.target.closest('.explain-btn')) explainProverb(p);
                
                // Theme tags inside cards
                if(e.target.classList.contains('theme-trigger')) {
                    e.stopPropagation();
                    state.activeTheme = e.target.dataset.theme;
                    document.querySelector('[data-tab="explorer-tab"]').click();
                    updateThemes();
                    loadNextChunk(true);
                }
            });

            // Random
            dom.randomBtn.addEventListener('click', () => {
                state.activeTheme = 'tous';
                dom.searchInput.value = '';
                updateThemes();
                state.proverbs.sort(() => 0.5 - Math.random()); // Shuffle global
                loadNextChunk(true);
            });

            // Modal
            dom.modal.closeBtn.addEventListener('click', () => {
                dom.modal.backdrop.classList.add('opacity-0', 'pointer-events-none');
                dom.modal.content.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
            });

            // Theme Toggle
            dom.themeToggle.addEventListener('click', () => {
                dom.html.classList.toggle('dark');
                const isDark = dom.html.classList.contains('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                dom.themeIcons.light.classList.toggle('hidden', isDark);
                dom.themeIcons.dark.classList.toggle('hidden', !isDark);
            });

            // Infinite Scroll
            const observer = new IntersectionObserver((entries) => {
                if(entries[0].isIntersecting) loadNextChunk();
            }, {threshold: 0.1});
            observer.observe(dom.loaderContainer);
            
            // Back to top
            window.addEventListener('scroll', () => {
                if(window.scrollY > 300) {
                    dom.backToTopBtn.classList.remove('opacity-0', 'translate-y-10');
                } else {
                    dom.backToTopBtn.classList.add('opacity-0', 'translate-y-10');
                }
            });
            dom.backToTopBtn.addEventListener('click', () => window.scrollTo({top:0, behavior:'smooth'}));
        };

        const renderFavorites = () => {
            dom.favoritesContainer.innerHTML = '';
            const favs = state.proverbs.filter(p => state.favorites.has(p.id));
            if(favs.length === 0) dom.noFavorites.classList.remove('hidden');
            else {
                dom.noFavorites.classList.add('hidden');
                renderChunk(dom.favoritesContainer, favs);
            }
        };

        // --- Init ---
        const init = async () => {
            // Theme Init
            if(localStorage.getItem('theme') === 'dark') {
                dom.html.classList.add('dark');
                dom.themeIcons.light.classList.add('hidden');
                dom.themeIcons.dark.classList.remove('hidden');
            }

            try {
                const res = await fetch('proverbs.json');
                const data = await res.json();
                state.proverbs = data.map((p,i) => ({
                    ...p, id: i,
                    kabyle_norm: normalizeText(p.kabyle),
                    francais_norm: normalizeText(p.francais),
                    theme_norm: normalizeText(p.theme)
                }));
                state.isCoreDataLoaded = true;
                
                dom.proverbCount.innerText = state.proverbs.length;
                updateThemes();

                // Daily Proverb
                const seed = Math.floor(new Date() / 86400000); // Days since epoch
                const daily = state.proverbs[seed % state.proverbs.length];
                dom.proverbOfTheDayCard.innerHTML = createProverbCardHTML(daily, true);

                setupEvents();
                dom.splashScreen.classList.add('hidden'); // Reveal app

            } catch (e) {
                dom.splashScreen.innerHTML = `<p class="text-red-500">Erreur de chargement: ${e.message}</p>`;
            }
        };

        init();
    });
    </script>
</body>
</html>

