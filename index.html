<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="D√©couvrez et explorez des milliers de proverbes kabyles (Inzan). Une collection interactive de la sagesse populaire de Kabylie avec des explications, des favoris et des suggestions par IA.">
    
    <!-- M√©ta-donn√©es PWA et Partage Social -->
    <meta name="theme-color" content="#F9F7F3">
    
    <meta property="og:title" content="Inzan n Teqbaylit - Tr√©sors de la Sagesse Kabyle">
    <meta property="og:description" content="Explorez des milliers de proverbes kabyles (Inzan) avec explications et suggestions par IA.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://votre-url-ici.com">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Inzan n Teqbaylit - Tr√©sors de la Sagesse Kabyle">
    <meta name="twitter:description" content="Explorez des milliers de proverbes kabyles (Inzan) avec explications et suggestions par IA.">

    <link rel="manifest" href="data:application/json,{
        &quot;name&quot;: &quot;Inzan n Teqbaylit&quot;,
        &quot;short_name&quot;: &quot;Inzan&quot;,
        &quot;start_url&quot;: &quot;.&quot;,
        &quot;display&quot;: &quot;standalone&quot;,
        &quot;background_color&quot;: &quot;#F9F7F3&quot;,
        &quot;theme_color&quot;: &quot;#4A7C59&quot;,
        &quot;description&quot;: &quot;Tr√©sors de la Sagesse Kabyle&quot;,
        &quot;icons&quot;: [
            { &quot;src&quot;: &quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%23F9F7F3'%3E%3C/rect%3E%3Ctext y='.9em' font-size='90' fill='%234A7C59'%3E%E2%9C%A7%3C/text%3E%3C/svg%3E&quot;, &quot;sizes&quot;: &quot;192x192&quot;, &quot;type&quot;: &quot;image/svg+xml&quot; },
            { &quot;src&quot;: &quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%23F9F7F3'%3E%3C/rect%3E%3Ctext y='.9em' font-size='90' fill='%234A7C59'%3E%E2%9C%A7%3C/text%3E%3C/svg%3E&quot;, &quot;sizes&quot;: &quot;512x512&quot;, &quot;type&quot;: &quot;image/svg+xml&quot; }
        ]
    }">

    <title>Inzan n Teqbaylit - Tr√©sors de la Sagesse Kabyle</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tinos:ital,wght@0,400;0,700;1,400&family=Raleway:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Ctext y=%22.9em%22 font-size=%2290%22 fill=%22%234A7C59%22%3E%E2%9C%A7%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Crect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%23F9F7F3%22%3E%3C/rect%3E%3Ctext y=%22.9em%22 font-size=%2290%22 fill=%22%234A7C59%22%3E%E2%9C%A7%3C/text%3E%3C/svg%3E">

    <style>
        :root {
            --color-bg: #F9F7F3;
            --color-bg-card: #FFFFFF;
            --color-bg-alt: #F0EFEA;
            --color-text: #3D4A3A;
            --color-text-light: #6B7280;
            --color-heading: #2F4F4F;
            --color-primary: #4A7C59;
            --color-secondary: #3A644B;
            --color-accent: #C79A2A;
            --color-border: #E5E7EB;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.04);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.08), 0 2px 4px -2px rgb(0 0 0 / 0.08);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --font-serif: 'Tinos', serif;
            --font-sans: 'Raleway', sans-serif;
        }

        html.dark {
            --color-bg: #101418;
            --color-bg-card: #1A2026;
            --color-bg-alt: #1F272E;
            --color-text: #D1D5DB;
            --color-text-light: #9CA3AF;
            --color-heading: #F9FAFB;
            --color-primary: #52B788;
            --color-secondary: #3E9469;
            --color-accent: #FBBF24;
            --color-border: #374151;
            --shadow-sm: 0 1px 2px 0 rgb(255 255 255 / 0.04);
            --shadow-md: 0 4px 6px -1px rgb(255 255 255 / 0.05), 0 2px 4px -2px rgb(255 255 255 / 0.05);
            --shadow-lg: 0 10px 15px -3px rgb(255 255 255 / 0.05), 0 4px 6px -4px rgb(255 255 255 / 0.05);
        }
        
        html.dark {
            --theme-color-dark: #101418;
            meta[name="theme-color"] {
                content: var(--theme-color-dark);
            }
        }

        body {
            background-color: var(--color-bg);
            font-family: var(--font-sans);
            color: var(--color-text);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%239C92AC' fill-opacity='0.03'%3E%3Cpath d='M0 38.59l2.83-2.83 1.41 1.41L1.41 40H0v-1.41zM0 1.4l2.83 2.83 1.41-1.41L1.41 0H0v1.41zM38.59 40l-2.83-2.83 1.41-1.41L40 38.59V40h-1.41zM40 1.41l-2.83 2.83-1.41-1.41L38.59 0H40v1.41zM20 18.6l2.83-2.83 1.41 1.41L21.41 20l2.83 2.83-1.41 1.41L20 21.41l-2.83 2.83-1.41-1.41L18.59 20l-2.83-2.83 1.41-1.41L20 18.59z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .action-btn, .theme-pill-button, .card-theme-badge, .nav-btn, #back-to-top, .char-btn, #lang-toggle {
            transition: background-color 0.25s cubic-bezier(0.4, 0, 0.2, 1),
                        color 0.25s cubic-bezier(0.4, 0, 0.2, 1),
                        transform 0.25s cubic-bezier(0.4, 0, 0.2, 1),
                        box-shadow 0.25s cubic-bezier(0.4, 0, 0.2, 1),
                        border-color 0.25s cubic-bezier(0.4, 0, 0.2, 1),
                        opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .theme-pill-button.active {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
            background-color: var(--color-primary);
            color: white !important;
        }
        .card-theme-badge:hover {
            background-color: var(--color-accent);
            color: var(--color-secondary);
            transform: scale(1.05);
        }
        .search-highlight {
            background-color: var(--color-accent);
            padding: 1px 4px;
            border-radius: 4px;
            color: var(--color-bg-card);
            font-weight: 700;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .fade-in {
            animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        .stagger-in {
            animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) both;
        }
        
        .tab-content { display: none; }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s ease-in-out;
        }

        #toast {
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        #back-to-top.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .loader {
            width: 20px;
            height: 20px;
            border: 3px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        .loader-dark {
            border-color: #666;
            border-bottom-color: transparent;
        }
        html.dark .loader-dark {
            border-color: #9CA3AF;
            border-bottom-color: transparent;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .custom-scrollbar::-webkit-scrollbar { height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        html.dark .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #4B5563; }

        .nav-btn.active.mobile {
            color: var(--color-primary);
            transform: translateY(-4px) scale(1.1);
            background-color: var(--color-bg);
            border-radius: 50%;
        }
        .nav-btn.active.desktop {
            color: var(--color-primary);
            border-color: var(--color-primary);
            background-color: color-mix(in srgb, var(--color-primary) 10%, transparent);
        }

        #modal-backdrop.visible {
            opacity: 1;
            pointer-events: auto;
        }
        #modal-content.visible {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: auto;
        }
        #modal-body {
            -webkit-overflow-scrolling: touch;
        }

        .prose h3 {
            margin-top: 1.5em;
            margin-bottom: 0.6em;
            font-size: 1.2em;
            font-weight: bold;
            color: var(--color-primary);
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 0.3em;
        }
        .prose p, .prose ul {
            margin-bottom: 1em;
            line-height: 1.6;
        }
        .prose ul {
            list-style-position: inside;
            padding-left: 1em;
        }
        .prose li {
            margin-bottom: 0.5em;
        }
        
        .favorite-btn.favorited svg {
            fill: #EC4899;
            stroke: #EC4899;
            color: #EC4899;
            transform: scale(1.1);
        }
        
        .quiz-option {
            border: 2px solid var(--color-border);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .quiz-option:hover {
            border-color: var(--color-primary);
            background-color: color-mix(in srgb, var(--color-primary) 10%, transparent);
        }
        .quiz-option.correct {
            border-color: #10B981;
            background-color: #D1FAE5;
            color: #064E3B;
            font-weight: bold;
            transform: scale(1.02);
        }
        html.dark .quiz-option.correct {
            background-color: #064E3B;
            color: #D1FAE5;
        }
        .quiz-option.incorrect {
            border-color: #EF4444;
            background-color: #FEE2E2;
            color: #991B1B;
            font-weight: bold;
        }
        html.dark .quiz-option.incorrect {
            background-color: #991B1B;
            color: #FEE2E2;
        }
        .quiz-option[disabled] {
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .search-wrapper {
            position: relative;
        }
        .clear-search-btn {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-light);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }
        .search-wrapper input:not(:placeholder-shown) + .clear-search-btn {
            opacity: 1;
            pointer-events: auto;
            cursor: pointer;
        }

        :focus-visible {
            outline: 3px solid var(--color-accent);
            outline-offset: 2px;
            border-radius: 0.375rem;
        }
        #modal-content :focus-visible {
             border-radius: 0.125rem;
        }
        
        #splash-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        #splash-logo {
            animation: zoomIn 1s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        /* Nouveaux styles pour le clavier virtuel */
        .char-btn {
            font-family: 'Tinos', serif;
            font-weight: bold;
            border: 1px solid var(--color-border);
            background-color: var(--color-bg-alt);
            color: var(--color-text);
        }
        .char-btn:hover {
            background-color: var(--color-primary);
            color: white;
            transform: scale(1.1);
        }
        .char-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8 pb-32 sm:pb-8">

    <div id="splash-screen" class="fixed inset-0 bg-[var(--color-bg)] z-[200] flex flex-col items-center justify-center transition-opacity duration-700 ease-out">
        <div id="splash-logo" class="opacity-0">
            <svg width="100" height="100" viewBox="0 0 100 100" class="text-[var(--color-accent)]" aria-hidden="true">
                <text x="50" y="85" font-size="90" text-anchor="middle" fill="currentColor">‚µ£</text>
            </svg>
        </div>
        <p class="text-2xl font-serif font-bold text-[var(--color-heading)] mt-4">Inzan n Teqbaylit</p>
    </div>

    <div class="max-w-7xl mx-auto">
        <header class="relative text-center mb-8 md:mb-12">
            <div class="absolute top-0 right-0 z-50 flex gap-2">
                <!-- NOUVEAU: Bouton de langue -->
                <button id="lang-toggle" aria-label="Changer de langue" class="p-2 rounded-full bg-[var(--color-bg-card)] text-[var(--color-text)] shadow-md hover:scale-110 transition-transform font-bold text-sm w-10 h-10 flex items-center justify-center border border-[var(--color-border)]">
                    <span id="current-lang-text">‚µù</span>
                </button>
                <button id="theme-toggle" aria-label="Changer de th√®me" class="p-2 rounded-full bg-[var(--color-bg-card)] text-[var(--color-text)] shadow-md hover:scale-110 transition-transform border border-[var(--color-border)]">
                    <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                    <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                </button>
            </div>
            <h1 class="text-4xl md:text-6xl font-serif font-bold text-[var(--color-heading)] mb-2 flex flex-col sm:flex-row justify-center items-center gap-2 sm:gap-4 pt-4">
                <svg aria-hidden="true" width="40" height="40" viewBox="0 0 100 100" class="text-[var(--color-accent)] hidden md:inline-block"><text x="50" y="85" font-size="90" text-anchor="middle" fill="currentColor">‚µü</text></svg>
                <span data-i18n="appTitle">Inzan n Teqbaylit</span>
                <svg aria-hidden="true" width="40" height="40" viewBox="0 0 100 100" class="text-[var(--color-accent)] hidden md:inline-block"><text x="50" y="85" font-size="90" text-anchor="middle" fill="currentColor">‚µ£</text></svg>
            </h1>
            <p class="text-lg md:text-xl text-[var(--color-text-light)] font-light" data-i18n="appSubtitle">Tr√©sors de la Sagesse Kabyle</p>
        </header>

        <nav id="desktop-nav" class="hidden sm:flex justify-center mb-8">
            <div class="flex items-center gap-2 p-2 bg-[var(--color-bg-card)]/80 backdrop-blur-md rounded-xl shadow-md border border-[var(--color-border)]">
                <button data-tab="accueil-tab" class="nav-btn desktop flex items-center gap-2 px-4 py-2 text-[var(--color-text)] rounded-lg border-2 border-transparent">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    <span class="font-semibold" data-i18n="navHome">Accueil</span>
                </button>
                <button data-tab="explorer-tab" class="nav-btn desktop flex items-center gap-2 px-4 py-2 text-[var(--color-text)] rounded-lg border-2 border-transparent">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                    <span class="font-semibold" data-i18n="navExplore">Explorer</span>
                </button>
                <button data-tab="favoris-tab" class="nav-btn desktop flex items-center gap-2 px-4 py-2 text-[var(--color-text)] rounded-lg border-2 border-transparent">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
                    <span class="font-semibold" data-i18n="navFavorites">Favoris</span>
                </button>
                <button data-tab="ai-sage-tab" class="nav-btn desktop flex items-center gap-2 px-4 py-2 text-[var(--color-text)] rounded-lg border-2 border-transparent">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
                    <span class="font-semibold" data-i18n="navSage">Sage AI</span>
                </button>
                <button data-tab="quiz-tab" class="nav-btn desktop flex items-center gap-2 px-4 py-2 text-[var(--color-text)] rounded-lg border-2 border-transparent">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>
                    <span class="font-semibold" data-i18n="navQuiz">Quiz</span>
                </button>
            </div>
        </nav>

        <main>
            <section id="accueil-tab" class="tab-content" aria-labelledby="proverb-of-the-day-title">
                <div class="max-w-4xl mx-auto mb-10 text-center p-6 bg-[var(--color-bg-card)]/70 rounded-xl shadow-inner border border-[var(--color-border)]">
                    <p class="text-lg text-[var(--color-secondary)] italic font-light">
                        <span data-i18n="bankOf">Une Banque de</span> <strong class="text-[var(--color-primary)] font-semibold" id="proverb-count">...</strong>
                        <p class="text-[var(--color-text-light)] font-medium" data-i18n="heroText">D√©couvrez et explorez des milliers de proverbes kabyles (Inzan). Une collection interactive de la sagesse populaire de Kabylie avec des explications, des favoris et une recherche assist√©e par IA.</p>
                        <span class="block mt-2 font-medium text-[var(--color-primary)]">"Anzi am ddwa, ilaq ad t-yesseqdec umdan akken iwulem."</span>
                    </p>
                </div>

                <h2 id="proverb-of-the-day-title" class="text-3xl font-serif text-[var(--color-primary)] mb-5 text-center font-semibold" data-i18n="proverbOfDay">Proverbe du Jour üí°</h2>
                <div id="proverb-of-the-day-card" class="max-w-3xl mx-auto fade-in">
                    <div class="bg-[var(--color-bg-card)] p-6 rounded-xl shadow-2xl border-t-8 border-[var(--color-accent)] flex flex-col justify-center items-center h-40">
                        <span class="loader loader-dark"></span> 
                        <p class="mt-4 text-sm text-[var(--color-text-light)]">Chargement de la sagesse...</p>
                    </div>
                </div>

                <div class="max-w-3xl mx-auto mt-12 fade-in">
                    <div class="bg-gradient-to-br from-yellow-50/50 to-amber-100/50 dark:from-gray-700/50 dark:to-gray-800/50 border-t-4 border-[var(--color-accent)] rounded-xl p-6 flex flex-col sm:flex-row items-center gap-6 shadow-lg">
                        <div class="flex-shrink-0 text-[var(--color-accent)]">
                           <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-serif font-bold text-[var(--color-heading)] mb-2" data-i18n="discoverOriginal">D√©couvrez l'≈íuvre Originale</h3>
                            <p class="text-[var(--color-text)] mb-2" data-i18n="originalBookText">
                                Une partie de cette banque de proverbes est extraite des 4 tomes de l'≈ìuvre magistrale de Monsieur Aomar SIDER : <strong class="text-[var(--color-primary)] font-semibold">"INZAN amek i d-llan"</strong> ("Origines des proverbes et expressions kabyles").
                            </p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="explorer-tab" class="tab-content" aria-labelledby="explorer-title">
                 <div class="sticky top-4 z-20 bg-[var(--color-bg-card)]/80 backdrop-blur-md rounded-xl shadow-lg border border-[var(--color-border)] mb-6">
                    <div class="p-4 space-y-4">
                        
                        <!-- NOUVEAU: Barre d'outils Clavier Tamazight -->
                        <div id="tamazight-keyboard" class="flex gap-2 overflow-x-auto pb-2 custom-scrollbar justify-start sm:justify-center">
                            <button class="char-btn px-3 py-1.5 rounded shadow-sm text-lg" onclick="insertChar('…õ')">…õ</button>
                            <button class="char-btn px-3 py-1.5 rounded shadow-sm text-lg" onclick="insertChar('…£')">…£</button>
                            <button class="char-btn px-3 py-1.5 rounded shadow-sm text-lg" onclick="insertChar('·∏•')">·∏•</button>
                            <button class="char-btn px-3 py-1.5 rounded shadow-sm text-lg" onclick="insertChar('·∏ç')">·∏ç</button>
                            <button class="char-btn px-3 py-1.5 rounded shadow-sm text-lg" onclick="insertChar('·πõ')">·πõ</button>
                            <button class="char-btn px-3 py-1.5 rounded shadow-sm text-lg" onclick="insertChar('·π£')">·π£</button>
                            <button class="char-btn px-3 py-1.5 rounded shadow-sm text-lg" onclick="insertChar('·π≠')">·π≠</button>
                            <button class="char-btn px-3 py-1.5 rounded shadow-sm text-lg" onclick="insertChar('·∫ì')">·∫ì</button>
                            <button class="char-btn px-3 py-1.5 rounded shadow-sm text-lg" onclick="insertChar(' ∑')"> ∑</button>
                        </div>

                        <div class="flex flex-col sm:flex-row gap-4 items-stretch">
                            <div class="search-wrapper flex-grow">
                                <input type="text" id="search-input" placeholder="Rechercher par mot-cl√© ou th√®me..." aria-label="Champ de recherche de proverbe" class="w-full p-3 pr-10 border-2 border-[var(--color-border)] rounded-lg focus:border-[var(--color-primary)] focus:ring-2 focus:ring-[var(--color-primary)]/30 transition duration-200 text-lg shadow-inner bg-[var(--color-bg-card)]">
                                <button class="clear-search-btn" aria-label="Vider la recherche">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </div>
                            <button id="random-btn" aria-label="Afficher un proverbe al√©atoire" class="w-full sm:w-auto px-5 py-3 bg-[var(--color-accent)] text-white font-semibold rounded-lg hover:bg-[var(--color-primary)] transition-all duration-300 flex items-center justify-center gap-2 shadow-md transform hover:scale-[1.02]">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M21 21v-5h-5"/></svg>
                                <span data-i18n="randomBtn">Al√©atoire</span>
                            </button>
                        </div>
                        <nav id="theme-filter-nav" aria-label="Filtres de th√®mes Kabyles">
                            <div class="flex items-center gap-3">
                                <h3 class="text-sm font-bold text-[var(--color-heading)] flex-shrink-0" data-i18n="themesLabel">Th√®mes:</h3>
                                <div class="flex-grow overflow-x-auto custom-scrollbar">
                                    <div id="theme-list-container" class="flex gap-2 py-1">
                                        <!-- Th√®mes charg√©s par JS -->
                                    </div>
                                </div>
                            </div>
                        </nav>
                    </div>
                </div>

                <div id="results-feedback" class="mb-4 text-center text-[var(--color-text-light)] font-semibold min-h-[24px]"></div>

                <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 min-h-[400px]">
                     <div id="initial-load-message" class="md:col-span-2 xl:col-span-3 text-center p-8 bg-[var(--color-bg-card)] rounded-lg shadow-inner flex flex-col items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-[var(--color-text-light)] opacity-70"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg>
                        <p class="mt-4 text-lg text-[var(--color-text-light)]" data-i18n="startSearch">Commencez votre recherche pour trouver un proverbe.</p>
                        <p class="text-md text-[var(--color-text-light)]" data-i18n="orClickRandom">Ou cliquez sur "Al√©atoire" pour une d√©couverte.</p>
                    </div>
                </div>

                <div id="infinite-scroll-loader" role="status" class="text-center mt-8 p-4 hidden">
                    <span class="loader loader-dark" aria-label="Chargement de plus de proverbes"></span>
                </div>
                <p id="no-results" class="text-center text-2xl text-[var(--color-text-light)] mt-12 hidden font-serif p-4 border border-dashed rounded-lg">
                    üòî Aucun proverbe ne correspond √† votre recherche.<br>
                    <span class="text-lg font-sans">Essayez de modifier vos mots-cl√©s.</span>
                </p>
            </section>

            <section id="favoris-tab" class="tab-content" aria-labelledby="favoris-title">
                <h2 id="favoris-title" class="text-3xl font-serif text-[var(--color-primary)] mb-5 text-center font-semibold" data-i18n="myFavorites">Mes Favoris ‚ù§Ô∏è</h2>
                <div id="favorites-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 min-h-[400px]"></div>
                <div id="no-favorites" class="text-center text-xl text-[var(--color-text-light)] mt-12 hidden font-serif p-4">
                    <p data-i18n="noFavoritesYet">Vous n'avez pas encore de proverbes favoris.</p>
                    <button id="go-to-explorer-btn" class="mt-4 px-5 py-2 bg-[var(--color-primary)] text-white font-semibold rounded-lg shadow-md hover:scale-[1.02] transition-transform" data-i18n="exploreProverbs">Explorer les proverbes</button>
                </div>
            </section>

            <section id="ai-sage-tab" class="tab-content" aria-labelledby="ai-sage-title">
                <h2 id="ai-sage-title" class="text-3xl font-serif text-[var(--color-primary)] mb-5 text-center font-semibold" data-i18n="aiSageTitle">Le Sage Artificiel ü§ñ</h2>
                <div class="fade-in max-w-3xl mx-auto bg-[var(--color-bg-card)]/95 p-6 rounded-xl shadow-lg border border-[var(--color-border)]">
                    <p class="text-center text-[var(--color-text-light)] mb-4" data-i18n="aiPromptText">D√©crivez une situation, et laissez notre sage vous proposer les proverbes les plus pertinents.</p>
                    <textarea id="ai-context-input" class="w-full p-3 border-2 border-[var(--color-border)] rounded-lg focus:border-[var(--color-primary)] focus:ring-2 focus:ring-[var(--color-primary)]/30 transition duration-200 text-lg shadow-inner mb-4 bg-[var(--color-bg)]" rows="3" placeholder="Exemple : Mon ami parle beaucoup mais n'agit jamais..."></textarea>
                    <button id="ai-suggest-btn" class="w-full px-5 py-3 bg-[var(--color-secondary)] text-white font-semibold rounded-lg hover:bg-[var(--color-primary)] transition-all duration-300 flex items-center justify-center gap-2 shadow-md transform hover:scale-[1.02] disabled:opacity-70 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
                        <span data-i18n="askAdvice">‚ú® Demander conseil</span>
                    </button>
                    <div id="ai-step-feedback" role="status" aria-live="polite" class="mt-4 text-center text-sm text-[var(--color-text-light)] min-h-[20px]"></div>
                    <div id="ai-result-feedback" class="mt-4 min-h-[24px]"></div>
                </div>
            </section>

             <section id="quiz-tab" class="tab-content" aria-labelledby="quiz-title">
                <h2 id="quiz-title" class="text-3xl font-serif text-[var(--color-primary)] mb-5 text-center font-semibold" data-i18n="quizTitle">Quiz de Sagesse üß†</h2>
                <div id="quiz-container" class="fade-in max-w-3xl mx-auto bg-[var(--color-bg-card)]/95 p-6 rounded-xl shadow-lg border border-[var(--color-border)]">
                    <div class="text-center p-8">
                        <span class="loader loader-dark"></span>
                        <p class="mt-4 text-sm text-[var(--color-text-light)]">Chargement du module de Quiz...</p>
                    </div>
                </div>
            </section>
        </main>

        <footer class="text-center mt-16 py-6 border-t-2 border-[var(--color-border)]">
            <p class="text-[var(--color-text-light)] font-medium" data-i18n="footerText">Une collection de la sagesse populaire kabyle.</p>
            <p class="text-sm text-[var(--color-text-light)] mt-1">Application d√©velopp√©e par TAMAZIRT Boussad. <button id="about-btn" class="text-[var(--color-primary)] underline">En savoir plus</button>.</p>
        </footer>
    </div>

    <nav id="mobile-nav" class="sm:hidden fixed bottom-4 left-4 right-4 bg-[var(--color-bg-card)]/80 backdrop-blur-lg border border-[var(--color-border)] flex justify-around shadow-2xl z-50 rounded-full p-1">
        <button data-tab="accueil-tab" class="nav-btn mobile flex-1 flex flex-col items-center p-2 text-[var(--color-text)]">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            <span class="text-xs font-semibold" data-i18n="navHome">Accueil</span>
        </button>
        <button data-tab="explorer-tab" class="nav-btn mobile flex-1 flex flex-col items-center p-2 text-[var(--color-text)]">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
            <span class="text-xs font-semibold" data-i18n="navExplore">Explorer</span>
        </button>
        <button data-tab="favoris-tab" class="nav-btn mobile flex-1 flex flex-col items-center p-2 text-[var(--color-text)]">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
            <span class="text-xs font-semibold" data-i18n="navFavorites">Favoris</span>
        </button>
        <button data-tab="ai-sage-tab" class="nav-btn mobile flex-1 flex flex-col items-center p-2 text-[var(--color-text)]">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
            <span class="text-xs font-semibold" data-i18n="navSage">Sage AI</span>
        </button>
        <button data-tab="quiz-tab" class="nav-btn mobile flex-1 flex flex-col items-center p-2 text-[var(--color-text)]">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>
            <span class="text-xs font-semibold" data-i18n="navQuiz">Quiz</span>
        </button>
    </nav>
    
    <div id="toast" role="status" aria-live="polite" class="fixed bottom-[-100px] left-1/2 -translate-x-1/2 bg-green-700 text-white py-2 px-5 rounded-full shadow-xl opacity-0 z-[1000]">
        <p>Message</p>
    </div>

    <button id="back-to-top" title="Retour en haut" aria-label="Retourner en haut de la page" class="fixed bottom-[100px] sm:bottom-10 right-5 p-3 bg-[var(--color-secondary)] text-white rounded-full shadow-xl hover:bg-[var(--color-primary)] focus:outline-none transition-all opacity-0 visibility-hidden transform-gpu translate-y-5 z-50">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6"/></svg>
    </button>
    
    <div id="modal-backdrop" class="fixed inset-0 bg-black/60 z-[100] opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <div id="modal-content" role="dialog" aria-modal="true" aria-labelledby="modal-title" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-2xl max-h-[85vh] bg-[var(--color-bg-card)] rounded-lg shadow-2xl z-[101] opacity-0 scale-95 pointer-events-none transition-all duration-300 flex flex-col">
        <header class="flex-shrink-0 p-6 pb-4 pr-12 border-b border-[var(--color-border)]">
            <h2 id="modal-title" class="text-2xl font-serif text-[var(--color-heading)]"></h2>
        </header>
        <div id="modal-body" class="prose max-w-none text-[var(--color-text)] p-6 overflow-y-auto"></div>
        <button id="modal-close-btn" aria-label="Fermer la modale" class="absolute top-4 right-4 text-gray-400 hover:text-[var(--color-heading)] transition-colors z-20 p-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
    </div>

<script>
// --- DICTIONNAIRE DE TRADUCTION ---
const translations = {
    fr: {
        appTitle: "Inzan n Teqbaylit",
        appSubtitle: "Tr√©sors de la Sagesse Kabyle",
        navHome: "Accueil",
        navExplore: "Explorer",
        navFavorites: "Favoris",
        navSage: "Sage AI",
        navQuiz: "Quiz",
        bankOf: "Une Banque de",
        heroText: "D√©couvrez et explorez des milliers de proverbes kabyles (Inzan). Une collection interactive de la sagesse populaire de Kabylie avec des explications, des favoris et une recherche assist√©e par IA.",
        proverbOfDay: "Proverbe du Jour üí°",
        discoverOriginal: "D√©couvrez l'≈íuvre Originale",
        originalBookText: "Une partie de cette banque de proverbes est extraite des 4 tomes de l'≈ìuvre magistrale de Monsieur Aomar SIDER : \"INZAN amek i d-llan\" (Origines des proverbes et expressions kabyles).",
        randomBtn: "Al√©atoire",
        themesLabel: "Th√®mes:",
        startSearch: "Commencez votre recherche pour trouver un proverbe.",
        orClickRandom: "Ou cliquez sur \"Al√©atoire\" pour une d√©couverte.",
        myFavorites: "Mes Favoris ‚ù§Ô∏è",
        noFavoritesYet: "Vous n'avez pas encore de proverbes favoris.",
        exploreProverbs: "Explorer les proverbes",
        aiSageTitle: "Le Sage Artificiel ü§ñ",
        aiPromptText: "D√©crivez une situation, et laissez notre sage vous proposer les proverbes les plus pertinents.",
        askAdvice: "‚ú® Demander conseil",
        quizTitle: "Quiz de Sagesse üß†",
        footerText: "Une collection de la sagesse populaire kabyle.",
        explainBtn: "Expliquer ‚ú®"
    },
    kab: {
        appTitle: "Inzan n Teqbaylit",
        appSubtitle: "Igerruj n Tmusni",
        navHome: "Axxam",
        navExplore: "Nadi",
        navFavorites: "Ta·∏•awact",
        navSage: "Amusnaw AI",
        navQuiz: "Urar",
        bankOf: "Ugar n",
        heroText: "Issin inzan n teqbaylit. D tateknulit tamaynut i yesseqdacen AI iwakken ad tfehme·∏ç inzan-agi.",
        proverbOfDay: "Anzi n wass-a üí°",
        discoverOriginal: " Adlis a te…£re·∏ç ",
        originalBookText: "Tuget n yinzan-agi ttwakksen-d seg 4 yedlisen n Mass Aomar SIDER : \"INZAN amek i d-llan\".",
        randomBtn: "Menwala",
        themesLabel: "Isentel:",
        startSearch: "Bdu anadi iwakken ad tafe·∏ç anzi.",
        orClickRandom: "Ne…£ ddem-d yiwen s \"Menwala\".",
        myFavorites: "Inzan i ·∏•emmle…£ ‚ù§Ô∏è",
        noFavoritesYet: "Ur tes…õi·∏ç ara yakan inzan deg t·∏•awact.",
        exploreProverbs: "Nadi deg yinzan",
        aiSageTitle: "Amusnaw n AI ü§ñ",
        aiPromptText: "Mmeslay-d …£ef tegnit i deg telli·∏ç, amusnaw-nne…£ ad ak-d-yefk inzan i ilaqen.",
        askAdvice: "‚ú® Ger ti…£·πõi",
        quizTitle: "Urar n Tmusni üß†",
        footerText: "Tamusni n teqbaylit.",
        explainBtn: "Fhem Anzi ‚ú®"
    }
};

document.addEventListener('DOMContentLoaded', () => {

    // --- SERVICE WORKER REGISTRATION ---
    const registerServiceWorker = () => {
        if ('serviceWorker' in navigator) {
            const swScript = `
                const CACHE_NAME = 'inzan-cache-v3'; // Increased version
                const urlsToCache = [
                    '/',
                    '/index.html',
                    '/proverbs.json',
                    'https://cdn.tailwindcss.com',
                    'https://fonts.googleapis.com/css2?family=Tinos:ital,wght@0,400;0,700;1,400&family=Raleway:wght@300;400;500;600;700&display=swap'
                ];
                self.addEventListener('install', event => {
                    event.waitUntil(
                        caches.open(CACHE_NAME).then(cache => {
                            return cache.addAll(urlsToCache);
                        })
                    );
                });
                self.addEventListener('fetch', event => {
                    event.respondWith(
                        caches.match(event.request).then(response => {
                            return response || fetch(event.request);
                        })
                    );
                });
                self.addEventListener('activate', event => {
                    const cacheWhitelist = [CACHE_NAME];
                    event.waitUntil(
                        caches.keys().then(cacheNames => {
                            return Promise.all(
                                cacheNames.map(cacheName => {
                                    if (cacheWhitelist.indexOf(cacheName) === -1) {
                                        return caches.delete(cacheName);
                                    }
                                })
                            );
                        })
                    );
                });
            `;
            const blob = new Blob([swScript], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            navigator.serviceWorker.register(swUrl).catch(console.error);
        }
    };


    // --- CONSTANTES & √âL√âMENTS DU DOM ---
    const PROVERBS_PER_PAGE = 50;
    const dom = {
        html: document.documentElement,
        splashScreen: document.getElementById('splash-screen'),
        searchInput: document.getElementById('search-input'),
        clearSearchBtn: document.querySelector('.clear-search-btn'),
        resultsContainer: document.getElementById('results-container'),
        resultsFeedback: document.getElementById('results-feedback'),
        initialLoadMessage: document.getElementById('initial-load-message'),
        loaderContainer: document.getElementById('infinite-scroll-loader'),
        favoritesContainer: document.getElementById('favorites-container'),
        noResults: document.getElementById('no-results'),
        noFavorites: document.getElementById('no-favorites'),
        goToExplorerBtn: document.getElementById('go-to-explorer-btn'),
        toast: document.getElementById('toast'),
        proverbOfTheDayCard: document.getElementById('proverb-of-the-day-card'),
        proverbCount: document.getElementById('proverb-count'),
        randomBtn: document.getElementById('random-btn'),
        backToTopBtn: document.getElementById('back-to-top'),
        themeListContainer: document.getElementById('theme-list-container'),
        navButtons: document.querySelectorAll('.nav-btn'),
        tabContents: document.querySelectorAll('.tab-content'),
        quizContainer: document.getElementById('quiz-container'),
        aboutBtn: document.getElementById('about-btn'),
        themeToggle: document.getElementById('theme-toggle'),
        themeIcons: {
            light: document.getElementById('theme-icon-light'),
            dark: document.getElementById('theme-icon-dark')
        },
        langToggle: document.getElementById('lang-toggle'), // NOUVEAU
        currentLangText: document.getElementById('current-lang-text'), // NOUVEAU
        modal: {
            backdrop: document.getElementById('modal-backdrop'),
            content: document.getElementById('modal-content'),
            title: document.getElementById('modal-title'),
            body: document.getElementById('modal-body'),
            closeBtn: document.getElementById('modal-close-btn'),
        },
        ai: {
            contextInput: document.getElementById('ai-context-input'),
            suggestBtn: document.getElementById('ai-suggest-btn'),
            stepFeedback: document.getElementById('ai-step-feedback'),
            resultFeedback: document.getElementById('ai-result-feedback'),
        }
    };

    // --- √âTAT GLOBAL ---
    const state = {
        activeTheme: 'tous',
        searchTimeout: null,
        proverbs: [],
        favorites: new Set(JSON.parse(localStorage.getItem('inzan_favorites')) || []),
        isCoreDataLoaded: false,
        currentPage: 0,
        displayedProverbs: [],
        isLoading: false,
        totalFilteredCount: 0,
        currentLang: localStorage.getItem('inzan_lang') || 'fr', // NOUVEAU
        aiQuiz: {
            questions: [], 
            currentQuestionIndex: 0,
            score: 0,
            isLoading: false,
            preloadPromise: null
        }
    };

    // --- FONCTIONS UTILITAIRES ---
    const normalizeText = (text) => {
        if (!text) return '';
        let normalized = text.toLowerCase().trim();
        normalized = normalized
            .replace(/…£/g, "gh").replace(/ƒç/g, "tch").replace(/«ß/g, "dj").replace(/…õ/g, "3").replace(/xx/g, "kh").replace(/tt/g, "ts")
            .replace(/·π£/g, "s").replace(/·π≠/g, "t").replace(/·∫ì/g, "z").replace(/·∏ç/g, "d").replace(/·∏•/g, "h")
            .replace(/(?<!o)u/g, "ou").replace(/c(?!h)/g, "ch").replace(/t(?!h)/g, "th").replace(/d(?!h)/g, "dh").replace(/(?<!k)x/g, "kh");
        normalized = normalized.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        return normalized.replace(/[^a-z0-9\s]/g, '');
    };

    const debounce = (func, delay) => (...args) => {
        clearTimeout(state.searchTimeout);
        state.searchTimeout = setTimeout(() => func(...args), delay);
    };

    const renderMarkdown = (text) => {
        let html = text.trim();
        html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>').replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>').replace(/\*(.*?)\*/gim, '<em>$1</em>');
        html = html.replace(/^\* (.*$)/gim, '<li>$1</li>').replace(/(\<\/li\>)?\n<li>/gim, '</li><li>').replace(/^(<li>.*<\/li>)$/gim, '<ul>$1</ul>');
        return html.split('\n\n').map(p => {
            if (p.startsWith('<ul>') || p.startsWith('<h3>')) return p;
            return `<p>${p.replace(/\n/g, '<br>')}</p>`;
        }).join('');
    };
    
    const showToast = (message, isError = false) => {
        dom.toast.querySelector('p').textContent = message;
        dom.toast.className = `fixed bottom-[-100px] left-1/2 -translate-x-1/2 text-white py-2 px-5 rounded-full shadow-xl opacity-0 z-[1000] ${isError ? 'bg-red-600' : 'bg-green-700'}`;
        requestAnimationFrame(() => dom.toast.classList.add('bottom-28', 'sm:bottom-10', 'opacity-100'));
        setTimeout(() => dom.toast.classList.remove('bottom-28', 'sm:bottom-10', 'opacity-100'), 3000);
    };

    const highlightText = (text, query) => {
        if (!text || !query) return text;
        const normalizedQuery = normalizeText(query);
        const keywords = normalizedQuery.split(' ').filter(k => k.length > 0);
        if (keywords.length === 0) return text;
        const regex = new RegExp(`(${keywords.map(k => k.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')).join('|')})`, 'gi');
        return text.replace(regex, `<span class="search-highlight">$1</span>`);
    };

    // --- NOUVEAU: FONCTIONS I18N (Traduction) ---
    const updateInterfaceLanguage = () => {
        const langData = translations[state.currentLang];
        document.documentElement.lang = state.currentLang;
        dom.currentLangText.textContent = state.currentLang === 'fr' ? '‚µù' : 'FR';
        
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (langData[key]) {
                el.textContent = langData[key];
            }
        });
        // Mise √† jour sp√©cifique pour les champs de formulaire
        if (state.currentLang === 'kab') {
            dom.searchInput.placeholder = "Nadi s wawalen...";
            dom.ai.contextInput.placeholder = "Amedya: Ameddakel-iw yettmeslay a·π≠as...";
        } else {
            dom.searchInput.placeholder = "Rechercher par mot-cl√© ou th√®me...";
            dom.ai.contextInput.placeholder = "Exemple : Mon ami parle beaucoup mais n'agit jamais...";
        }
    };

    const toggleLanguage = () => {
        state.currentLang = state.currentLang === 'fr' ? 'kab' : 'fr';
        localStorage.setItem('inzan_lang', state.currentLang);
        updateInterfaceLanguage();
        // Re-render pour mettre √† jour les textes des boutons dynamiques (ex: Expliquer)
        if (state.displayedProverbs.length > 0) {
            const currentProverbs = [...state.displayedProverbs];
            dom.resultsContainer.innerHTML = '';
            renderChunk(dom.resultsContainer, currentProverbs, dom.searchInput.value, true);
        }
    };

    // --- NOUVEAU: CLAVIER VIRTUEL ---
    window.insertChar = (char) => {
        const input = dom.searchInput;
        const start = input.selectionStart;
        const end = input.selectionEnd;
        const text = input.value;
        input.value = text.substring(0, start) + char + text.substring(end);
        input.selectionStart = input.selectionEnd = start + char.length;
        input.focus();
        loadNextChunk(true); // D√©clencher la recherche
    };

    // --- NOUVEAU: TTS (Synth√®se Vocale) ---
    const speakProverb = (text) => {
        window.speechSynthesis.cancel(); // Arr√™ter toute lecture en cours
        const utterance = new SpeechSynthesisUtterance(text);
        // Essayer de trouver une voix appropri√©e (Kabyle n'existe pas souvent, on utilise une voix g√©n√©rique ou FR avec accent)
        utterance.lang = 'fr-FR'; 
        utterance.rate = 0.9; // Un peu plus lent pour la clart√©
        utterance.pitch = 1;
        window.speechSynthesis.speak(utterance);
        showToast("üì¢ Lecture en cours...");
    };

    // --- NOUVEAU: G√âN√âRATEUR D'IMAGE SOCIALE (CANVAS) ---
    const generateSocialImage = (proverb) => {
        openModal("Aper√ßu de la carte", `
            <div class="flex flex-col items-center">
                <canvas id="share-canvas" width="1080" height="1080" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 1rem;"></canvas>
                <a id="download-link" href="#" class="px-6 py-3 bg-[var(--color-primary)] text-white font-bold rounded-lg shadow-md hover:scale-105 transition-transform flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    T√©l√©charger l'image
                </a>
            </div>
        `);

        const canvas = document.getElementById('share-canvas');
        const ctx = canvas.getContext('2d');

        // 1. Fond Artistique (Motifs Berb√®res Simplifi√©s par Code)
        const gradient = ctx.createLinearGradient(0, 0, 1080, 1080);
        gradient.addColorStop(0, '#F9F7F3'); // Couleur cr√®me
        gradient.addColorStop(1, '#E8E4D9');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, 1080, 1080);

        // Dessin de motifs g√©om√©triques (Triangles berb√®res)
        ctx.fillStyle = 'rgba(74, 124, 89, 0.1)'; // Vert transparent
        for (let i = 0; i < 12; i++) {
            ctx.beginPath();
            ctx.moveTo(i * 100, 0);
            ctx.lineTo((i * 100) + 50, 100);
            ctx.lineTo((i * 100) - 50, 100);
            ctx.fill();
        }
        ctx.fillStyle = 'rgba(199, 154, 42, 0.1)'; // Jaune/Or transparent
        ctx.beginPath();
        ctx.arc(1000, 80, 200, 0, 2 * Math.PI); // Soleil coin haut droit
        ctx.fill();

        // Cadre
        ctx.strokeStyle = '#4A7C59';
        ctx.lineWidth = 20;
        ctx.strokeRect(40, 40, 1000, 1000);

        // 2. Texte
        ctx.fillStyle = '#2F4F4F';
        ctx.textAlign = 'center';
        
        // Configuration police Kabyle
        ctx.font = 'italic bold 70px "Times New Roman", serif';
        const kabyleWords = `¬´ ${proverb.kabyle} ¬ª`.split(' ');
        let line = '';
        let y = 400;
        const maxWidth = 900;
        
        // Word wrap simple pour le Kabyle
        for(let n = 0; n < kabyleWords.length; n++) {
            const testLine = line + kabyleWords[n] + ' ';
            const metrics = ctx.measureText(testLine);
            if (metrics.width > maxWidth && n > 0) {
                ctx.fillText(line, 540, y);
                line = kabyleWords[n] + ' ';
                y += 90;
            } else {
                line = testLine;
            }
        }
        ctx.fillText(line, 540, y);

        // S√©parateur
        y += 60;
        ctx.beginPath();
        ctx.moveTo(400, y);
        ctx.lineTo(680, y);
        ctx.strokeStyle = '#C79A2A';
        ctx.lineWidth = 5;
        ctx.stroke();

        // Configuration police Fran√ßais
        y += 80;
        ctx.font = '40px "Arial", sans-serif';
        ctx.fillStyle = '#4B5563';
        const frWords = proverb.francais.split(' ');
        line = '';
        for(let n = 0; n < frWords.length; n++) {
            const testLine = line + frWords[n] + ' ';
            const metrics = ctx.measureText(testLine);
            if (metrics.width > maxWidth && n > 0) {
                ctx.fillText(line, 540, y);
                line = frWords[n] + ' ';
                y += 60;
            } else {
                line = testLine;
            }
        }
        ctx.fillText(line, 540, y);

        // Footer
        ctx.font = 'bold 30px "Arial", sans-serif';
        ctx.fillStyle = '#4A7C59';
        ctx.fillText("Inzan n Teqbaylit", 540, 980);

        // 3. Pr√©parer le t√©l√©chargement
        const link = document.getElementById('download-link');
        link.download = `proverbe-kabyle-${proverb.id}.png`;
        link.href = canvas.toDataURL('image/png');
    };


    // --- RENDU UI DYNAMIQUE ---
    const createProverbCardHTML = (proverb, isDaily = false, query = '') => {
        if (!proverb) return '';
        const themes = (proverb.theme || '').split(/[,/]/).map(t => t.trim().replace(/[()]/g, '')).filter(Boolean);
        const themesHtml = themes.map(theme =>
            `<button class="card-theme-badge px-2 py-1 rounded-full text-xs font-semibold bg-[var(--color-primary)]/10 text-[var(--color-primary)]" data-theme="${normalizeText(theme)}">${theme.charAt(0).toUpperCase() + theme.slice(1).toLowerCase()}</button>`
        ).join('');
        const cardClasses = isDaily 
            ? `bg-[var(--color-bg-card)] p-6 rounded-xl shadow-2xl border-t-8 border-[var(--color-accent)]`
            : `stagger-in bg-[var(--color-bg-card)] p-5 rounded-lg shadow-md hover:shadow-xl hover:-translate-y-1 transition-all flex flex-col border-l-4 border-[var(--color-primary)]`;
        const isFavorited = state.favorites.has(proverb.id);
        const explainText = translations[state.currentLang].explainBtn || "Expliquer ‚ú®";

        // MODIFI√â : Ajout des boutons TTS et Image dans la barre d'action
        return `
        <div class="${cardClasses}" id="proverb-${proverb.id}" data-id="${proverb.id}">
            <div class="flex-grow">
                <p class="text-xl font-serif font-bold text-[var(--color-heading)] mb-2 italic">¬´ ${highlightText(proverb.kabyle, query)} ¬ª</p>
                <p class="text-[var(--color-text)] text-lg mb-4 border-b border-[var(--color-border)] pb-3 font-light">‚Äî ${highlightText(proverb.francais, query)}</p>
                <div class="flex flex-wrap gap-2 items-center min-h-[30px]">${themesHtml}</div>
            </div>
            <div class="mt-4 pt-3 border-t border-[var(--color-border)] flex justify-between items-center gap-2">
                <button class="explain-btn text-xs font-semibold text-[var(--color-text-light)] hover:text-[var(--color-primary)] transition-colors">${explainText}</button>
                <div class="flex items-center gap-1 text-[var(--color-text-light)]">
                    <button class="action-btn tts-btn p-1 hover:text-[var(--color-primary)]" aria-label="√âcouter le proverbe">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
                    </button>
                    <button class="action-btn image-btn p-1 hover:text-[var(--color-primary)]" aria-label="Cr√©er une image √† partager">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                    </button>
                    <button class="action-btn favorite-btn ${isFavorited ? 'favorited' : ''} p-1 hover:text-pink-500" aria-label="Ajouter aux favoris">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
                    </button>
                    <button class="action-btn copy-btn p-1 hover:text-[var(--color-primary)]" aria-label="Copier le proverbe">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                    </button>
                </div>
            </div>
        </div>`;
    };

    const renderChunk = (container, proverbs, query, append = true) => {
        const chunkHtml = proverbs.map((p, i) => {
            const cardHTML = createProverbCardHTML(p, false, query);
            const wrapper = document.createElement('div');
            wrapper.innerHTML = cardHTML;
            const cardElement = wrapper.firstElementChild;
            cardElement.style.animationDelay = `${i * 50}ms`;
            return cardElement.outerHTML;
        }).join('');
        if (append) {
            container.insertAdjacentHTML('beforeend', chunkHtml);
        } else {
            container.innerHTML = chunkHtml;
        }
    };
    
    const updateAvailableThemes = (proverbsList) => {
        if (!state.isCoreDataLoaded) return;
        const source = proverbsList || state.proverbs;
        const allThemesRaw = source.flatMap(p => (p.theme || '').split(/[,/]/).map(t => t.trim().replace(/[()]/g, '')).filter(Boolean));
        const uniqueNormalizedThemes = [...new Map(allThemesRaw.map(t => [normalizeText(t), t.charAt(0).toUpperCase() + t.slice(1).toLowerCase()])).entries()];
        uniqueNormalizedThemes.sort((a, b) => a[1].localeCompare(b[1]));
        
        state.activeTheme = localStorage.getItem('inzan_theme_filter') || 'tous';
        
        dom.themeListContainer.innerHTML =
            `<button class="theme-pill-button flex-shrink-0 px-4 py-2 rounded-full bg-[var(--color-bg-alt)] shadow-sm cursor-pointer font-medium text-sm text-[var(--color-text)] hover:bg-[var(--color-primary)]/20" data-theme="tous">Tous</button>` +
            uniqueNormalizedThemes.map(([norm, disp]) =>
                `<button class="theme-pill-button flex-shrink-0 px-4 py-2 rounded-full bg-[var(--color-bg-alt)] shadow-sm cursor-pointer font-medium text-sm text-[var(--color-text)] hover:bg-[var(--color-primary)]/20" data-theme="${norm}">${disp}</button>`
            ).join('');
        const activeThemeButton = dom.themeListContainer.querySelector(`[data-theme="${state.activeTheme}"]`);
        if (activeThemeButton) activeThemeButton.classList.add('active');
    };

    const filterProverbs = (keywords = []) => {
        if (!state.isCoreDataLoaded) return [];
        if (keywords.length === 0) {
            const query = dom.searchInput.value;
            const normalizedQuery = normalizeText(query);
            keywords = normalizedQuery.split(' ').filter(k => k.length > 0);
            return state.proverbs.filter(p => {
                const themeMatch = state.activeTheme === 'tous' || (p.theme_norm || '').includes(state.activeTheme);
                if (!themeMatch) return false;
                const queryMatch = keywords.length === 0 || keywords.every(keyword => 
                    `${p.kabyle_norm || ''} ${p.francais_norm || ''} ${p.theme_norm || ''}`.includes(keyword)
                );
                return queryMatch;
            });
        }
        const normalizedKeywords = keywords.map(normalizeText);
        return state.proverbs.filter(p => {
            const proverbText = `${p.kabyle_norm || ''} ${p.francais_norm || ''} ${p.theme_norm || ''}`;
            return normalizedKeywords.some(keyword => proverbText.includes(keyword));
        });
    };

    const loadNextChunk = (reset = false) => {
        if (state.isLoading || !state.isCoreDataLoaded) return;
        const isSearching = dom.searchInput.value.trim().length > 0 || state.activeTheme !== 'tous';
        if (reset) {
            state.currentPage = 0;
            state.displayedProverbs = [];
            dom.resultsContainer.innerHTML = '';
            window.scrollTo(0, 0);
        }
        if (!isSearching && reset) {
            dom.initialLoadMessage.classList.remove('hidden');
            dom.noResults.classList.add('hidden');
            dom.resultsFeedback.textContent = '';
            dom.loaderContainer.classList.add('hidden');
            return;
        }
        dom.initialLoadMessage.classList.add('hidden');
        if (!reset && state.displayedProverbs.length >= state.totalFilteredCount) {
             dom.loaderContainer.classList.add('hidden');
             return;
        }
        state.isLoading = true;
        dom.loaderContainer.classList.remove('hidden');
        
        const filteredProverbs = filterProverbs();
        if (reset) {
            state.totalFilteredCount = filteredProverbs.length;
        }
        const startIndex = state.currentPage * PROVERBS_PER_PAGE;
        const endIndex = startIndex + PROVERBS_PER_PAGE;
        const chunkToLoad = filteredProverbs.slice(startIndex, endIndex);

        if (chunkToLoad.length === 0 && reset) {
            dom.noResults.classList.remove('hidden');
            dom.resultsFeedback.textContent = '';
        } else {
            dom.noResults.classList.add('hidden');
            renderChunk(dom.resultsContainer, chunkToLoad, dom.searchInput.value, true);
            state.displayedProverbs.push(...chunkToLoad);
            state.currentPage++;
            dom.resultsFeedback.textContent = `Affichage de ${state.displayedProverbs.length} sur ${state.totalFilteredCount} proverbes`;
        }
        if (reset) updateAvailableThemes(filteredProverbs);
        if (state.displayedProverbs.length >= state.totalFilteredCount) {
             dom.loaderContainer.classList.add('hidden');
        }
        state.isLoading = false;
    };

    const renderFavorites = () => {
        if (!state.isCoreDataLoaded) {
            dom.favoritesContainer.innerHTML = `<div class="md:col-span-2 xl:col-span-3 text-center p-8 text-[var(--color-text-light)]"><span class="loader loader-dark"></span> <p class="mt-2">Chargement des donn√©es en cours...</p></div>`;
            return;
        }
        const favoriteProverbs = state.proverbs.filter(p => state.favorites.has(p.id));
        dom.noFavorites.classList.toggle('hidden', favoriteProverbs.length > 0);
        renderChunk(dom.favoritesContainer, favoriteProverbs, '', false);
    };

    const setActiveTab = (tabId) => {
        if (['quiz-tab', 'ai-sage-tab'].includes(tabId) && !state.isCoreDataLoaded) {
            showToast("Les donn√©es de base ne sont pas encore charg√©es.", true);
            return;
        }
        dom.tabContents.forEach(content => content.classList.toggle('active', content.id === tabId));
        dom.navButtons.forEach(button => button.classList.toggle('active', button.dataset.tab === tabId));
        if (tabId === 'favoris-tab') renderFavorites();
        if (tabId === 'quiz-tab' && state.isCoreDataLoaded && !dom.quizContainer.querySelector('#quiz-game-screen')) {
            showQuizStartScreen();
        }
        if (document.body.clientWidth < 640) window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    const toggleFavorite = (id) => {
        const isFavorited = state.favorites.has(id);
        if (isFavorited) {
            state.favorites.delete(id);
            showToast("üíî Retir√© des favoris", true);
        } else {
            state.favorites.add(id);
            showToast("‚ù§Ô∏è Ajout√© aux favoris !");
        }
        localStorage.setItem('inzan_favorites', JSON.stringify([...state.favorites]));
        document.querySelectorAll(`#proverb-${id} .favorite-btn`).forEach(btn => {
            btn.classList.toggle('favorited', !isFavorited);
        });
        if (document.getElementById('favoris-tab').classList.contains('active')) {
            renderFavorites();
        }
    };

    const openModal = (title, bodyContent) => {
        dom.modal.title.textContent = title;
        dom.modal.body.innerHTML = bodyContent;
        dom.modal.backdrop.classList.add('visible');
        dom.modal.content.classList.add('visible');
        document.body.style.overflow = 'hidden';
    };

    const closeModal = () => {
        dom.modal.backdrop.classList.remove('visible');
        dom.modal.content.classList.remove('visible');
        document.body.style.overflow = '';
    };
    
    // --- LOGIQUE API GEMINI ---
    const callGeminiAPI = async (payload, expectJson = false) => {
        const GEMINI_API_KEY = "AIzaSyCWWRjzRHJGKjOeCrrKw71jSZSxF8sUV0o"; // VOTRE CL√â API ICI
        if (!GEMINI_API_KEY) throw new Error("La cl√© API n'est pas configur√©e dans le code source.");

        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
        if (expectJson) payload.generationConfig = { responseMimeType: "application/json" };

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error(`Erreur API ${response.status}`);
            const result = await response.json();
            const textResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!textResponse) throw new Error("R√©ponse de l'API vide.");
            return expectJson ? JSON.parse(textResponse) : textResponse;
        } catch (error) {
            console.error(error);
            throw new Error("Erreur de connexion avec le Sage Artificiel.");
        }
    };

    const getProverbExplanation = async (proverb) => {
        openModal("Explication du Proverbe", `<div class="flex justify-center p-8"><span class="loader loader-dark"></span></div>`);
        const systemPrompt = `Vous √™tes un expert de la culture kabyle. Expliquez le proverbe suivant.`;
        try {
            const explanation = await callGeminiAPI({
                contents: [{ parts: [{ text: `Explique ce proverbe kabyle : "${proverb.kabyle}" (Traduction: "${proverb.francais}")` }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            });
            dom.modal.body.innerHTML = renderMarkdown(explanation);
        } catch (error) {
            dom.modal.body.innerHTML = `<p class="text-red-500">Erreur lors de la communication avec l'IA.</p>`;
        }
    };
    
    // --- LOGIQUE IA SAGE (Simplifi√©e pour la bri√®vet√© du code) ---
    const getAISuggestion = async (context) => {
        dom.ai.suggestBtn.disabled = true;
        dom.ai.suggestBtn.innerHTML = `<span class="loader"></span>`;
        dom.ai.resultFeedback.innerHTML = '';
        dom.ai.stepFeedback.textContent = "Analyse en cours...";
        
        try {
            // Etape 1: Mots-cl√©s
            const keywordsData = await callGeminiAPI({
                contents: [{ parts: [{ text: `Situation: "${context}"` }] }],
                systemInstruction: { parts: [{ text: `G√©n√®re 5 mots-cl√©s pertinents pour trouver un proverbe kabyle adapt√©. JSON: { "keywords": ["mot1", ...] }` }] }
            }, true);
            
            const localResults = filterProverbs(keywordsData.keywords).slice(0, 30);
            
            // Etape 2: S√©lection
            if (localResults.length === 0) throw new Error("Aucun proverbe trouv√© localement.");
            
            const selectionData = await callGeminiAPI({
                contents: [{ parts: [{ text: `Situation: "${context}". Liste: ${JSON.stringify(localResults.map(p=>({id:p.id, k:p.kabyle, f:p.francais})))}` }] }],
                systemInstruction: { parts: [{ text: `Choisis le meilleur proverbe. JSON: { "reasoning": "...", "proverbs": [ { "id": 1, "justification": "..." } ] }` }] }
            }, true);

            let htmlResult = `<p class="text-center italic text-[var(--color-text-light)] mb-4">"${selectionData.reasoning}"</p>`;
            selectionData.proverbs.forEach(p => {
                const fullProverb = state.proverbs.find(fp => fp.id === p.id);
                if (fullProverb) {
                    htmlResult += `<div class="mb-3 p-3 bg-green-50 rounded border-l-4 border-green-500"><p class="text-sm">"${p.justification}"</p></div>` + createProverbCardHTML(fullProverb);
                }
            });
            dom.ai.resultFeedback.innerHTML = htmlResult;

        } catch (e) {
            dom.ai.resultFeedback.innerHTML = `<p class="text-red-500 text-center">Erreur: ${e.message}</p>`;
        } finally {
            dom.ai.suggestBtn.disabled = false;
            dom.ai.suggestBtn.textContent = "‚ú® Demander conseil";
            dom.ai.stepFeedback.textContent = "";
        }
    };

    // --- QUIZ LOGIC (Simplifi√©e) ---
    const showQuizStartScreen = () => {
        dom.quizContainer.innerHTML = `
            <div id="quiz-start-screen" class="text-center">
                <p class="text-lg text-[var(--color-text-light)] mb-6">Pr√™t √† tester vos connaissances ?</p>
                <button id="start-ai-quiz-btn" class="w-full px-6 py-3 bg-[var(--color-primary)] text-white font-bold rounded-lg hover:bg-[var(--color-secondary)] transition-all">Lancer le Quiz IA</button>
            </div>
            <div id="quiz-game-screen" class="hidden"></div>
        `;
        document.getElementById('start-ai-quiz-btn').addEventListener('click', handleStartAiQuiz);
    };

    const handleStartAiQuiz = async () => {
        dom.quizContainer.innerHTML = `<div class="text-center p-8"><span class="loader loader-dark"></span><p class="mt-4">G√©n√©ration du quiz...</p></div>`;
        try {
            const sample = [...state.proverbs].sort(() => 0.5 - Math.random()).slice(0, 20);
            const quizData = await callGeminiAPI({
                contents: [{ parts: [{ text: `Liste: ${JSON.stringify(sample.map(p=>({k:p.kabyle, f:p.francais})))}` }] }],
                systemInstruction: { parts: [{ text: `G√©n√®re 5 questions QCM sur ces proverbes. JSON: { "questions": [{ "question": "...", "options": ["A","B","C","D"], "correctAnswerIndex": 0, "explanation": "..." }] }` }] }
            }, true);
            state.aiQuiz.questions = quizData.questions;
            state.aiQuiz.currentQuestionIndex = 0;
            state.aiQuiz.score = 0;
            dom.quizContainer.innerHTML = `<div id="quiz-game-screen"></div>`;
            displayAiQuizQuestion();
        } catch (e) {
            dom.quizContainer.innerHTML = `<p class="text-red-500 text-center">Erreur: ${e.message}</p><button onclick="showQuizStartScreen()" class="mt-4 bg-gray-200 p-2 rounded">Retour</button>`;
        }
    };

    const displayAiQuizQuestion = () => {
        const gameScreen = dom.quizContainer.querySelector('#quiz-game-screen');
        const q = state.aiQuiz.questions[state.aiQuiz.currentQuestionIndex];
        if (!q) return showAiQuizResults();

        gameScreen.innerHTML = `
            <div class="mb-4 flex justify-between font-bold"><span class="text-[var(--color-primary)]">Q ${state.aiQuiz.currentQuestionIndex + 1}/${state.aiQuiz.questions.length}</span><span>Score: ${state.aiQuiz.score}</span></div>
            <p class="text-xl font-bold mb-6">${q.question}</p>
            <div id="quiz-options" class="space-y-3">${q.options.map((o, i) => `<div class="quiz-option" data-index="${i}">${o}</div>`).join('')}</div>
            <div id="quiz-feedback-ai" class="mt-6"></div>
        `;
        gameScreen.querySelectorAll('.quiz-option').forEach(el => el.addEventListener('click', (e) => handleAiQuizAnswer(parseInt(e.target.dataset.index))));
    };

    const handleAiQuizAnswer = (idx) => {
        const q = state.aiQuiz.questions[state.aiQuiz.currentQuestionIndex];
        const isCorrect = idx === q.correctAnswerIndex;
        if (isCorrect) state.aiQuiz.score++;
        
        const feedback = document.getElementById('quiz-feedback-ai');
        feedback.innerHTML = `<div class="p-4 rounded ${isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
            <p class="font-bold">${isCorrect ? 'Bravo !' : 'Incorrect'}</p><p>${q.explanation}</p>
        </div><button id="next-q-btn" class="mt-4 w-full bg-[var(--color-primary)] text-white py-2 rounded">Suivant</button>`;
        
        document.getElementById('next-q-btn').addEventListener('click', () => {
            state.aiQuiz.currentQuestionIndex++;
            displayAiQuizQuestion();
        });
    };

    const showAiQuizResults = () => {
        dom.quizContainer.querySelector('#quiz-game-screen').innerHTML = `
            <div class="text-center">
                <h3 class="text-2xl font-bold mb-4">Termin√© !</h3>
                <p class="text-4xl text-[var(--color-primary)] font-bold">${state.aiQuiz.score} / ${state.aiQuiz.questions.length}</p>
                <button id="restart-btn" class="mt-8 px-6 py-3 bg-[var(--color-primary)] text-white rounded-lg">Recommencer</button>
            </div>`;
        document.getElementById('restart-btn').addEventListener('click', showQuizStartScreen);
    };

    // --- SETUP PRINCIPAL ---
    const setupEventListeners = () => {
        dom.searchInput.addEventListener('input', debounce(() => loadNextChunk(true), 350));
        dom.clearSearchBtn.addEventListener('click', () => { dom.searchInput.value = ''; loadNextChunk(true); });
        dom.goToExplorerBtn.addEventListener('click', () => setActiveTab('explorer-tab'));
        dom.randomBtn.addEventListener('click', () => {
            if (!state.isCoreDataLoaded) return;
            const shuffled = [...state.proverbs].sort(() => 0.5 - Math.random()).slice(0, 20);
            dom.resultsContainer.innerHTML = '';
            renderChunk(dom.resultsContainer, shuffled, '', false);
            dom.initialLoadMessage.classList.add('hidden');
            dom.noResults.classList.add('hidden');
        });
        dom.backToTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
        window.addEventListener('scroll', () => dom.backToTopBtn.classList.toggle('visible', window.scrollY > 300));
        dom.navButtons.forEach(btn => btn.addEventListener('click', () => setActiveTab(btn.dataset.tab)));
        
        // Listener unifi√© pour les boutons dans les cartes
        document.body.addEventListener('click', e => {
            const card = e.target.closest('[data-id]');
            if (!card) return;
            const proverb = state.proverbs.find(p => p.id === parseInt(card.dataset.id));
            if (!proverb) return;

            if (e.target.closest('.explain-btn')) getProverbExplanation(proverb);
            if (e.target.closest('.favorite-btn')) toggleFavorite(proverb.id);
            if (e.target.closest('.copy-btn')) navigator.clipboard.writeText(`¬´ ${proverb.kabyle} ¬ª\n‚Äî ${proverb.francais}`).then(() => showToast("Copi√© !"));
            
            // NOUVEAU: TTS
            if (e.target.closest('.tts-btn')) speakProverb(proverb.kabyle);
            
            // NOUVEAU: Image Generator
            if (e.target.closest('.image-btn')) generateSocialImage(proverb);

            if (e.target.closest('.card-theme-badge')) {
                 e.stopPropagation();
                 state.activeTheme = e.target.closest('.card-theme-badge').dataset.theme;
                 setActiveTab('explorer-tab');
                 setTimeout(() => { dom.searchInput.value = ''; loadNextChunk(true); }, 100);
            }
        });

        dom.themeListContainer.addEventListener('click', (e) => {
            if (e.target.matches('.theme-pill-button')) {
                state.activeTheme = e.target.dataset.theme;
                localStorage.setItem('inzan_theme_filter', state.activeTheme);
                dom.themeListContainer.querySelector('.active')?.classList.remove('active');
                e.target.classList.add('active');
                loadNextChunk(true);
            }
        });

        dom.modal.closeBtn.addEventListener('click', closeModal);
        dom.modal.backdrop.addEventListener('click', closeModal);
        dom.themeToggle.addEventListener('click', () => {
            const isDark = dom.html.classList.toggle('dark');
            localStorage.setItem('inzan_theme', isDark ? 'dark' : 'light');
            dom.themeIcons.light.classList.toggle('hidden', isDark);
            dom.themeIcons.dark.classList.toggle('hidden', !isDark);
        });
        dom.langToggle.addEventListener('click', toggleLanguage); // NOUVEAU
        dom.ai.suggestBtn.addEventListener('click', () => {
            const ctx = dom.ai.contextInput.value.trim();
            if (ctx) getAISuggestion(ctx);
        });
    };

    const main = () => {
        const savedTheme = localStorage.getItem('inzan_theme') || 'light';
        dom.html.classList.toggle('dark', savedTheme === 'dark');
        dom.themeIcons.light.classList.toggle('hidden', savedTheme === 'dark');
        dom.themeIcons.dark.classList.toggle('hidden', savedTheme === 'light');
        
        // Initialiser la langue
        updateInterfaceLanguage();

        registerServiceWorker();
        setupEventListeners();
        setupInfiniteScroll(); // Setup infinite scroll observer
        setActiveTab('accueil-tab');
        
        fetch('proverbs.json')
            .then(res => res.json())
            .then(data => {
                state.proverbs = data.map((p, i) => ({ ...p, id: i, kabyle_norm: normalizeText(p.kabyle), francais_norm: normalizeText(p.francais), theme_norm: normalizeText(p.theme) }));
                state.isCoreDataLoaded = true;
                dom.proverbCount.textContent = `plus de ${state.proverbs.length} proverbes`;
                
                // Proverbe du jour
                const daily = state.proverbs[Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000) % state.proverbs.length] || state.proverbs[0];
                dom.proverbOfTheDayCard.innerHTML = createProverbCardHTML(daily, true);
                
                updateAvailableThemes(state.proverbs);
                if (localStorage.getItem('inzan_theme_filter')) {
                    state.activeTheme = localStorage.getItem('inzan_theme_filter');
                    loadNextChunk(true);
                }
                setTimeout(() => dom.splashScreen.classList.add('hidden'), 500);
            })
            .catch(err => {
                console.error(err);
                dom.resultsContainer.innerHTML = `<div class="p-4 bg-red-100 text-red-800 rounded">Erreur chargement donn√©es: ${err.message}</div>`;
                dom.splashScreen.classList.add('hidden');
            });
    };

    // Helper for infinite scroll
    function setupInfiniteScroll() {
        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting) loadNextChunk(false);
        }, { threshold: 0.1 });
        observer.observe(dom.loaderContainer);
    }

    main();
});
</script>
</body>
</html>
