<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="D√©couvrez et explorez des milliers de proverbes kabyles (Inzan). Une collection interactive de la sagesse populaire de Kabylie.">
    
    <meta name="theme-color" content="#F9F7F3">
    <meta property="og:title" content="Inzan n Teqbaylit">
    <meta property="og:description" content="Tr√©sors de la Sagesse Kabyle avec IA et explications.">
    <meta property="og:type" content="website">

    <link rel="manifest" href="data:application/json,{
        &quot;name&quot;: &quot;Inzan n Teqbaylit&quot;,
        &quot;short_name&quot;: &quot;Inzan&quot;,
        &quot;start_url&quot;: &quot;.&quot;,
        &quot;display&quot;: &quot;standalone&quot;,
        &quot;background_color&quot;: &quot;#F9F7F3&quot;,
        &quot;theme_color&quot;: &quot;#4A7C59&quot;,
        &quot;icons&quot;: [
            { &quot;src&quot;: &quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%23F9F7F3'%3E%3C/rect%3E%3Ctext y='.9em' font-size='90' fill='%234A7C59'%3E%E2%9C%A7%3C/text%3E%3C/svg%3E&quot;, &quot;sizes&quot;: &quot;192x192&quot;, &quot;type&quot;: &quot;image/svg+xml&quot; }
        ]
    }">

    <title>Inzan n Teqbaylit - Tr√©sors de la Sagesse Kabyle</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Ctext y=%22.9em%22 font-size=%2290%22 fill=%22%234A7C59%22%3E%E2%9C%A7%3C/text%3E%3C/svg%3E">

    <style>
        :root {
            --color-bg: #F9F7F3;
            --color-bg-card: #FFFFFF;
            --color-bg-alt: #F0EFEA;
            --color-text: #2D3748;
            --color-text-light: #718096;
            --color-heading: #1A202C;
            --color-primary: #4A7C59;
            --color-primary-light: #E6F2ED;
            --color-secondary: #2F855A;
            --color-accent: #D69E2E;
            --color-border: #E2E8F0;
            --shadow-soft: 0 10px 40px -10px rgba(0,0,0,0.08);
            --font-serif: 'Merriweather', serif;
            --font-sans: 'Plus Jakarta Sans', sans-serif;
        }

        html.dark {
            --color-bg: #111827;
            --color-bg-card: #1F2937;
            --color-bg-alt: #374151;
            --color-text: #E5E7EB;
            --color-text-light: #9CA3AF;
            --color-heading: #F9FAFB;
            --color-primary: #68D391;
            --color-primary-light: #064E3B;
            --color-secondary: #48BB78;
            --color-accent: #F6E05E;
            --color-border: #374151;
            --shadow-soft: 0 10px 40px -10px rgba(0,0,0,0.5);
        }

        body {
            background-color: var(--color-bg);
            font-family: var(--font-sans);
            color: var(--color-text);
            /* Motif subtil de fond */
            background-image: radial-gradient(circle at 1px 1px, var(--color-border) 1px, transparent 0);
            background-size: 40px 40px;
            transition: background-color 0.3s ease, color 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }

        /* Classes Utilitaires Personnalis√©es */
        .glass-panel {
            background: rgba(var(--color-bg-card-rgb), 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--color-border);
        }
        
        .card-hover {
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-soft);
        }

        .kabyle-text {
            font-family: var(--font-serif);
            line-height: 1.5;
        }

        /* Animations */
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .animate-in {
            animation: fadeInScale 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
        }

        /* Scrollbar masqu√©e mais fonctionnelle */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Loader Skeleton */
        .skeleton {
            background: linear-gradient(90deg, var(--color-bg-alt) 25%, var(--color-border) 50%, var(--color-bg-alt) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Navigation */
        .nav-item.active {
            color: var(--color-primary);
            background-color: var(--color-primary-light);
            font-weight: 600;
        }
        html.dark .nav-item.active {
            background-color: rgba(16, 185, 129, 0.1);
        }

        /* Loader Spinner */
        .loader {
            width: 20px; height: 20px;
            border: 2px solid var(--color-primary);
            border-bottom-color: transparent;
            border-radius: 50%;
            animation: rotation 1s linear infinite;
            display: inline-block;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Toast & Modal */
        #toast { transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        
        /* Splash Screen */
        #splash-screen { transition: opacity 0.6s ease-out, visibility 0.6s; }
        
        .theme-gradient-text {
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            background-image: linear-gradient(135deg, var(--color-primary), var(--color-accent));
        }

        /* Custom Selection */
        ::selection { background: var(--color-primary); color: white; }
    </style>
</head>
<body class="pb-24 sm:pb-12 min-h-screen flex flex-col">

    <div id="splash-screen" class="fixed inset-0 bg-[var(--color-bg)] z-[200] flex flex-col items-center justify-center">
        <div class="relative mb-4">
            <div class="absolute inset-0 bg-[var(--color-primary)] blur-2xl opacity-20 rounded-full"></div>
            <svg width="80" height="80" viewBox="0 0 100 100" class="relative text-[var(--color-primary)] animate-bounce">
                <text x="50" y="80" font-size="80" text-anchor="middle" fill="currentColor" font-weight="bold">‚µ£</text>
            </svg>
        </div>
        <h1 class="text-3xl font-serif font-bold text-[var(--color-heading)] tracking-wide">Inzan</h1>
        <p class="text-[var(--color-text-light)] mt-2 animate-pulse">Chargement de la sagesse...</p>
    </div>

    <nav class="hidden sm:block sticky top-4 z-40 max-w-2xl mx-auto">
        <div class="mx-4 bg-[var(--color-bg-card)]/90 backdrop-blur-md border border-[var(--color-border)] rounded-full shadow-lg px-2 py-2 flex justify-between items-center">
            <div class="flex space-x-1 w-full">
                <button data-tab="accueil-tab" class="nav-item flex-1 py-2.5 px-4 rounded-full text-sm transition-all duration-200 flex items-center justify-center gap-2 hover:bg-[var(--color-bg-alt)]">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                    Accueil
                </button>
                <button data-tab="explorer-tab" class="nav-item flex-1 py-2.5 px-4 rounded-full text-sm transition-all duration-200 flex items-center justify-center gap-2 hover:bg-[var(--color-bg-alt)]">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    Explorer
                </button>
                <button data-tab="ai-sage-tab" class="nav-item flex-1 py-2.5 px-4 rounded-full text-sm transition-all duration-200 flex items-center justify-center gap-2 hover:bg-[var(--color-bg-alt)]">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    Sage AI
                </button>
                <button data-tab="favoris-tab" class="nav-item flex-1 py-2.5 px-4 rounded-full text-sm transition-all duration-200 flex items-center justify-center gap-2 hover:bg-[var(--color-bg-alt)]">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
                    Favoris
                </button>
                <button data-tab="quiz-tab" class="nav-item flex-1 py-2.5 px-4 rounded-full text-sm transition-all duration-200 flex items-center justify-center gap-2 hover:bg-[var(--color-bg-alt)]">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                    Quiz
                </button>
            </div>
        </div>
    </nav>

    <div class="max-w-5xl mx-auto w-full px-4 pt-8 sm:pt-8">
        
        <header class="text-center mb-10 relative">
            <button id="theme-toggle" class="absolute top-0 right-0 p-3 rounded-full bg-[var(--color-bg-card)] shadow-sm hover:shadow-md transition-all text-[var(--color-text)]" aria-label="Changer de th√®me">
                <svg id="icon-sun" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                <svg id="icon-moon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
            </button>
            
            <div class="inline-flex items-center justify-center gap-3 mb-2">
                <span class="text-4xl animate-bounce">‚µ£</span>
            </div>
            <h1 class="text-4xl md:text-5xl font-serif font-bold text-[var(--color-heading)] mb-2">
                Inzan <span class="theme-gradient-text">n Teqbaylit</span>
            </h1>
            <p class="text-[var(--color-text-light)] text-lg">L'h√©ritage de la parole, guid√© par l'intelligence.</p>
        </header>

        <main id="main-content" class="min-h-[60vh]">
            
            <section id="accueil-tab" class="tab-content animate-in">
                <div class="relative overflow-hidden rounded-2xl bg-[var(--color-bg-card)] border border-[var(--color-border)] shadow-soft mb-8 group hover:shadow-lg transition-all duration-300">
                    <div class="absolute top-0 left-0 w-1 h-full bg-[var(--color-accent)]"></div>
                    <div class="absolute -right-10 -top-10 text-[var(--color-bg-alt)] opacity-50 transform rotate-12">
                        <svg width="200" height="200" viewBox="0 0 24 24" fill="currentColor"><path d="M10 3.066c.823-.447 1.867.04 2.058.958.775 3.717 4.02 6.476 7.942 6.476v2c-4.803 0-8.885-3.308-9.916-7.925C9.87 3.55 8.94 3.622 8.94 3.622c-1.29 5.717-6.287 10.878-9.94 10.878v-2c2.893 0 6.73-3.716 8.204-8.358.387-1.217 1.47-1.457 2.8-.976z"/></svg>
                    </div>
                    
                    <div class="p-6 sm:p-10 relative z-10 text-center">
                        <div class="inline-block px-3 py-1 mb-4 text-xs font-bold tracking-wider text-[var(--color-accent)] uppercase bg-[var(--color-accent)]/10 rounded-full">
                            Proverbe du Jour
                        </div>
                        <div id="proverb-of-the-day-card" class="flex flex-col items-center">
                            <div class="skeleton h-8 w-3/4 mb-4 rounded"></div>
                            <div class="skeleton h-4 w-1/2 rounded"></div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-[var(--color-primary)]/5 border border-[var(--color-primary)]/10 rounded-xl p-6 flex items-start gap-4">
                        <div class="bg-[var(--color-primary)]/20 p-3 rounded-lg text-[var(--color-primary)]">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-[var(--color-heading)]">Collection Riche</h3>
                            <p class="text-sm text-[var(--color-text-light)] mt-1">Une base de donn√©es de <strong id="proverb-count" class="text-[var(--color-primary)]">...</strong> proverbes, num√©ris√©s pour la pr√©servation de notre langue.</p>
                        </div>
                    </div>
                    <div class="bg-[var(--color-accent)]/5 border border-[var(--color-accent)]/10 rounded-xl p-6 flex items-start gap-4">
                        <div class="bg-[var(--color-accent)]/20 p-3 rounded-lg text-[var(--color-accent)]">
                           <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-[var(--color-heading)]">Intelligence Artificielle</h3>
                            <p class="text-sm text-[var(--color-text-light)] mt-1">Utilisez notre "Sage Artificiel" pour trouver le proverbe parfait pour chaque situation ou g√©n√©rer des quiz.</p>
                        </div>
                    </div>
                </div>
            </section>

            <section id="explorer-tab" class="tab-content hidden">
                <div class="sticky top-4 z-30 mb-6">
                    <div class="bg-[var(--color-bg-card)]/90 backdrop-blur-lg border border-[var(--color-border)] rounded-xl shadow-lg p-2 sm:p-3">
                        <div class="flex gap-2 mb-3">
                            <div class="relative flex-grow group">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-[var(--color-text-light)] group-focus-within:text-[var(--color-primary)] transition-colors">
                                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                                </div>
                                <input type="text" id="search-input" placeholder="Chercher un mot, un th√®me..." class="block w-full pl-10 pr-10 py-3 bg-[var(--color-bg-alt)] border-none rounded-lg focus:ring-2 focus:ring-[var(--color-primary)] focus:bg-[var(--color-bg-card)] transition-all placeholder-gray-400 text-[var(--color-text)] font-medium">
                                <button class="clear-search-btn absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 opacity-0 transition-opacity">
                                    <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>
                                </button>
                            </div>
                            <button id="random-btn" class="bg-[var(--color-accent)] hover:bg-yellow-500 text-white px-4 sm:px-6 rounded-lg font-bold shadow-md transition-transform active:scale-95 flex items-center justify-center" aria-label="Al√©atoire">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                            </button>
                        </div>
                        
                        <div class="relative">
                            <div class="absolute left-0 top-0 bottom-0 w-8 bg-gradient-to-r from-[var(--color-bg-card)] to-transparent z-10 pointer-events-none"></div>
                            <div class="absolute right-0 top-0 bottom-0 w-8 bg-gradient-to-l from-[var(--color-bg-card)] to-transparent z-10 pointer-events-none"></div>
                            <div id="theme-list-container" class="flex overflow-x-auto gap-2 py-1 px-2 no-scrollbar scroll-smooth">
                                <div class="skeleton h-8 w-20 rounded-full flex-shrink-0"></div>
                                <div class="skeleton h-8 w-24 rounded-full flex-shrink-0"></div>
                                <div class="skeleton h-8 w-16 rounded-full flex-shrink-0"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="results-feedback" class="h-6 mb-4 text-center text-sm text-[var(--color-text-light)] font-medium"></div>

                <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 gap-5 pb-10">
                    <div id="initial-load-message" class="col-span-1 md:col-span-2 flex flex-col items-center justify-center py-20 text-[var(--color-text-light)] opacity-60">
                        <svg class="w-16 h-16 mb-4 text-[var(--color-border)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                        <p class="text-lg">Commencez √† taper ou choisissez un th√®me.</p>
                    </div>
                </div>

                <div id="infinite-scroll-loader" class="hidden py-8 text-center">
                     <div class="loader"></div>
                </div>

                <div id="no-results" class="hidden text-center py-12">
                    <div class="bg-[var(--color-bg-card)] rounded-full p-4 inline-block mb-4 shadow-sm">
                        <span class="text-4xl">ü§î</span>
                    </div>
                    <h3 class="text-xl font-bold text-[var(--color-heading)]">Aucun r√©sultat</h3>
                    <p class="text-[var(--color-text-light)] mt-2">Essayez un autre mot-cl√© ou retirez les filtres.</p>
                </div>
            </section>

            <section id="ai-sage-tab" class="tab-content hidden">
                <div class="max-w-2xl mx-auto">
                    <div class="bg-[var(--color-bg-card)] border border-[var(--color-border)] rounded-2xl shadow-lg overflow-hidden">
                        <div class="p-6 bg-gradient-to-br from-[var(--color-primary)]/10 to-transparent border-b border-[var(--color-border)]">
                            <div class="flex items-center gap-3">
                                <div class="bg-[var(--color-primary)] text-white p-2 rounded-lg shadow-md">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg>
                                </div>
                                <div>
                                    <h2 class="text-xl font-bold text-[var(--color-heading)]">Le Sage Artificiel</h2>
                                    <p class="text-xs text-[var(--color-text-light)]">Propuls√© par Gemini AI</p>
                                </div>
                            </div>
                        </div>

                        <div class="p-6">
                            <div class="mb-6 relative">
                                <label for="ai-context-input" class="block text-sm font-semibold text-[var(--color-text)] mb-2">Quelle est votre situation ?</label>
                                <textarea id="ai-context-input" rows="3" class="w-full p-4 bg-[var(--color-bg-alt)] border border-transparent rounded-xl focus:bg-[var(--color-bg-card)] focus:ring-2 focus:ring-[var(--color-primary)] transition-all resize-none text-base" placeholder="Ex: Mon ami me promet des choses mais ne les fait jamais..."></textarea>
                            </div>

                            <button id="ai-suggest-btn" class="w-full py-3 px-6 bg-[var(--color-heading)] text-[var(--color-bg)] font-bold rounded-xl hover:shadow-lg hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed">
                                <span>‚ú® Demander conseil au Sage</span>
                            </button>

                            <div id="ai-step-feedback" class="mt-4 text-center text-xs text-[var(--color-primary)] font-mono min-h-[20px] transition-all"></div>
                        </div>
                    </div>

                    <div id="ai-result-feedback" class="mt-8 space-y-4 animate-in"></div>
                </div>
            </section>

            <section id="favoris-tab" class="tab-content hidden">
                <h2 class="text-2xl font-serif font-bold text-[var(--color-heading)] mb-6 px-2 border-l-4 border-[var(--color-primary)] pl-4">Vos proverbes gard√©s</h2>
                <div id="favorites-container" class="grid grid-cols-1 md:grid-cols-2 gap-5"></div>
                <div id="no-favorites" class="hidden text-center py-16 bg-[var(--color-bg-card)] rounded-2xl border border-dashed border-[var(--color-border)]">
                    <p class="text-[var(--color-text-light)] mb-4">Votre collection est vide pour le moment.</p>
                    <button id="go-to-explorer-btn" class="text-[var(--color-primary)] font-bold hover:underline">Explorer la biblioth√®que</button>
                </div>
            </section>

            <section id="quiz-tab" class="tab-content hidden">
                <div id="quiz-container" class="max-w-2xl mx-auto bg-[var(--color-bg-card)] rounded-2xl shadow-lg border border-[var(--color-border)] p-6 sm:p-8 min-h-[400px] flex flex-col justify-center">
                     <div class="text-center">
                        <div class="loader text-[var(--color-text-light)]"></div>
                        <p class="mt-4 text-sm text-[var(--color-text-light)]">Pr√©paration du d√©fi...</p>
                    </div>
                </div>
            </section>

        </main>

        <footer class="mt-16 text-center text-sm text-[var(--color-text-light)] border-t border-[var(--color-border)] pt-8 pb-20 sm:pb-8">
            <p>¬© 2025 Inzan n Teqbaylit. D√©velopp√© avec ‚ù§Ô∏è par TAMAZIRT Boussad.</p>
            <button id="about-btn" class="mt-2 text-[var(--color-primary)] hover:underline text-xs">√Ä propos de la source</button>
        </footer>
    </div>

    <nav class="sm:hidden fixed bottom-0 left-0 right-0 z-50 bg-[var(--color-bg-card)]/95 backdrop-blur-xl border-t border-[var(--color-border)] pb-safe">
        <div class="flex justify-around items-center h-16 px-2">
            <button data-tab="accueil-tab" class="nav-item mobile w-full h-full flex flex-col items-center justify-center text-[var(--color-text-light)] gap-1">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                <span class="text-[10px] font-medium">Accueil</span>
            </button>
            <button data-tab="explorer-tab" class="nav-item mobile w-full h-full flex flex-col items-center justify-center text-[var(--color-text-light)] gap-1">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <span class="text-[10px] font-medium">Explorer</span>
            </button>
            <button data-tab="ai-sage-tab" class="nav-item mobile w-full h-full flex flex-col items-center justify-center text-[var(--color-text-light)] gap-1">
                <div class="bg-[var(--color-heading)] text-[var(--color-bg)] rounded-xl p-1 mb-1 shadow-md transform -translate-y-1">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                </div>
            </button>
            <button data-tab="favoris-tab" class="nav-item mobile w-full h-full flex flex-col items-center justify-center text-[var(--color-text-light)] gap-1">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
                <span class="text-[10px] font-medium">Favoris</span>
            </button>
            <button data-tab="quiz-tab" class="nav-item mobile w-full h-full flex flex-col items-center justify-center text-[var(--color-text-light)] gap-1">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                <span class="text-[10px] font-medium">Quiz</span>
            </button>
        </div>
    </nav>

    <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-gray-900 text-white py-3 px-6 rounded-full shadow-xl opacity-0 pointer-events-none z-[60] flex items-center gap-3 min-w-[200px] justify-center">
        <p class="text-sm font-medium">Notification</p>
    </div>

    <div id="modal-backdrop" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[100] opacity-0 pointer-events-none transition-opacity duration-300"></div>
    <div id="modal-content" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-2xl max-h-[80vh] bg-[var(--color-bg-card)] rounded-2xl shadow-2xl z-[101] opacity-0 scale-95 pointer-events-none transition-all duration-300 flex flex-col border border-[var(--color-border)]">
        <header class="flex justify-between items-center p-5 border-b border-[var(--color-border)]">
            <h2 id="modal-title" class="text-xl font-bold font-serif text-[var(--color-heading)]">Titre</h2>
            <button id="modal-close-btn" class="p-2 rounded-full hover:bg-[var(--color-bg-alt)] text-[var(--color-text-light)]">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </header>
        <div id="modal-body" class="p-6 overflow-y-auto text-[var(--color-text)] leading-relaxed"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION & VARIABLES ---
            const CONFIG = {
                GEMINI_API_KEY: "AIzaSyD3cGyEYYhNbFN6WlMKb5wjpdDqfR8RaN4", // Note: √Ä s√©curiser cot√© serveur en prod id√©alement
                PROVERBS_PER_PAGE: 40,
                ANIMATION_DELAY: 30
            };

            const dom = {
                html: document.documentElement,
                splashScreen: document.getElementById('splash-screen'),
                navButtons: document.querySelectorAll('.nav-item'),
                tabContents: document.querySelectorAll('.tab-content'),
                searchInput: document.getElementById('search-input'),
                clearSearchBtn: document.querySelector('.clear-search-btn'),
                resultsContainer: document.getElementById('results-container'),
                themeListContainer: document.getElementById('theme-list-container'),
                loaderContainer: document.getElementById('infinite-scroll-loader'),
                proverbOfTheDayCard: document.getElementById('proverb-of-the-day-card'),
                modal: {
                    backdrop: document.getElementById('modal-backdrop'),
                    content: document.getElementById('modal-content'),
                    title: document.getElementById('modal-title'),
                    body: document.getElementById('modal-body'),
                    closeBtn: document.getElementById('modal-close-btn')
                },
                toast: document.getElementById('toast'),
                themeToggle: document.getElementById('theme-toggle'),
                ai: {
                    input: document.getElementById('ai-context-input'),
                    btn: document.getElementById('ai-suggest-btn'),
                    step: document.getElementById('ai-step-feedback'),
                    result: document.getElementById('ai-result-feedback')
                },
                quizContainer: document.getElementById('quiz-container')
            };

            const state = {
                proverbs: [],
                filteredProverbs: [],
                favorites: new Set(JSON.parse(localStorage.getItem('inzan_favorites')) || []),
                activeTheme: localStorage.getItem('inzan_theme_filter') || 'tous',
                currentPage: 0,
                isLoading: false,
                isDataLoaded: false,
                aiQuiz: { questions: [], current: 0, score: 0, loading: false, promise: null }
            };

            // --- INITIALISATION ---
            const init = async () => {
                applyTheme(localStorage.getItem('inzan_theme') || 'light');
                setupEventListeners();
                
                try {
                    const response = await fetch('proverbs.json');
                    if (!response.ok) throw new Error('Erreur r√©seau');
                    const data = await response.json();
                    
                    state.proverbs = data.map((p, i) => ({
                        ...p,
                        id: i,
                        searchString: `${normalize(p.kabyle)} ${normalize(p.francais)} ${normalize(p.theme)}`
                    }));
                    state.isDataLoaded = true;
                    
                    updateUIWithData();
                    // Pr√©chargement silencieux du quiz
                    preloadQuiz();
                    
                    setTimeout(() => {
                        dom.splashScreen.style.opacity = '0';
                        dom.splashScreen.style.visibility = 'hidden';
                    }, 800);

                } catch (err) {
                    console.error("Erreur fatale:", err);
                    dom.splashScreen.innerHTML = `<p class="text-red-500 font-bold">Erreur de chargement des donn√©es.</p>`;
                }
            };

            const updateUIWithData = () => {
                document.getElementById('proverb-count').textContent = state.proverbs.length;
                renderThemes();
                loadDailyProverb();
                
                // Si un th√®me √©tait d√©j√† s√©lectionn√©, charger les r√©sultats
                if (state.activeTheme !== 'tous') {
                   dom.searchInput.value = ''; // Reset search if filter applies
                   filterAndRender(true);
                }
            };

            // --- LOGIQUE UI ---
            const createCardHTML = (proverb, isDaily = false) => {
                const isFav = state.favorites.has(proverb.id);
                const themeBadge = proverb.theme ? `<span class="inline-block px-2 py-0.5 bg-[var(--color-bg-alt)] text-[10px] font-bold text-[var(--color-text-light)] uppercase tracking-wider rounded-md mb-2">${proverb.theme}</span>` : '';
                
                if (isDaily) {
                    return `
                        <div class="text-center animate-in">
                            <p class="text-2xl md:text-3xl kabyle-text font-bold text-[var(--color-heading)] mb-4">¬´ ${proverb.kabyle} ¬ª</p>
                            <p class="text-lg text-[var(--color-text)] italic font-light mb-6">"${proverb.francais}"</p>
                            <div class="flex justify-center gap-3">
                                <button onclick="explainProverb(${proverb.id})" class="px-4 py-2 bg-[var(--color-primary)] text-white rounded-full text-sm font-bold shadow-md hover:scale-105 transition-transform">D√©crypter le sens</button>
                                <button onclick="toggleFavorite(${proverb.id})" class="p-2 rounded-full bg-[var(--color-bg-alt)] hover:bg-pink-50 text-${isFav ? 'pink-500' : 'gray-400'} transition-colors">
                                    <svg class="w-5 h-5" fill="${isFav ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
                                </button>
                            </div>
                        </div>
                    `;
                }

                return `
                    <div class="card-hover bg-[var(--color-bg-card)] border border-[var(--color-border)] p-5 rounded-xl flex flex-col h-full relative group" data-id="${proverb.id}">
                        ${themeBadge}
                        <blockquote class="kabyle-text text-xl font-bold text-[var(--color-heading)] mb-3 flex-grow relative z-10">
                            ¬´ ${highlight(proverb.kabyle)} ¬ª
                        </blockquote>
                        <p class="text-[var(--color-text-light)] text-sm mb-4 pb-4 border-b border-[var(--color-border)]">
                            ${highlight(proverb.francais)}
                        </p>
                        <div class="flex justify-between items-center mt-auto">
                            <button onclick="explainProverb(${proverb.id})" class="text-xs font-bold text-[var(--color-primary)] flex items-center gap-1 hover:underline">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                Explication
                            </button>
                            <div class="flex gap-1">
                                <button onclick="copyProverb(${proverb.id})" class="p-2 rounded-lg hover:bg-[var(--color-bg-alt)] text-[var(--color-text-light)]" title="Copier">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                                </button>
                                <button onclick="toggleFavorite(${proverb.id}, this)" class="p-2 rounded-lg hover:bg-pink-50 text-${isFav ? 'pink-500' : 'gray-300'} transition-colors" title="Favoris">
                                    <svg class="w-5 h-5" fill="${isFav ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            };

            const getSkeletonCards = (count = 4) => {
                return Array(count).fill(0).map(() => `
                    <div class="bg-[var(--color-bg-card)] border border-[var(--color-border)] p-5 rounded-xl h-40 flex flex-col justify-between">
                        <div class="skeleton h-4 w-20 rounded mb-4"></div>
                        <div class="skeleton h-6 w-full rounded mb-2"></div>
                        <div class="skeleton h-6 w-2/3 rounded mb-4"></div>
                        <div class="flex justify-between mt-auto pt-4 border-t border-[var(--color-border)]">
                            <div class="skeleton h-4 w-20 rounded"></div>
                            <div class="skeleton h-6 w-6 rounded-full"></div>
                        </div>
                    </div>
                `).join('');
            };

            const filterAndRender = (reset = false) => {
                if (reset) {
                    state.currentPage = 0;
                    state.filteredProverbs = [];
                    dom.resultsContainer.innerHTML = getSkeletonCards(6); // Show skeleton
                    document.getElementById('initial-load-message').classList.add('hidden');
                    document.getElementById('no-results').classList.add('hidden');
                }

                // Logique de filtrage
                const query = normalize(dom.searchInput.value);
                const theme = state.activeTheme;

                // On ne filtre que si c'est un reset, sinon on a d√©j√† la liste filtr√©e
                if (reset) {
                    state.filteredProverbs = state.proverbs.filter(p => {
                        const matchesTheme = theme === 'tous' || normalize(p.theme).includes(theme);
                        const matchesQuery = !query || p.searchString.includes(query);
                        return matchesTheme && matchesQuery;
                    });
                }

                const start = state.currentPage * CONFIG.PROVERBS_PER_PAGE;
                const end = start + CONFIG.PROVERBS_PER_PAGE;
                const chunk = state.filteredProverbs.slice(start, end);

                if (reset) dom.resultsContainer.innerHTML = ''; // Clear skeleton

                if (state.filteredProverbs.length === 0) {
                    document.getElementById('no-results').classList.remove('hidden');
                    dom.resultsContainer.innerHTML = '';
                } else {
                    const html = chunk.map((p, i) => {
                        const el = createCardHTML(p);
                        // Ajout d'un d√©lai pour l'animation en cascade
                        return el.replace('card-hover', `card-hover animate-in" style="animation-delay: ${i * 50}ms`);
                    }).join('');
                    dom.resultsContainer.insertAdjacentHTML('beforeend', html);
                    state.currentPage++;
                }

                dom.loaderContainer.classList.toggle('hidden', end >= state.filteredProverbs.length);
            };

            // --- GESTION DES TH√àMES ET UI ---
            const renderThemes = () => {
                const themes = [...new Set(state.proverbs.flatMap(p => p.theme ? p.theme.split(',').map(t=>t.trim()) : []))].sort();
                let html = `<button data-theme="tous" class="px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors ${state.activeTheme === 'tous' ? 'bg-[var(--color-heading)] text-[var(--color-bg)]' : 'bg-[var(--color-bg-card)] border border-[var(--color-border)] hover:border-[var(--color-primary)]'}">Tous</button>`;
                
                themes.forEach(t => {
                    const norm = normalize(t);
                    const isActive = state.activeTheme === norm;
                    html += `<button data-theme="${norm}" class="px-4 py-2 rounded-full text-sm font-bold whitespace-nowrap transition-colors ${isActive ? 'bg-[var(--color-heading)] text-[var(--color-bg)]' : 'bg-[var(--color-bg-card)] border border-[var(--color-border)] hover:border-[var(--color-primary)]'}">${t.charAt(0).toUpperCase() + t.slice(1)}</button>`;
                });
                dom.themeListContainer.innerHTML = html;
            };

            // --- NAVIGATION & EVENTS ---
            const setupEventListeners = () => {
                // Onglets
                dom.navButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const targetTab = btn.dataset.tab || e.currentTarget.dataset.tab;
                        switchTab(targetTab);
                    });
                });

                // Recherche
                dom.searchInput.addEventListener('input', debounce(() => {
                    dom.clearSearchBtn.style.opacity = dom.searchInput.value ? '1' : '0';
                    filterAndRender(true);
                }, 300));

                dom.clearSearchBtn.addEventListener('click', () => {
                    dom.searchInput.value = '';
                    dom.clearSearchBtn.style.opacity = '0';
                    filterAndRender(true);
                });

                // Filtres Th√®mes
                dom.themeListContainer.addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON') {
                        state.activeTheme = e.target.dataset.theme;
                        localStorage.setItem('inzan_theme_filter', state.activeTheme);
                        renderThemes(); // Re-render to update active class
                        dom.searchInput.value = ''; // Clear search text on theme switch usually implies reset
                        switchTab('explorer-tab'); // Ensure we are on explorer
                        filterAndRender(true);
                    }
                });
                
                // Infinite Scroll
                const observer = new IntersectionObserver(entries => {
                    if(entries[0].isIntersecting) filterAndRender(false);
                }, { rootMargin: '100px' });
                observer.observe(dom.loaderContainer);

                // Bouton Al√©atoire
                document.getElementById('random-btn').addEventListener('click', () => {
                    dom.searchInput.value = '';
                    state.activeTheme = 'tous';
                    renderThemes();
                    state.filteredProverbs = state.proverbs.sort(() => 0.5 - Math.random());
                    state.currentPage = 0;
                    dom.resultsContainer.innerHTML = '';
                    filterAndRender(false); // Render first chunk of shuffled
                });

                // Dark Mode
                dom.themeToggle.addEventListener('click', () => {
                    const isDark = dom.html.classList.toggle('dark');
                    applyTheme(isDark ? 'dark' : 'light');
                });

                // AI & Quiz
                dom.ai.btn.addEventListener('click', handleAIRequest);
                
                // Modal & Globals
                dom.modal.closeBtn.addEventListener('click', closeModal);
                dom.modal.backdrop.addEventListener('click', closeModal);
                
                // Exposer les fonctions globales pour les onclick HTML
                window.explainProverb = getAIExplanation;
                window.toggleFavorite = toggleFavorite;
                window.copyProverb = copyProverb;
            };

            const switchTab = (tabId) => {
                window.scrollTo({top: 0, behavior: 'smooth'});
                dom.tabContents.forEach(el => el.classList.add('hidden'));
                document.getElementById(tabId).classList.remove('hidden');
                
                dom.navButtons.forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === tabId);
                    // Gestion ic√¥ne active mobile
                    if(btn.classList.contains('mobile')) {
                        btn.style.color = btn.dataset.tab === tabId ? 'var(--color-primary)' : '';
                    }
                });

                if (tabId === 'favoris-tab') renderFavorites();
                if (tabId === 'quiz-tab') startQuizUI();
            };

            // --- FONCTIONS AI (GEMINI) ---
            async function callGemini(prompt, isJson = false) {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${CONFIG.GEMINI_API_KEY}`;
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: isJson ? { responseMimeType: "application/json" } : {}
                };

                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                if (!res.ok) throw new Error('API Limit or Error');
                const data = await res.json();
                const text = data.candidates[0].content.parts[0].text;
                return isJson ? JSON.parse(text) : text;
            }

            async function handleAIRequest() {
                const ctx = dom.ai.input.value.trim();
                if(!ctx) return showToast("D√©crivez d'abord une situation", true);
                
                dom.ai.btn.disabled = true;
                dom.ai.btn.innerHTML = '<span class="loader border-white w-4 h-4 mr-2"></span> R√©flexion...';
                dom.ai.step.textContent = "Analyse s√©mantique en cours...";

                try {
                    // Etape 1 : Mots cl√©s
                    const keywordPrompt = `Situation: "${ctx}". Donne-moi un objet JSON { "keywords": ["mot1", "mot2", "mot3"] } (fran√ßais ou kabyle) pour trouver des proverbes kabyles li√©s.`;
                    const { keywords } = await callGemini(keywordPrompt, true);
                    
                    dom.ai.step.textContent = `Recherche locale : ${keywords.join(', ')}`;
                    
                    // Etape 2 : Filtrage local
                    const candidates = state.proverbs.filter(p => 
                        keywords.some(k => p.searchString.includes(normalize(k)))
                    ).slice(0, 20); // Top 20

                    if(candidates.length === 0) throw new Error("Aucun proverbe trouv√© localement.");

                    // Etape 3 : S√©lection finale
                    dom.ai.step.textContent = "Le sage s√©lectionne le meilleur proverbe...";
                    const selectionPrompt = `Context: "${ctx}". Liste: ${JSON.stringify(candidates.map(c => ({id:c.id, k:c.kabyle, f:c.francais})))}. Choisis le ou les meilleurs (max 2). JSON: { "response": "Phrase de sage", "matches": [{ "id": 123, "reason": "Pourquoi" }] }`;
                    
                    const final = await callGemini(selectionPrompt, true);
                    
                    let html = `<div class="bg-[var(--color-primary)]/10 p-4 rounded-lg mb-6 border-l-4 border-[var(--color-primary)]"><p class="italic text-[var(--color-heading)] font-serif">"${final.response}"</p></div>`;
                    
                    final.matches.forEach(m => {
                        const p = state.proverbs.find(x => x.id === m.id);
                        if(p) {
                            html += createCardHTML(p).replace('bg-[var(--color-bg-card)]', 'bg-white dark:bg-gray-800 shadow-lg transform scale-100 mb-4');
                            html += `<p class="text-sm text-[var(--color-text-light)] mt-2 mb-6 px-4">üí° ${m.reason}</p>`;
                        }
                    });
                    
                    dom.ai.result.innerHTML = html;

                } catch (e) {
                    dom.ai.result.innerHTML = `<p class="text-red-500 text-center">Le sage est confus. Essayez de reformuler. (${e.message})</p>`;
                } finally {
                    dom.ai.btn.disabled = false;
                    dom.ai.btn.innerHTML = '‚ú® Demander conseil au Sage';
                    dom.ai.step.textContent = '';
                }
            }

            async function getAIExplanation(id) {
                const p = state.proverbs.find(x => x.id === id);
                openModal("D√©cryptage", `<div class="flex justify-center py-10"><div class="loader"></div></div>`);
                
                try {
                    const explanation = await callGemini(`Explique ce proverbe kabyle de fa√ßon culturelle et concise. Utilise le format Markdown. Proverbe: "${p.kabyle}" (${p.francais})`);
                    // Convert simple markdown to HTML
                    const html = explanation
                        .replace(/^### (.*$)/gim, '<h3 class="text-lg font-bold text-[var(--color-primary)] mt-4 mb-2">$1</h3>')
                        .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
                        .replace(/\n/g, '<br>');
                    
                    document.getElementById('modal-body').innerHTML = `
                        <div class="text-center mb-6 p-4 bg-[var(--color-bg-alt)] rounded-xl">
                            <p class="font-serif font-bold text-xl mb-2">¬´ ${p.kabyle} ¬ª</p>
                            <p class="text-sm text-[var(--color-text-light)]">${p.francais}</p>
                        </div>
                        <div class="prose dark:prose-invert max-w-none text-sm sm:text-base">
                            ${html}
                        </div>
                    `;
                } catch (e) {
                    document.getElementById('modal-body').innerHTML = `<p class="text-red-500">Erreur de connexion au Sage.</p>`;
                }
            }

            // --- QUIZ LOGIC ---
            async function preloadQuiz() {
               if(state.aiQuiz.promise) return state.aiQuiz.promise;
               
               state.aiQuiz.promise = (async () => {
                   const sample = state.proverbs.sort(()=>0.5-Math.random()).slice(0, 15).map(p=>({k:p.kabyle, f:p.francais}));
                   const prompt = `G√©n√®re 5 questions QCM JSON bas√©es sur ces proverbes: ${JSON.stringify(sample)}. Format: { "questions": [{ "q": "Question text", "opts": ["A", "B", "C"], "idx": 0, "exp": "Explanation" }] }`;
                   const data = await callGemini(prompt, true);
                   state.aiQuiz.questions = data.questions;
               })();
               return state.aiQuiz.promise;
            }

            async function startQuizUI() {
                dom.quizContainer.innerHTML = `<div class="text-center"><div class="loader"></div><p class="mt-2 text-sm opacity-70">Pr√©paration...</p></div>`;
                try {
                    await preloadQuiz();
                    state.aiQuiz.current = 0;
                    state.aiQuiz.score = 0;
                    renderQuestion();
                } catch(e) {
                    dom.quizContainer.innerHTML = `<p class="text-center text-red-500">Erreur de g√©n√©ration du quiz.</p><button onclick="location.reload()" class="mt-4 btn-primary">R√©essayer</button>`;
                }
            }

            function renderQuestion() {
                const q = state.aiQuiz.questions[state.aiQuiz.current];
                if(!q) return showQuizResults();

                dom.quizContainer.innerHTML = `
                    <div class="mb-6 flex justify-between items-center">
                        <span class="text-xs font-bold text-[var(--color-text-light)]">QUESTION ${state.aiQuiz.current + 1}/5</span>
                        <span class="text-xs font-bold text-[var(--color-primary)]">SCORE: ${state.aiQuiz.score}</span>
                    </div>
                    <h3 class="text-xl font-serif font-bold text-[var(--color-heading)] mb-6 text-center">${q.q}</h3>
                    <div class="space-y-3">
                        ${q.opts.map((opt, i) => `
                            <button class="quiz-opt w-full p-4 rounded-xl border border-[var(--color-border)] text-left hover:bg-[var(--color-bg-alt)] transition-all font-medium" onclick="handleAnswer(${i})">${opt}</button>
                        `).join('')}
                    </div>
                    <div id="quiz-feedback" class="mt-4 hidden"></div>
                `;
            }

            window.handleAnswer = (idx) => {
                const q = state.aiQuiz.questions[state.aiQuiz.current];
                const isCorrect = idx === q.idx;
                if(isCorrect) state.aiQuiz.score++;
                
                const opts = document.querySelectorAll('.quiz-opt');
                opts.forEach((btn, i) => {
                    btn.disabled = true;
                    if(i === q.idx) btn.classList.add('bg-green-100', 'border-green-500', 'text-green-800');
                    else if(i === idx && !isCorrect) btn.classList.add('bg-red-100', 'border-red-500', 'text-red-800');
                });

                const feedback = document.getElementById('quiz-feedback');
                feedback.classList.remove('hidden');
                feedback.innerHTML = `
                    <div class="p-3 rounded-lg ${isCorrect ? 'bg-green-50 text-green-800' : 'bg-red-50 text-red-800'} mb-3 text-sm">
                        <strong>${isCorrect ? 'Bravo !' : 'Oups...'}</strong> ${q.exp}
                    </div>
                    <button onclick="nextQuestion()" class="w-full py-3 bg-[var(--color-heading)] text-[var(--color-bg)] rounded-lg font-bold">Continuer</button>
                `;
            };

            window.nextQuestion = () => {
                state.aiQuiz.current++;
                renderQuestion();
            };

            function showQuizResults() {
                state.aiQuiz.promise = null; // Reset for new game
                preloadQuiz(); // Preload next game
                dom.quizContainer.innerHTML = `
                    <div class="text-center py-10 animate-in">
                        <div class="text-6xl mb-4">${state.aiQuiz.score >= 3 ? 'üèÜ' : 'üìö'}</div>
                        <h2 class="text-3xl font-bold text-[var(--color-heading)] mb-2">Score: ${state.aiQuiz.score}/5</h2>
                        <p class="text-[var(--color-text-light)] mb-8">${state.aiQuiz.score === 5 ? 'Un vrai sage kabyle !' : 'La sagesse s\'acquiert avec le temps.'}</p>
                        <button onclick="startQuizUI()" class="px-8 py-3 bg-[var(--color-primary)] text-white rounded-full font-bold shadow-lg hover:scale-105 transition-transform">Rejouer</button>
                    </div>
                `;
            }

            // --- UTILITAIRES ---
            function normalize(str) { return str ? str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") : ""; }
            function highlight(text) {
                const q = normalize(dom.searchInput.value).split(' ').filter(x=>x);
                if(!q.length) return text;
                const regex = new RegExp(`(${q.join('|')})`, 'gi');
                return text.replace(regex, '<mark class="bg-[var(--color-accent)] text-[var(--color-heading)] rounded-sm px-0.5">$1</mark>');
            }
            function debounce(func, wait) { let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); }; }
            
            function showToast(msg, isError=false) {
                dom.toast.innerHTML = `<p class="${isError?'text-red-300':'text-green-300'} font-bold mr-2">${isError?'‚úï':'‚úì'}</p> <p>${msg}</p>`;
                dom.toast.style.opacity = '1';
                dom.toast.style.bottom = '100px';
                setTimeout(() => { dom.toast.style.opacity = '0'; dom.toast.style.bottom = '24px'; }, 3000);
            }

            function toggleFavorite(id, btnElement) {
                if(state.favorites.has(id)) {
                    state.favorites.delete(id);
                    showToast("Retir√© des favoris");
                    if(btnElement) btnElement.classList.replace('text-pink-500', 'text-gray-300');
                } else {
                    state.favorites.add(id);
                    showToast("Ajout√© aux favoris");
                    if(btnElement) btnElement.classList.replace('text-gray-300', 'text-pink-500');
                }
                localStorage.setItem('inzan_favorites', JSON.stringify([...state.favorites]));
                if(!document.getElementById('favoris-tab').classList.contains('hidden')) renderFavorites();
            }

            function renderFavorites() {
                const favs = state.proverbs.filter(p => state.favorites.has(p.id));
                const container = document.getElementById('favorites-container');
                if(favs.length === 0) {
                    document.getElementById('no-favorites').classList.remove('hidden');
                    container.innerHTML = '';
                } else {
                    document.getElementById('no-favorites').classList.add('hidden');
                    container.innerHTML = favs.map(p => createCardHTML(p)).join('');
                }
            }

            function copyProverb(id) {
                const p = state.proverbs.find(x => x.id === id);
                navigator.clipboard.writeText(`¬´ ${p.kabyle} ¬ª\n‚Äî ${p.francais}`);
                showToast("Copi√© !");
            }

            function openModal(title, content) {
                dom.modal.title.textContent = title;
                dom.modal.body.innerHTML = content;
                dom.modal.backdrop.style.opacity = '1';
                dom.modal.backdrop.style.pointerEvents = 'auto';
                dom.modal.content.style.opacity = '1';
                dom.modal.content.style.transform = 'translate(-50%, -50%) scale(1)';
                dom.modal.content.style.pointerEvents = 'auto';
            }

            function closeModal() {
                dom.modal.backdrop.style.opacity = '0';
                dom.modal.backdrop.style.pointerEvents = 'none';
                dom.modal.content.style.opacity = '0';
                dom.modal.content.style.transform = 'translate(-50%, -50%) scale(0.95)';
                dom.modal.content.style.pointerEvents = 'none';
            }

            function loadDailyProverb() {
                if(!state.proverbs.length) return;
                const day = Math.floor(new Date() / 86400000);
                const p = state.proverbs[day % state.proverbs.length];
                dom.proverbOfTheDayCard.innerHTML = createCardHTML(p, true);
            }

            function applyTheme(theme) {
                if(theme === 'dark') {
                    dom.html.classList.add('dark');
                    document.getElementById('icon-sun').classList.add('hidden');
                    document.getElementById('icon-moon').classList.remove('hidden');
                    document.querySelector('meta[name="theme-color"]').content = '#111827';
                } else {
                    dom.html.classList.remove('dark');
                    document.getElementById('icon-sun').classList.remove('hidden');
                    document.getElementById('icon-moon').classList.add('hidden');
                    document.querySelector('meta[name="theme-color"]').content = '#F9F7F3';
                }
                localStorage.setItem('inzan_theme', theme);
            }

            init();
        });
    </script>
</body>
</html>
