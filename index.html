<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="D√©couvrez et explorez des milliers de proverbes kabyles (Inzan). Une collection interactive de la sagesse populaire de Kabylie avec IA et Quiz.">
    <meta name="theme-color" content="#F9F7F3">
    
    <meta property="og:title" content="Inzan n Teqbaylit - Sagesse Kabyle">
    <meta property="og:description" content="Explorez des milliers de proverbes kabyles avec l'assistance d'un Sage Artificiel.">
    <meta property="og:type" content="website">
    
    <link rel="manifest" href="data:application/json,{
        &quot;name&quot;: &quot;Inzan n Teqbaylit&quot;,
        &quot;short_name&quot;: &quot;Inzan&quot;,
        &quot;start_url&quot;: &quot;.&quot;,
        &quot;display&quot;: &quot;standalone&quot;,
        &quot;background_color&quot;: &quot;#F9F7F3&quot;,
        &quot;theme_color&quot;: &quot;#4A7C59&quot;,
        &quot;description&quot;: &quot;Tr√©sors de la Sagesse Kabyle&quot;,
        &quot;icons&quot;: [
            { &quot;src&quot;: &quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%23F9F7F3'%3E%3C/rect%3E%3Ctext y='.9em' font-size='90' fill='%234A7C59'%3E%E2%9C%A7%3C/text%3E%3C/svg%3E&quot;, &quot;sizes&quot;: &quot;192x192&quot;, &quot;type&quot;: &quot;image/svg+xml&quot; }
        ]
    }">

    <title>Inzan n Teqbaylit - Sagesse Kabyle</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lora:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Ctext y=%22.9em%22 font-size=%2290%22 fill=%22%234A7C59%22%3E%E2%9C%A7%3C/text%3E%3C/svg%3E">

    <style>
        :root {
            --color-bg: #F9F7F3;
            --color-bg-card: rgba(255, 255, 255, 0.85);
            --color-text: #2D3748;
            --color-text-light: #718096;
            --color-heading: #1A202C;
            --color-primary: #4A7C59; /* Vert Olive Kabyle */
            --color-secondary: #C79A2A; /* Jaune Dor√© Kabyle */
            --color-accent: #D9534F; /* Rouge Tapis */
            --color-border: #E2E8F0;
            --glass-border: rgba(255, 255, 255, 0.5);
            --shadow-soft: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
            --font-display: 'Cinzel', serif;
            --font-body: 'Lora', serif;
            --font-ui: 'Inter', sans-serif;
        }

        html.dark {
            --color-bg: #0F172A;
            --color-bg-card: rgba(30, 41, 59, 0.7);
            --color-text: #E2E8F0;
            --color-text-light: #94A3B8;
            --color-heading: #F8FAFC;
            --color-primary: #68D391;
            --color-secondary: #F6E05E;
            --color-accent: #FC8181;
            --color-border: #334155;
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            background-color: var(--color-bg);
            color: var(--color-text);
            font-family: var(--font-ui);
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
            transition: background-color 0.4s ease, color 0.4s ease;
            -webkit-font-smoothing: antialiased;
        }

        /* Glassmorphism Classes */
        .glass-panel {
            background: var(--color-bg-card);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-soft);
        }

        /* Typography Override */
        h1, h2, h3, .kabyle-text { font-family: var(--font-display); }
        .proverb-text { font-family: var(--font-body); }

        /* Animations */
        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: slideUpFade 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        .nav-btn {
            position: relative;
            transition: all 0.3s ease;
        }
        .nav-btn::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            width: 0;
            height: 2px;
            background: var(--color-primary);
            transition: all 0.3s ease;
            transform: translateX(-50%);
        }
        .nav-btn.active::after { width: 80%; }
        .nav-btn.active { color: var(--color-primary); }
        
        /* Interactive Elements */
        .card-hover {
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: var(--color-primary);
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: var(--color-text-light);
            border-radius: 20px;
            opacity: 0.5;
        }

        /* Loader */
        .loader {
            width: 24px;
            height: 24px;
            border: 3px solid var(--color-border);
            border-bottom-color: var(--color-primary);
            border-radius: 50%;
            display: inline-block;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Utility */
        .text-gradient {
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-image: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: slideUpFade 0.4s ease-out; }

        /* Mobile Nav */
        #mobile-nav { padding-bottom: env(safe-area-inset-bottom); }

        /* Toast */
        #toast { transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col pb-24 sm:pb-0">

    <!-- Splash Screen -->
    <div id="splash-screen" class="fixed inset-0 bg-[var(--color-bg)] z-[200] flex flex-col items-center justify-center transition-opacity duration-700">
        <div class="relative">
            <div class="absolute inset-0 bg-[var(--color-primary)] opacity-20 blur-xl rounded-full animate-pulse"></div>
            <svg width="120" height="120" viewBox="0 0 100 100" class="text-[var(--color-primary)] relative z-10">
                <text x="50" y="70" font-size="80" text-anchor="middle" fill="currentColor" font-family="'Cinzel', serif">‚µ£</text>
            </svg>
        </div>
        <h1 class="text-3xl font-display font-bold text-[var(--color-heading)] mt-6 tracking-widest">INZAN</h1>
        <p class="text-[var(--color-text-light)] mt-2 font-light">Sagesse ancestrale</p>
    </div>

    <!-- Main Container -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 w-full flex-grow flex flex-col">
        
        <!-- Header -->
        <header class="flex justify-between items-center py-6 sm:py-8 relative z-50">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-[var(--color-primary)] to-[var(--color-secondary)] flex items-center justify-center text-white font-display font-bold text-xl shadow-lg">‚µ£</div>
                <div>
                    <h1 class="text-xl sm:text-2xl font-display font-bold text-[var(--color-heading)] leading-none">Inzan</h1>
                    <span class="text-xs text-[var(--color-text-light)] hidden sm:inline-block">Tamazight Wisdom</span>
                </div>
            </div>

            <div class="flex items-center gap-2 sm:gap-4">
                <button id="stats-btn" class="p-2.5 rounded-full glass-panel hover:bg-[var(--color-bg-alt)] transition-colors text-[var(--color-text)] relative group" aria-label="Statistiques">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    <span class="absolute top-0 right-0 w-2.5 h-2.5 bg-[var(--color-secondary)] rounded-full hidden" id="new-stats-dot"></span>
                </button>
                <button id="theme-toggle" class="p-2.5 rounded-full glass-panel hover:bg-[var(--color-bg-alt)] transition-transform hover:rotate-12 text-[var(--color-text)]" aria-label="Th√®me">
                    <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2"/><path d="M12 21v2"/><path d="M4.22 4.22l1.42 1.42"/><path d="M17.36 17.36l1.42 1.42"/><path d="M1 12h2"/><path d="M21 12h2"/><path d="M4.22 19.78l1.42-1.42"/><path d="M17.36 6.64l1.42-1.42"/></svg>
                    <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                </button>
            </div>
        </header>

        <!-- Desktop Navigation -->
        <nav class="hidden sm:flex justify-center mb-10 sticky top-4 z-40">
            <div class="glass-panel rounded-full px-2 py-1.5 flex items-center gap-1 shadow-lg">
                <button data-tab="accueil-tab" class="nav-btn active px-6 py-2.5 rounded-full text-sm font-semibold text-[var(--color-text-light)] hover:text-[var(--color-heading)]">Accueil</button>
                <button data-tab="explorer-tab" class="nav-btn px-6 py-2.5 rounded-full text-sm font-semibold text-[var(--color-text-light)] hover:text-[var(--color-heading)]">Explorer</button>
                <button data-tab="favoris-tab" class="nav-btn px-6 py-2.5 rounded-full text-sm font-semibold text-[var(--color-text-light)] hover:text-[var(--color-heading)]">Favoris</button>
                <button data-tab="ai-sage-tab" class="nav-btn px-6 py-2.5 rounded-full text-sm font-semibold text-[var(--color-text-light)] hover:text-[var(--color-heading)] flex items-center gap-2">
                    <span>Sage AI</span>
                    <span class="bg-[var(--color-primary)] text-white text-[10px] px-1.5 py-0.5 rounded-md font-bold">BETA</span>
                </button>
                <button data-tab="quiz-tab" class="nav-btn px-6 py-2.5 rounded-full text-sm font-semibold text-[var(--color-text-light)] hover:text-[var(--color-heading)]">Quiz</button>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="flex-grow">
            
            <!-- Tab: Accueil -->
            <section id="accueil-tab" class="tab-content active space-y-8">
                <!-- Hero Section -->
                <div class="relative glass-panel rounded-3xl p-8 sm:p-12 overflow-hidden text-center sm:text-left shadow-xl border-t-4 border-[var(--color-primary)]">
                    <div class="absolute top-0 right-0 opacity-10 pointer-events-none transform translate-x-1/3 -translate-y-1/3">
                        <svg width="400" height="400" viewBox="0 0 100 100"><text x="50" y="50" font-size="80" fill="currentColor">‚µ£</text></svg>
                    </div>
                    
                    <div class="relative z-10 max-w-2xl">
                        <span class="inline-block px-3 py-1 rounded-full bg-[var(--color-secondary)]/20 text-[var(--color-secondary)] text-xs font-bold tracking-wider mb-4">LE PROVERBE DU JOUR</span>
                        <div id="proverb-of-the-day-container" class="min-h-[160px] flex flex-col justify-center">
                            <h2 id="pod-kabyle" class="text-3xl sm:text-5xl font-display font-bold text-[var(--color-heading)] mb-4 italic leading-tight">Chargement...</h2>
                            <p id="pod-french" class="text-lg sm:text-xl text-[var(--color-text-light)] proverb-text">...</p>
                        </div>
                        <div class="mt-8 flex flex-wrap gap-4">
                            <button id="pod-explain-btn" class="px-6 py-3 rounded-xl bg-[var(--color-primary)] text-white font-semibold shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all flex items-center gap-2">
                                <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                Analyser ce proverbe
                            </button>
                            <button id="pod-zen-mode" class="px-6 py-3 rounded-xl glass-panel text-[var(--color-text)] font-semibold hover:bg-[var(--color-bg-alt)] transition-all flex items-center gap-2">
                                <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" /></svg>
                                Mode Zen
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Features Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass-panel p-6 rounded-2xl flex items-start gap-4 hover:border-[var(--color-secondary)] transition-colors cursor-pointer" onclick="setActiveTab('explorer-tab')">
                        <div class="p-3 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-xl">
                            <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg mb-1">Explorer la Collection</h3>
                            <p class="text-sm text-[var(--color-text-light)]">Recherchez parmi <span id="count-display" class="font-bold text-[var(--color-primary)]">...</span> proverbes par mot-cl√©, th√®me ou √©motion.</p>
                        </div>
                    </div>
                    
                    <div class="glass-panel p-6 rounded-2xl flex items-start gap-4 hover:border-[var(--color-secondary)] transition-colors cursor-pointer" onclick="setActiveTab('ai-sage-tab')">
                        <div class="p-3 bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 rounded-xl">
                            <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg mb-1">Le Sage Artificiel</h3>
                            <p class="text-sm text-[var(--color-text-light)]">Posez une situation de vie, l'IA trouvera le proverbe ancestral adapt√©.</p>
                        </div>
                    </div>
                </div>

                <!-- Source Credit -->
                <div class="text-center py-6 opacity-60 hover:opacity-100 transition-opacity">
                    <p class="text-sm">Inspir√© de l'≈ìuvre d'Aomar SIDER et des traditions orales.</p>
                </div>
            </section>

            <!-- Tab: Explorer -->
            <section id="explorer-tab" class="tab-content">
                <div class="sticky top-20 sm:top-24 z-30 space-y-4 mb-8">
                    <div class="glass-panel rounded-2xl p-4 shadow-lg">
                         <!-- Keyboard -->
                        <div id="tamazight-keyboard" class="flex gap-1.5 overflow-x-auto pb-3 mb-2 custom-scrollbar -mx-2 px-2 sm:mx-0 sm:px-0">
                            <!-- JS Generated Keys -->
                        </div>

                        <!-- Search Bar -->
                        <div class="flex gap-3">
                            <div class="relative flex-grow">
                                <input type="text" id="search-input" placeholder="Rechercher (ex: argaz, courage...)" class="w-full pl-12 pr-10 py-3 rounded-xl bg-[var(--color-bg)] border border-[var(--color-border)] focus:border-[var(--color-primary)] focus:ring-2 focus:ring-[var(--color-primary)]/20 outline-none transition-all font-ui shadow-inner">
                                <svg class="absolute left-4 top-3.5 text-[var(--color-text-light)]" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                                <button class="clear-search-btn absolute right-3 top-3.5 text-[var(--color-text-light)] hover:text-[var(--color-accent)] hidden">
                                    <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </div>
                            <button id="random-btn" class="px-4 bg-[var(--color-secondary)] text-white rounded-xl shadow hover:bg-yellow-600 transition-colors flex items-center justify-center" aria-label="Al√©atoire">
                                <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Themes Filter -->
                    <div class="overflow-x-auto custom-scrollbar pb-2 -mx-4 px-4 sm:mx-0 sm:px-0">
                        <div id="theme-list-container" class="flex gap-2">
                            <!-- JS Generated Pills -->
                        </div>
                    </div>
                </div>

                <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-20">
                    <!-- Cards will be injected here -->
                </div>
                
                <div id="loader-container" class="py-10 text-center hidden">
                    <span class="loader"></span>
                </div>
                
                <div id="no-results" class="hidden text-center py-20 opacity-70">
                    <div class="inline-block p-4 rounded-full bg-[var(--color-bg-card)] mb-4">
                        <svg width="40" height="40" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </div>
                    <p class="text-xl font-display">Aucun proverbe trouv√©.</p>
                </div>
            </section>

            <!-- Tab: Favoris -->
            <section id="favoris-tab" class="tab-content">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-3xl font-display text-[var(--color-primary)]">Mes Tr√©sors</h2>
                    <span id="fav-count-badge" class="bg-[var(--color-primary)] text-white text-xs font-bold px-3 py-1 rounded-full">0</span>
                </div>
                <div id="favorites-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                <div id="no-favorites" class="hidden flex flex-col items-center justify-center py-20 text-center opacity-60">
                    <svg width="64" height="64" class="text-[var(--color-border)] mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
                    <p class="text-lg">Votre collection est vide.</p>
                    <button onclick="setActiveTab('explorer-tab')" class="mt-4 text-[var(--color-primary)] font-semibold hover:underline">Explorer les proverbes</button>
                </div>
            </section>

            <!-- Tab: AI Sage -->
            <section id="ai-sage-tab" class="tab-content">
                <div class="max-w-3xl mx-auto">
                    <div class="text-center mb-10">
                        <div class="w-20 h-20 mx-auto bg-gradient-to-br from-[var(--color-primary)] to-emerald-600 rounded-2xl flex items-center justify-center text-white text-4xl shadow-xl mb-4">ü§ñ</div>
                        <h2 class="text-3xl font-display font-bold mb-2">Le Sage Artificiel</h2>
                        <p class="text-[var(--color-text-light)]">Racontez votre situation, le Sage puisera dans la m√©moire des anc√™tres.</p>
                    </div>

                    <div class="glass-panel p-6 rounded-2xl shadow-xl border border-[var(--color-border)]">
                        <textarea id="ai-context-input" rows="4" class="w-full bg-[var(--color-bg)] rounded-xl p-4 border border-[var(--color-border)] focus:border-[var(--color-primary)] focus:ring-2 focus:ring-[var(--color-primary)]/20 outline-none transition-all resize-none font-ui text-lg mb-4" placeholder="Ex: Mon fr√®re me promet toujours de m'aider mais ne vient jamais quand j'ai besoin de lui..."></textarea>
                        
                        <div class="flex justify-between items-center">
                            <span id="ai-status" class="text-sm text-[var(--color-text-light)] font-medium italic"></span>
                            <button id="ai-suggest-btn" class="px-8 py-3 bg-[var(--color-heading)] text-[var(--color-bg)] font-bold rounded-xl hover:bg-[var(--color-primary)] transition-all shadow-lg flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                <span>Consulter le Sage</span>
                                <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                            </button>
                        </div>
                    </div>

                    <div id="ai-result-container" class="mt-8 space-y-6"></div>
                </div>
            </section>

             <!-- Tab: Quiz -->
             <section id="quiz-tab" class="tab-content">
                <div class="max-w-2xl mx-auto">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-display font-bold text-[var(--color-primary)]">D√©fi de Sagesse</h2>
                        <p class="text-[var(--color-text-light)] mt-2">Testez votre connaissance des Inzan</p>
                    </div>
                    
                    <div id="quiz-card" class="glass-panel p-1 rounded-3xl shadow-2xl overflow-hidden relative min-h-[400px]">
                        <!-- Background decoration -->
                        <div class="absolute top-0 right-0 w-32 h-32 bg-[var(--color-secondary)] opacity-10 rounded-full blur-2xl -translate-y-1/2 translate-x-1/2"></div>
                        
                        <div id="quiz-start-view" class="p-8 text-center flex flex-col items-center justify-center h-full pt-16">
                            <div class="w-24 h-24 bg-orange-100 dark:bg-orange-900/30 rounded-full flex items-center justify-center text-orange-600 mb-6">
                                <svg width="40" height="40" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                            </div>
                            <h3 class="text-2xl font-bold mb-4">Quiz IA Dynamique</h3>
                            <p class="text-[var(--color-text-light)] mb-8">L'intelligence artificielle va g√©n√©rer 10 questions uniques bas√©es sur la base de donn√©es.</p>
                            <button id="start-quiz-btn" class="w-full py-4 bg-[var(--color-primary)] text-white font-bold rounded-xl shadow-lg hover:brightness-110 transition-all">Commencer le d√©fi</button>
                        </div>

                        <div id="quiz-play-view" class="hidden p-6 sm:p-8">
                            <div class="flex justify-between items-center mb-6 text-sm font-semibold text-[var(--color-text-light)]">
                                <span id="quiz-progress-text">Question 1/10</span>
                                <span class="bg-[var(--color-bg)] px-3 py-1 rounded-full border border-[var(--color-border)]">Score: <span id="quiz-score" class="text-[var(--color-primary)]">0</span></span>
                            </div>
                            <!-- Progress Bar -->
                            <div class="w-full h-2 bg-[var(--color-border)] rounded-full mb-8 overflow-hidden">
                                <div id="quiz-progress-bar" class="h-full bg-[var(--color-primary)] transition-all duration-500" style="width: 10%"></div>
                            </div>
                            
                            <div class="mb-8">
                                <h3 id="question-text" class="text-xl sm:text-2xl font-serif font-bold text-[var(--color-heading)] leading-relaxed">...</h3>
                            </div>
                            
                            <div id="options-container" class="space-y-3"></div>
                            
                            <div id="quiz-feedback" class="mt-6 hidden animate-enter">
                                <!-- Feedback injected here -->
                            </div>
                        </div>

                         <div id="quiz-loading-view" class="hidden absolute inset-0 bg-[var(--color-bg-card)] z-20 flex flex-col items-center justify-center backdrop-blur-sm">
                            <span class="loader mb-4"></span>
                            <p class="text-sm font-semibold animate-pulse">Le Sage pr√©pare les questions...</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Mobile Nav (Bottom Bar) -->
        <nav id="mobile-nav" class="sm:hidden fixed bottom-0 left-0 right-0 bg-[var(--color-bg-card)] backdrop-blur-lg border-t border-[var(--color-border)] z-40 px-4 py-2 flex justify-between items-center shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
            <button data-tab="accueil-tab" class="nav-btn mobile flex-1 flex flex-col items-center gap-1 p-2 rounded-lg text-[var(--color-text-light)] active">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                <span class="text-[10px] font-medium">Accueil</span>
            </button>
            <button data-tab="explorer-tab" class="nav-btn mobile flex-1 flex flex-col items-center gap-1 p-2 rounded-lg text-[var(--color-text-light)]">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                <span class="text-[10px] font-medium">Explorer</span>
            </button>
            <div class="relative -top-6">
                <button data-tab="ai-sage-tab" class="nav-btn mobile w-14 h-14 rounded-full bg-[var(--color-heading)] text-[var(--color-bg)] flex items-center justify-center shadow-lg border-4 border-[var(--color-bg)] transform transition-transform active:scale-95">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 16a1 1 0 1 1 1-1 1 1 0 0 1-1 1zm1-5.16V14a1 1 0 0 1-2 0v-2a1 1 0 0 1 1-1 1.5 1.5 0 1 0-1.5-1.5 1 1 0 0 1-2 0 3.5 3.5 0 1 1 4.5 3.34z"/></svg>
                </button>
            </div>
            <button data-tab="favoris-tab" class="nav-btn mobile flex-1 flex flex-col items-center gap-1 p-2 rounded-lg text-[var(--color-text-light)]">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
                <span class="text-[10px] font-medium">Favoris</span>
            </button>
            <button data-tab="quiz-tab" class="nav-btn mobile flex-1 flex flex-col items-center gap-1 p-2 rounded-lg text-[var(--color-text-light)]">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                <span class="text-[10px] font-medium">Quiz</span>
            </button>
        </nav>
    </div>

    <!-- Modals -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] opacity-0 pointer-events-none transition-opacity duration-300"></div>
    
    <!-- Generic Content Modal -->
    <div id="modal-content" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-2xl max-h-[85vh] bg-[var(--color-bg)] rounded-3xl shadow-2xl z-[101] opacity-0 scale-95 pointer-events-none transition-all duration-300 flex flex-col border border-[var(--glass-border)]">
        <div class="p-6 border-b border-[var(--color-border)] flex justify-between items-center bg-[var(--color-bg-alt)]/50 rounded-t-3xl">
            <h2 id="modal-title" class="text-2xl font-display font-bold text-[var(--color-heading)]">Titre</h2>
            <button id="modal-close-btn" class="p-2 rounded-full hover:bg-[var(--color-border)] transition-colors">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div id="modal-body" class="p-6 overflow-y-auto prose dark:prose-invert max-w-none"></div>
    </div>

    <!-- Zen Mode Modal -->
    <div id="zen-modal" class="fixed inset-0 z-[150] bg-[var(--color-bg)] flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-500">
        <button id="close-zen" class="absolute top-6 right-6 p-3 rounded-full bg-[var(--color-bg-alt)] hover:bg-[var(--color-border)] transition-colors z-50">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
        </button>
        <div class="max-w-4xl px-8 text-center">
             <div class="w-20 h-1 bg-[var(--color-secondary)] mx-auto mb-10"></div>
             <p id="zen-kabyle" class="text-4xl md:text-6xl font-display font-bold leading-tight mb-8 text-[var(--color-heading)]"></p>
             <p id="zen-french" class="text-xl md:text-2xl font-light text-[var(--color-text-light)] italic font-body"></p>
        </div>
    </div>
    
    <!-- Stats Modal -->
    <div id="stats-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-md bg-[var(--color-bg)] rounded-3xl shadow-2xl z-[101] opacity-0 scale-95 pointer-events-none transition-all duration-300 border border-[var(--glass-border)]">
        <div class="p-6 text-center">
            <h2 class="text-2xl font-display font-bold mb-6">Mon Parcours</h2>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="p-4 rounded-2xl bg-blue-50 dark:bg-blue-900/20">
                    <p class="text-3xl font-bold text-blue-600 dark:text-blue-400" id="stat-views">0</p>
                    <p class="text-xs text-[var(--color-text-light)] uppercase tracking-wide">Proverbes Vus</p>
                </div>
                <div class="p-4 rounded-2xl bg-pink-50 dark:bg-pink-900/20">
                    <p class="text-3xl font-bold text-pink-600 dark:text-pink-400" id="stat-favs">0</p>
                    <p class="text-xs text-[var(--color-text-light)] uppercase tracking-wide">Favoris</p>
                </div>
                <div class="p-4 rounded-2xl bg-yellow-50 dark:bg-yellow-900/20 col-span-2">
                    <p class="text-3xl font-bold text-yellow-600 dark:text-yellow-400" id="stat-quiz">0</p>
                    <p class="text-xs text-[var(--color-text-light)] uppercase tracking-wide">Meilleur Score Quiz</p>
                </div>
            </div>
            <h3 class="text-left font-bold text-sm mb-3 text-[var(--color-text-light)] uppercase">Derniers consult√©s</h3>
            <div id="history-list" class="text-left space-y-2 max-h-40 overflow-y-auto custom-scrollbar mb-6">
                <!-- Injected via JS -->
            </div>
            <button id="close-stats" class="w-full py-3 bg-[var(--color-bg-alt)] rounded-xl font-semibold hover:bg-[var(--color-border)] transition-colors">Fermer</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-24 sm:bottom-10 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full bg-slate-800 text-white shadow-2xl z-[200] opacity-0 pointer-events-none flex items-center gap-3">
        <span id="toast-icon">‚ú®</span>
        <span id="toast-msg" class="font-medium text-sm">Notification</span>
    </div>

<script>
/**
 * INZAN APP LOGIC
 * Architecture: Monolithic State Management
 */
document.addEventListener('DOMContentLoaded', () => {
    
    // --- CONFIGURATION ---
    const CONFIG = {
        GEMINI_KEY: "AIzaSyAKpc-aRVkt_rfm96ApWJnL244C-L6mZj4", // API Key preserved
        PROVERBS_URL: 'proverbs.json',
        BATCH_SIZE: 30,
        KEYBOARD_CHARS: ['…õ','…£','·∏•','·∏ç','·πõ','·π£','·π≠','·∫ì','ƒç','«ß']
    };

    // --- DOM REFERENCES ---
    const dom = {
        body: document.body,
        splash: document.getElementById('splash-screen'),
        navBtns: document.querySelectorAll('.nav-btn'),
        tabs: document.querySelectorAll('.tab-content'),
        searchInput: document.getElementById('search-input'),
        clearSearch: document.querySelector('.clear-search-btn'),
        resultsContainer: document.getElementById('results-container'),
        loader: document.getElementById('loader-container'),
        themeList: document.getElementById('theme-list-container'),
        podContainer: document.getElementById('proverb-of-the-day-container'),
        podKabyle: document.getElementById('pod-kabyle'),
        podFrench: document.getElementById('pod-french'),
        podExplain: document.getElementById('pod-explain-btn'),
        podZen: document.getElementById('pod-zen-mode'),
        modal: {
            el: document.getElementById('modal-content'),
            back: document.getElementById('modal-backdrop'),
            title: document.getElementById('modal-title'),
            body: document.getElementById('modal-body'),
            close: document.getElementById('modal-close-btn')
        },
        zenModal: {
            el: document.getElementById('zen-modal'),
            close: document.getElementById('close-zen'),
            k: document.getElementById('zen-kabyle'),
            f: document.getElementById('zen-french')
        },
        statsModal: document.getElementById('stats-modal'),
        statsBtn: document.getElementById('stats-btn'),
        closeStats: document.getElementById('close-stats'),
        ai: {
            input: document.getElementById('ai-context-input'),
            btn: document.getElementById('ai-suggest-btn'),
            results: document.getElementById('ai-result-container'),
            status: document.getElementById('ai-status')
        },
        quiz: {
            card: document.getElementById('quiz-card'),
            startView: document.getElementById('quiz-start-view'),
            playView: document.getElementById('quiz-play-view'),
            loading: document.getElementById('quiz-loading-view'),
            questionTxt: document.getElementById('question-text'),
            optionsBox: document.getElementById('options-container'),
            progressBar: document.getElementById('quiz-progress-bar'),
            progressTxt: document.getElementById('quiz-progress-text'),
            score: document.getElementById('quiz-score'),
            feedback: document.getElementById('quiz-feedback')
        }
    };

    // --- STATE ---
    const state = {
        proverbs: [],
        filtered: [],
        favorites: new Set(JSON.parse(localStorage.getItem('inzan_favs') || '[]')),
        history: JSON.parse(localStorage.getItem('inzan_history') || '[]'),
        stats: JSON.parse(localStorage.getItem('inzan_stats') || '{"views":0, "quizHigh":0}'),
        page: 0,
        activeTheme: 'tous',
        isLoading: false,
        searchDebounce: null,
        quiz: {
            questions: [],
            current: 0,
            score: 0
        }
    };

    // --- UTILITIES ---
    const normalize = (str) => {
        if (!str) return '';
        return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "")
            .replace(/…£/g,"gh").replace(/…õ/g,"3").replace(/ƒç/g,"tch")
            .replace(/«ß/g,"dj").replace(/·∏•/g,"h").replace(/[^a-z0-9 ]/g, "");
    };

    const toast = (msg, icon = '‚ú®') => {
        const t = document.getElementById('toast');
        document.getElementById('toast-msg').textContent = msg;
        document.getElementById('toast-icon').textContent = icon;
        t.style.opacity = '1';
        t.style.pointerEvents = 'auto';
        t.style.transform = 'translate(-50%, 0)';
        setTimeout(() => {
            t.style.opacity = '0';
            t.style.transform = 'translate(-50%, 20px)';
            t.style.pointerEvents = 'none';
        }, 3000);
    };

    const updateStats = (type, val = 1) => {
        if(type === 'view') state.stats.views += val;
        if(type === 'quiz' && val > state.stats.quizHigh) state.stats.quizHigh = val;
        localStorage.setItem('inzan_stats', JSON.stringify(state.stats));
        renderStats();
    };

    const addToHistory = (proverb) => {
        // Remove duplicate if exists, add to top, limit to 10
        state.history = state.history.filter(h => h.id !== proverb.id);
        state.history.unshift({ id: proverb.id, k: proverb.kabyle });
        if(state.history.length > 10) state.history.pop();
        localStorage.setItem('inzan_history', JSON.stringify(state.history));
        updateStats('view');
    };

    // --- TTS ENGINE (Optimized) ---
    const speak = (text) => {
        if (!window.speechSynthesis) return toast("Audio non support√©", "üîá");
        window.speechSynthesis.cancel();
        
        // Phonetic mapping for better French engine pronunciation
        const map = text.toLowerCase()
            .replace(/…£/g, "rhra") // Rough approx
            .replace(/x/g, "kh")
            .replace(/ƒç/g, "tch")
            .replace(/«ß/g, "dj")
            .replace(/…õ/g, "aa")
            .replace(/·∏•/g, "hh")
            .replace(/q/g, "k")
            .replace(/u/g, "ou")
            .replace(/e/g, "eu");

        const u = new SpeechSynthesisUtterance(map);
        u.lang = 'fr-FR';
        u.rate = 0.85; 
        
        // Select best voice
        const voices = window.speechSynthesis.getVoices();
        const v = voices.find(v => v.lang.includes('fr') && (v.name.includes('Google') || v.name.includes('Thomas')));
        if(v) u.voice = v;
        
        window.speechSynthesis.speak(u);
        toast("Lecture en cours...", "üì¢");
    };

    // --- IMAGE GENERATOR (Canvas) ---
    const generateImage = async (proverb) => {
        const canvas = document.createElement('canvas');
        canvas.width = 1080;
        canvas.height = 1080;
        const ctx = canvas.getContext('2d');

        // Background
        const grad = ctx.createLinearGradient(0,0,1080,1080);
        grad.addColorStop(0, '#F9F7F3');
        grad.addColorStop(1, '#E2E8F0');
        ctx.fillStyle = grad;
        ctx.fillRect(0,0,1080,1080);

        // Pattern Overlay (Berber motif simulation)
        ctx.strokeStyle = 'rgba(74, 124, 89, 0.05)';
        ctx.lineWidth = 2;
        for(let i=0; i<1080; i+=40){
            ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(1080, i+200); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i-200, 1080); ctx.stroke();
        }

        // Card container
        ctx.shadowColor = "rgba(0,0,0,0.15)";
        ctx.shadowBlur = 40;
        ctx.shadowOffsetY = 20;
        ctx.fillStyle = "#FFFFFF";
        ctx.roundRect(100, 150, 880, 780, 40);
        ctx.fill();
        ctx.shadowColor = "transparent";

        // Text
        ctx.textAlign = 'center';
        ctx.fillStyle = '#4A7C59';
        ctx.font = 'bold 90px sans-serif'; // Fallback font
        ctx.fillText("‚µ£", 540, 260);

        const wrap = (txt, y, font, col) => {
            ctx.font = font;
            ctx.fillStyle = col;
            const words = txt.split(' ');
            let line = '';
            for(let w of words){
                if(ctx.measureText(line + w).width > 700){
                    ctx.fillText(line, 540, y);
                    line = '';
                    y += 60; // line height
                }
                line += w + ' ';
            }
            ctx.fillText(line, 540, y);
            return y;
        };

        let cursorY = 400;
        cursorY = wrap(`¬´ ${proverb.kabyle} ¬ª`, cursorY, 'bold italic 50px serif', '#1A202C');
        
        ctx.beginPath();
        ctx.moveTo(440, cursorY + 40);
        ctx.lineTo(640, cursorY + 40);
        ctx.strokeStyle = '#C79A2A';
        ctx.lineWidth = 4;
        ctx.stroke();

        wrap(proverb.francais, cursorY + 120, '36px sans-serif', '#718096');

        // Footer
        ctx.font = 'bold 24px sans-serif';
        ctx.fillStyle = '#4A7C59';
        ctx.fillText("INZAN - Sagesse Kabyle", 540, 880);

        // Export
        const url = canvas.toDataURL('image/png');
        openModal("Image pr√™te", `
            <div class="text-center">
                <img src="${url}" class="w-full rounded-lg shadow-md mb-4" alt="Proverbe">
                <a href="${url}" download="inzan-${proverb.id}.png" class="inline-block w-full py-3 bg-[var(--color-primary)] text-white rounded-xl font-bold">T√©l√©charger l'image HD</a>
            </div>
        `);
    };

    // --- UI RENDERERS ---

    const openModal = (title, html) => {
        dom.modal.title.textContent = title;
        dom.modal.body.innerHTML = html;
        dom.modal.back.classList.remove('opacity-0', 'pointer-events-none');
        dom.modal.el.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
    };

    const closeModal = () => {
        [dom.modal.back, dom.modal.el, dom.zenModal.el, dom.statsModal].forEach(el => {
            el.classList.add('opacity-0', 'pointer-events-none');
            if(el === dom.modal.el || el === dom.statsModal) el.classList.add('scale-95');
        });
    };

    const createCard = (p) => {
        const isFav = state.favorites.has(p.id);
        const themes = (p.theme || '').split(',').map(t => `<span class="text-[10px] uppercase font-bold text-[var(--color-primary)] bg-[var(--color-primary)]/10 px-2 py-1 rounded-md">${t.trim()}</span>`).join('');
        
        const el = document.createElement('div');
        el.className = 'glass-panel p-6 rounded-2xl card-hover flex flex-col justify-between animate-enter';
        el.innerHTML = `
            <div>
                <div class="flex justify-between items-start mb-4">
                    <span class="text-2xl text-[var(--color-secondary)] font-display opacity-50">‚ùù</span>
                    <div class="flex gap-1">
                        ${themes}
                    </div>
                </div>
                <p class="text-xl font-display font-bold text-[var(--color-heading)] mb-3 leading-relaxed kabyle-text">¬´ ${p.kabyle} ¬ª</p>
                <p class="text-[var(--color-text-light)] font-serif italic border-l-2 border-[var(--color-secondary)] pl-3 mb-6">${p.francais}</p>
            </div>
            <div class="flex justify-between items-center pt-4 border-t border-[var(--color-border)]">
                <button class="text-xs font-bold text-[var(--color-text)] hover:text-[var(--color-primary)] action-explain" data-id="${p.id}">EXPLIQUER</button>
                <div class="flex gap-2">
                    <button class="p-2 rounded-full hover:bg-[var(--color-bg-alt)] text-[var(--color-text-light)] action-tts" data-id="${p.id}" title="√âcouter"><svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg></button>
                    <button class="p-2 rounded-full hover:bg-[var(--color-bg-alt)] text-[var(--color-text-light)] action-img" data-id="${p.id}" title="Image"><svg width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg></button>
                    <button class="p-2 rounded-full hover:bg-pink-50 text-[var(--color-text-light)] action-fav ${isFav?'text-pink-500 fill-pink-500':''}" data-id="${p.id}" title="Favoris"><svg width="18" height="18" fill="${isFav?'currentColor':'none'}" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg></button>
                </div>
            </div>
        `;
        
        // Event delegation logic handled in main listener
        return el;
    };

    const renderChunk = (reset = false) => {
        if(reset) {
            dom.resultsContainer.innerHTML = '';
            state.page = 0;
            state.isLoading = false;
        }
        
        const start = state.page * CONFIG.BATCH_SIZE;
        const chunk = state.filtered.slice(start, start + CONFIG.BATCH_SIZE);
        
        if(chunk.length === 0 && reset) {
            document.getElementById('no-results').classList.remove('hidden');
            return;
        } else {
            document.getElementById('no-results').classList.add('hidden');
        }

        const fragment = document.createDocumentFragment();
        chunk.forEach(p => fragment.appendChild(createCard(p)));
        dom.resultsContainer.appendChild(fragment);
        
        state.page++;
        state.isLoading = false;
        dom.loader.classList.add('hidden');
    };

    const filterProverbs = () => {
        const q = normalize(dom.searchInput.value);
        state.filtered = state.proverbs.filter(p => {
            const matchesTheme = state.activeTheme === 'tous' || normalize(p.theme).includes(state.activeTheme);
            const matchesSearch = !q || normalize(p.kabyle + ' ' + p.francais + ' ' + p.theme).includes(q);
            return matchesTheme && matchesSearch;
        });
        document.getElementById('count-display').textContent = state.filtered.length;
        renderChunk(true);
    };

    // --- AI FUNCTIONS (Gemini) ---
    const callAI = async (prompt, system) => {
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${CONFIG.GEMINI_KEY}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    contents: [{parts:[{text: prompt}]}],
                    systemInstruction: {parts:[{text: system}]}
                })
            });
            const data = await res.json();
            return data.candidates[0].content.parts[0].text;
        } catch(e) {
            console.error(e);
            throw new Error("Erreur de connexion avec le Sage.");
        }
    };

    const handleExplainer = async (id) => {
        const p = state.proverbs.find(x => x.id === parseInt(id));
        openModal("Le Sage r√©fl√©chit...", `<div class="flex justify-center p-8"><span class="loader"></span></div>`);
        
        try {
            const txt = await callAI(
                `Explique ce proverbe kabyle : "${p.kabyle}" ("${p.francais}")`,
                `Tu es un expert culturel kabyle. Explique le sens litt√©ral, le sens figur√© et donne un exemple d'usage moderne. Formate en HTML simple (<h3>, <p>).`
            );
            openModal(`Analyse : ${p.kabyle}`, `<div class="space-y-4 text-lg">${txt.replace(/```html/g,'').replace(/```/g,'')}</div>`);
            addToHistory(p);
        } catch(e) {
            openModal("Erreur", `<p class="text-red-500">Le Sage est indisponible.</p>`);
        }
    };

    // --- QUIZ LOGIC ---
    const startQuiz = async () => {
        dom.quiz.startView.classList.add('hidden');
        dom.quiz.loading.classList.remove('hidden');
        
        // Pick 10 random proverbs
        const selection = state.proverbs.sort(()=>0.5-Math.random()).slice(0,10);
        const prompt = `G√©n√®re un quiz JSON de 10 questions bas√© sur ces proverbes : ${JSON.stringify(selection.map(x=>({k:x.kabyle, f:x.francais})))}. 
        Format JSON strict: [{"q":"Question?", "opts":["A","B","C","D"], "a":0, "exp":"Explication"}]`;

        try {
            const jsonStr = await callAI(prompt, "Tu es un g√©n√©rateur de quiz API. R√©ponds UNIQUEMENT en JSON valide.");
            const cleanJson = jsonStr.replace(/```json/g,'').replace(/```/g,'').trim();
            state.quiz.questions = JSON.parse(cleanJson);
            state.quiz.current = 0;
            state.quiz.score = 0;
            dom.quiz.loading.classList.add('hidden');
            dom.quiz.playView.classList.remove('hidden');
            renderQuestion();
        } catch(e) {
            dom.quiz.loading.classList.add('hidden');
            dom.quiz.startView.classList.remove('hidden');
            toast("Erreur g√©n√©ration quiz", "‚ö†Ô∏è");
        }
    };

    const renderQuestion = () => {
        const q = state.quiz.questions[state.quiz.current];
        dom.quiz.questionTxt.textContent = q.q;
        dom.quiz.progressTxt.textContent = `Question ${state.quiz.current + 1} / 10`;
        dom.quiz.progressBar.style.width = `${((state.quiz.current+1)/10)*100}%`;
        dom.quiz.score.textContent = state.quiz.score;
        dom.quiz.feedback.classList.add('hidden');
        dom.quiz.optionsBox.innerHTML = '';

        q.opts.forEach((opt, idx) => {
            const btn = document.createElement('button');
            btn.className = "w-full text-left p-4 rounded-xl border border-[var(--color-border)] hover:bg-[var(--color-bg-alt)] hover:border-[var(--color-primary)] transition-all font-medium";
            btn.textContent = opt;
            btn.onclick = () => handleAnswer(idx, btn);
            dom.quiz.optionsBox.appendChild(btn);
        });
    };

    const handleAnswer = (idx, btn) => {
        const q = state.quiz.questions[state.quiz.current];
        const isCorrect = idx === q.a;
        
        // Visuals
        Array.from(dom.quiz.optionsBox.children).forEach((b, i) => {
            b.disabled = true;
            if(i === q.a) b.classList.add('bg-green-100', 'border-green-500', 'text-green-800');
            else if(i === idx && !isCorrect) b.classList.add('bg-red-100', 'border-red-500', 'text-red-800');
        });

        if(isCorrect) {
            state.quiz.score += 10; 
            dom.quiz.score.textContent = state.quiz.score;
            toast("Bonne r√©ponse !", "üéâ");
        }

        // Feedback
        dom.quiz.feedback.innerHTML = `
            <div class="p-4 rounded-xl ${isCorrect?'bg-green-50':'bg-red-50'} mb-4">
                <p class="font-bold mb-1">${isCorrect ? 'Excellent !' : 'Oups...'}</p>
                <p class="text-sm opacity-80">${q.exp}</p>
            </div>
            <button id="next-q-btn" class="w-full py-3 bg-[var(--color-heading)] text-white rounded-xl font-bold hover:opacity-90 transition-opacity">
                ${state.quiz.current < 9 ? 'Question Suivante' : 'Voir les R√©sultats'}
            </button>
        `;
        dom.quiz.feedback.classList.remove('hidden');
        
        document.getElementById('next-q-btn').onclick = () => {
            if(state.quiz.current < 9) {
                state.quiz.current++;
                renderQuestion();
            } else {
                finishQuiz();
            }
        };
    };

    const finishQuiz = () => {
        updateStats('quiz', state.quiz.score);
        dom.quiz.playView.classList.add('hidden');
        dom.quiz.startView.classList.remove('hidden');
        openModal("Quiz Termin√©", `
            <div class="text-center">
                <p class="text-5xl font-bold text-[var(--color-primary)] mb-2">${state.quiz.score}/100</p>
                <p class="text-[var(--color-text-light)]">Votre sagesse grandit.</p>
            </div>
        `);
    };

    // --- INITIALIZATION ---
    const init = async () => {
        try {
            // Load Data
            const res = await fetch(CONFIG.PROVERBS_URL);
            const data = await res.json();
            state.proverbs = data.map((p,i) => ({...p, id:i}));
            state.filtered = state.proverbs;

            // Generate Themes
            const themes = [...new Set(data.flatMap(p => p.theme.split(',').map(t=>normalize(t.trim()))))].sort();
            dom.themeList.innerHTML = `<button class="whitespace-nowrap px-4 py-2 rounded-full bg-[var(--color-primary)] text-white text-sm font-semibold shadow-md" data-theme="tous">Tous</button>` + 
                themes.map(t => `<button class="whitespace-nowrap px-4 py-2 rounded-full glass-panel hover:bg-[var(--color-bg-alt)] text-sm font-medium transition-colors" data-theme="${t}">${t.charAt(0).toUpperCase()+t.slice(1)}</button>`).join('');

            // Proverb of the Day (Random based on date)
            const todayIdx = Math.floor(new Date().getTime() / 86400000) % state.proverbs.length;
            const pod = state.proverbs[todayIdx];
            dom.podKabyle.textContent = `¬´ ${pod.kabyle} ¬ª`;
            dom.podFrench.textContent = pod.francais;
            
            // Set up actions
            dom.podExplain.onclick = () => handleExplainer(pod.id);
            dom.podZen.onclick = () => {
                dom.zenModal.k.textContent = `¬´ ${pod.kabyle} ¬ª`;
                dom.zenModal.f.textContent = pod.francais;
                dom.zenModal.el.classList.remove('opacity-0', 'pointer-events-none');
            };

            // Keyboard
            document.getElementById('tamazight-keyboard').innerHTML = CONFIG.KEYBOARD_CHARS.map(c => 
                `<button class="w-10 h-10 rounded-lg glass-panel hover:bg-[var(--color-primary)] hover:text-white transition-colors text-lg font-serif" onclick="insertChar('${c}')">${c}</button>`
            ).join('');

            // Global listeners
            setupListeners();
            
            // Stats
            renderStats();

            // Ready
            dom.splash.classList.add('opacity-0', 'pointer-events-none');
            
        } catch (e) {
            console.error(e);
            dom.resultsContainer.innerHTML = `<p class="text-red-500 text-center">Erreur de chargement (${e.message})</p>`;
            dom.splash.classList.add('hidden');
        }
    };

    const renderStats = () => {
        document.getElementById('stat-views').textContent = state.stats.views;
        document.getElementById('stat-favs').textContent = state.favorites.size;
        document.getElementById('stat-quiz').textContent = state.stats.quizHigh;
        document.getElementById('fav-count-badge').textContent = state.favorites.size;
        
        document.getElementById('history-list').innerHTML = state.history.map(h => 
            `<div class="text-xs truncate p-2 rounded bg-[var(--color-bg-alt)] cursor-pointer hover:text-[var(--color-primary)]" onclick="openHistoryItem(${h.id})">${h.k}</div>`
        ).join('');
    };

    window.openHistoryItem = (id) => {
        closeModal();
        const p = state.proverbs.find(x => x.id === id);
        if(p) {
            openModal("Historique", `<p class="text-xl font-bold mb-2">¬´ ${p.kabyle} ¬ª</p><p class="italic">${p.francais}</p>`);
        }
    };

    window.insertChar = (char) => {
        dom.searchInput.value += char;
        dom.searchInput.focus();
        filterProverbs();
    };
    
    window.setActiveTab = (id) => {
        dom.tabs.forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        dom.navBtns.forEach(b => {
            b.classList.toggle('active', b.dataset.tab === id);
        });
        window.scrollTo({top:0, behavior:'smooth'});
        
        if(id === 'explorer-tab' && state.filtered.length > 0 && dom.resultsContainer.children.length === 0) renderChunk(true);
        if(id === 'favoris-tab') renderFavorites();
    };

    const renderFavorites = () => {
        const container = document.getElementById('favorites-container');
        container.innerHTML = '';
        if(state.favorites.size === 0) {
            document.getElementById('no-favorites').classList.remove('hidden');
            return;
        }
        document.getElementById('no-favorites').classList.add('hidden');
        const favs = state.proverbs.filter(p => state.favorites.has(p.id));
        favs.forEach(p => container.appendChild(createCard(p)));
    };

    const setupListeners = () => {
        // Search
        dom.searchInput.addEventListener('input', (e) => {
            dom.clearSearch.classList.toggle('hidden', !e.target.value);
            clearTimeout(state.searchDebounce);
            state.searchDebounce = setTimeout(filterProverbs, 300);
        });
        
        dom.clearSearch.addEventListener('click', () => {
            dom.searchInput.value = '';
            dom.clearSearch.classList.add('hidden');
            filterProverbs();
        });

        // Theme Filter
        dom.themeList.addEventListener('click', (e) => {
            if(e.target.tagName === 'BUTTON') {
                state.activeTheme = e.target.dataset.theme;
                Array.from(dom.themeList.children).forEach(b => {
                    b.classList.remove('bg-[var(--color-primary)]', 'text-white');
                    b.classList.add('glass-panel');
                });
                e.target.classList.remove('glass-panel');
                e.target.classList.add('bg-[var(--color-primary)]', 'text-white');
                filterProverbs();
            }
        });

        // Nav
        dom.navBtns.forEach(btn => {
            btn.addEventListener('click', () => setActiveTab(btn.dataset.tab));
        });

        // Random
        document.getElementById('random-btn').onclick = () => {
            const r = state.filtered[Math.floor(Math.random() * state.filtered.length)];
            dom.resultsContainer.innerHTML = '';
            dom.resultsContainer.appendChild(createCard(r));
        };

        // Infinite Scroll
        window.addEventListener('scroll', () => {
            if(window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
                if(!state.isLoading && document.getElementById('explorer-tab').classList.contains('active')) {
                    state.isLoading = true;
                    dom.loader.classList.remove('hidden');
                    setTimeout(renderChunk, 500);
                }
            }
        });

        // Event Delegation for Cards
        document.body.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if(!btn) return;

            if(btn.classList.contains('action-explain')) {
                handleExplainer(btn.dataset.id);
            }
            if(btn.classList.contains('action-fav')) {
                const id = parseInt(btn.dataset.id);
                if(state.favorites.has(id)) {
                    state.favorites.delete(id);
                    btn.classList.remove('text-pink-500', 'fill-pink-500');
                    btn.querySelector('svg').setAttribute('fill', 'none');
                    toast("Retir√© des favoris", "üíî");
                } else {
                    state.favorites.add(id);
                    btn.classList.add('text-pink-500', 'fill-pink-500');
                    btn.querySelector('svg').setAttribute('fill', 'currentColor');
                    toast("Ajout√© aux favoris", "‚ù§Ô∏è");
                }
                localStorage.setItem('inzan_favs', JSON.stringify([...state.favorites]));
                updateStats();
            }
            if(btn.classList.contains('action-tts')) {
                const p = state.proverbs.find(x => x.id == btn.dataset.id);
                speak(p.kabyle);
            }
            if(btn.classList.contains('action-img')) {
                const p = state.proverbs.find(x => x.id == btn.dataset.id);
                generateImage(p);
            }
        });

        // AI Tab
        dom.ai.btn.onclick = async () => {
            const ctx = dom.ai.input.value;
            if(!ctx) return toast("D√©crivez d'abord une situation");
            
            dom.ai.btn.disabled = true;
            dom.ai.status.textContent = "Le Sage m√©dite...";
            
            try {
                // Step 1: Keywords
                const kwJson = await callAI(
                    `Extraits 3 mots-cl√©s kabyles ou fran√ßais pertinents pour cette situation: "${ctx}". JSON: {"kw":["mot1"]}`,
                    "JSON uniquement."
                );
                const kws = JSON.parse(kwJson.replace(/```json/g,'').replace(/```/g,'')).kw;
                
                // Step 2: Local Filter match
                const matches = state.proverbs.filter(p => 
                    kws.some(k => normalize(p.kabyle+p.francais).includes(normalize(k)))
                ).slice(0, 5);

                // Step 3: AI Justification
                let html = '';
                if(matches.length > 0) {
                    const advice = await callAI(
                        `Pour la situation "${ctx}", justifie pourquoi ce proverbe convient: "${matches[0].francais}"`,
                        "Sois bref et sage."
                    );
                    html = `<div class="glass-panel p-4 rounded-xl border-l-4 border-[var(--color-primary)] mb-6">
                        <p class="italic text-[var(--color-heading)]">"${advice}"</p>
                    </div>`;
                    matches.forEach(p => html += createCard(p).outerHTML);
                } else {
                     html = `<p class="text-center opacity-70">Le Sage n'a pas trouv√© de correspondance exacte, mais voici un conseil : Patience et observation sont les cl√©s.</p>`;
                }
                
                dom.ai.results.innerHTML = html;
                dom.ai.status.textContent = "";
            } catch(e) {
                toast("Erreur du Sage");
            } finally {
                dom.ai.btn.disabled = false;
            }
        };

        // Quiz
        document.getElementById('start-quiz-btn').onclick = startQuiz;

        // Modals & Utils
        dom.modal.close.onclick = closeModal;
        dom.modal.back.onclick = closeModal;
        dom.zenModal.close.onclick = closeModal;
        dom.statsBtn.onclick = () => {
             renderStats();
             dom.statsModal.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
             dom.modal.back.classList.remove('opacity-0', 'pointer-events-none');
        };
        dom.closeStats.onclick = closeModal;

        // Theme Toggle
        document.getElementById('theme-toggle').onclick = () => {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            document.getElementById('theme-icon-light').classList.toggle('hidden', isDark);
            document.getElementById('theme-icon-dark').classList.toggle('hidden', !isDark);
            localStorage.setItem('inzan_theme', isDark ? 'dark' : 'light');
        };
        
        // Init Theme
        if(localStorage.getItem('inzan_theme') === 'dark') document.getElementById('theme-toggle').click();
    };

    // START
    init();
});
</script>
</body>
</html>
