<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="D√©couvrez et explorez des milliers de proverbes kabyles (Inzan). Une collection interactive de la sagesse populaire de Kabylie avec des explications, des favoris et des suggestions par IA.">
    <meta name="theme-color" content="#F9F7F3">
    
    <meta property="og:title" content="Inzan n Teqbaylit - Tr√©sors de la Sagesse Kabyle">
    <meta property="og:description" content="Explorez des milliers de proverbes kabyles (Inzan) avec explications et suggestions par IA.">
    <meta property="og:type" content="website">
    
    <link rel="manifest" href="data:application/json,{
        &quot;name&quot;: &quot;Inzan n Teqbaylit&quot;,
        &quot;short_name&quot;: &quot;Inzan&quot;,
        &quot;start_url&quot;: &quot;.&quot;,
        &quot;display&quot;: &quot;standalone&quot;,
        &quot;background_color&quot;: &quot;#F9F7F3&quot;,
        &quot;theme_color&quot;: &quot;#4A7C59&quot;,
        &quot;description&quot;: &quot;Tr√©sors de la Sagesse Kabyle&quot;,
        &quot;icons&quot;: [
            { &quot;src&quot;: &quot;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%23F9F7F3'%3E%3C/rect%3E%3Ctext y='.9em' font-size='90' fill='%234A7C59'%3E%E2%9C%A7%3C/text%3E%3C/svg%3E&quot;, &quot;sizes&quot;: &quot;192x192&quot;, &quot;type&quot;: &quot;image/svg+xml&quot; }
        ]
    }">

    <title>Inzan n Teqbaylit - Tr√©sors de la Sagesse Kabyle</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Nouvelles polices pour un look plus "H√©ritage & Moderne" -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lora:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Ctext y=%22.9em%22 font-size=%2290%22 fill=%22%234A7C59%22%3E%E2%9C%A7%3C/text%3E%3C/svg%3E">

    <style>
        :root {
            --color-bg: #F9F7F3;
            --color-bg-card: rgba(255, 255, 255, 0.85); /* Transparence pour Glassmorphism */
            --color-text: #2D3748;
            --color-text-light: #718096;
            --color-heading: #1A202C;
            --color-primary: #4A7C59; /* Vert Olive Kabyle */
            --color-secondary: #C79A2A; /* Jaune Dor√© Kabyle */
            --color-accent: #D9534F; /* Rouge Tapis */
            --color-border: #E2E8F0;
            --glass-border: rgba(255, 255, 255, 0.5);
            --shadow-soft: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
            --font-display: 'Cinzel', serif;
            --font-body: 'Lora', serif;
            --font-ui: 'Inter', sans-serif;
        }

        html.dark {
            --color-bg: #0F172A;
            --color-bg-card: rgba(30, 41, 59, 0.7);
            --color-text: #E2E8F0;
            --color-text-light: #94A3B8;
            --color-heading: #F8FAFC;
            --color-primary: #68D391;
            --color-secondary: #F6E05E;
            --color-accent: #FC8181;
            --color-border: #334155;
            --glass-border: rgba(255, 255, 255, 0.1);
            --theme-color-dark: #0F172A;
        }
        
        html.dark meta[name="theme-color"] { content: var(--theme-color-dark); }

        body {
            background-color: var(--color-bg);
            color: var(--color-text);
            font-family: var(--font-ui);
            /* Texture subtile de papier */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E");
            transition: background-color 0.4s ease, color 0.4s ease;
            -webkit-font-smoothing: antialiased;
        }

        /* Glassmorphism Panels */
        .glass-panel {
            background: var(--color-bg-card);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-soft);
        }

        /* Typography Override */
        h1, h2, h3, .kabyle-text { font-family: var(--font-display); }
        .proverb-text { font-family: var(--font-body); }

        /* Animations */
        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-enter { animation: slideUpFade 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        .nav-btn { position: relative; transition: all 0.3s ease; }
        .nav-btn::after {
            content: ''; position: absolute; bottom: -2px; left: 50%; width: 0; height: 2px;
            background: var(--color-primary); transition: all 0.3s ease; transform: translateX(-50%);
        }
        .nav-btn.active.desktop::after { width: 80%; }
        .nav-btn.active { color: var(--color-primary); }
        
        /* Interactive Cards */
        .card-hover { transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease; }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: var(--color-primary);
        }
        
        .search-highlight {
            background-color: var(--color-secondary);
            color: white;
            padding: 0 4px;
            border-radius: 2px;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: var(--color-text-light);
            border-radius: 20px;
            opacity: 0.5;
        }

        /* Loader */
        .loader {
            width: 24px;
            height: 24px;
            border: 3px solid var(--color-border);
            border-bottom-color: var(--color-primary);
            border-radius: 50%;
            display: inline-block;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: slideUpFade 0.4s ease-out; }
        
        /* Toast */
        #toast { transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        
        /* Mobile Nav safe area */
        #mobile-nav { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col pb-24 sm:pb-0">

    <!-- Splash Screen -->
    <div id="splash-screen" class="fixed inset-0 bg-[var(--color-bg)] z-[200] flex flex-col items-center justify-center transition-opacity duration-700">
        <div class="relative">
            <div class="absolute inset-0 bg-[var(--color-primary)] opacity-20 blur-xl rounded-full animate-pulse"></div>
            <svg width="120" height="120" viewBox="0 0 100 100" class="text-[var(--color-primary)] relative z-10">
                <text x="50" y="70" font-size="80" text-anchor="middle" fill="currentColor" font-family="'Cinzel', serif">‚µ£</text>
            </svg>
        </div>
        <h1 class="text-3xl font-display font-bold text-[var(--color-heading)] mt-6 tracking-widest">INZAN</h1>
        <p class="text-[var(--color-text-light)] mt-2 font-light">Sagesse ancestrale</p>
    </div>

    <!-- Main Container -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 w-full flex-grow flex flex-col">
        
        <!-- Header -->
        <header class="flex justify-between items-center py-6 sm:py-8 relative z-50">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-[var(--color-primary)] to-[var(--color-secondary)] flex items-center justify-center text-white font-display font-bold text-xl shadow-lg">‚µ£</div>
                <div>
                    <h1 class="text-xl sm:text-2xl font-display font-bold text-[var(--color-heading)] leading-none">Inzan n Teqbaylit</h1>
                    <span class="text-xs text-[var(--color-text-light)] hidden sm:inline-block">Tr√©sors de la Sagesse Kabyle</span>
                </div>
            </div>

            <div class="flex items-center gap-2 sm:gap-4">
                <!-- Bouton Statistiques (Nouveau) -->
                <button id="stats-btn" class="p-2.5 rounded-full glass-panel hover:bg-[var(--color-bg-alt)] transition-colors text-[var(--color-text)] relative group" aria-label="Statistiques" title="Mes Statistiques">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                </button>
                <button id="theme-toggle" class="p-2.5 rounded-full glass-panel hover:bg-[var(--color-bg-alt)] transition-transform hover:rotate-12 text-[var(--color-text)]" aria-label="Changer de th√®me">
                    <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2"/><path d="M12 21v2"/><path d="M4.22 4.22l1.42 1.42"/><path d="M17.36 17.36l1.42 1.42"/><path d="M1 12h2"/><path d="M21 12h2"/><path d="M4.22 19.78l1.42-1.42"/><path d="M17.36 6.64l1.42-1.42"/></svg>
                    <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                </button>
            </div>
        </header>

        <!-- Desktop Navigation -->
        <nav class="hidden sm:flex justify-center mb-10 sticky top-4 z-40">
            <div class="glass-panel rounded-full px-2 py-1.5 flex items-center gap-1 shadow-lg">
                <button data-tab="accueil-tab" class="nav-btn desktop active px-6 py-2.5 rounded-full text-sm font-semibold text-[var(--color-text-light)] hover:text-[var(--color-heading)]">Accueil</button>
                <button data-tab="explorer-tab" class="nav-btn desktop px-6 py-2.5 rounded-full text-sm font-semibold text-[var(--color-text-light)] hover:text-[var(--color-heading)]">Explorer</button>
                <button data-tab="favoris-tab" class="nav-btn desktop px-6 py-2.5 rounded-full text-sm font-semibold text-[var(--color-text-light)] hover:text-[var(--color-heading)]">Favoris</button>
                <button data-tab="ai-sage-tab" class="nav-btn desktop px-6 py-2.5 rounded-full text-sm font-semibold text-[var(--color-text-light)] hover:text-[var(--color-heading)] flex items-center gap-2">
                    <span>Sage AI</span>
                </button>
                <button data-tab="quiz-tab" class="nav-btn desktop px-6 py-2.5 rounded-full text-sm font-semibold text-[var(--color-text-light)] hover:text-[var(--color-heading)]">Quiz</button>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="flex-grow">
            
            <!-- Tab: Accueil -->
            <section id="accueil-tab" class="tab-content active space-y-8">
                <!-- Hero Section -->
                <div class="relative glass-panel rounded-3xl p-8 sm:p-12 overflow-hidden text-center sm:text-left shadow-xl border-t-4 border-[var(--color-primary)]">
                    <div class="absolute top-0 right-0 opacity-10 pointer-events-none transform translate-x-1/3 -translate-y-1/3">
                        <svg width="400" height="400" viewBox="0 0 100 100"><text x="50" y="50" font-size="80" fill="currentColor">‚µ£</text></svg>
                    </div>
                    
                    <div class="relative z-10 max-w-3xl mx-auto sm:mx-0">
                        <span class="inline-block px-3 py-1 rounded-full bg-[var(--color-secondary)]/20 text-[var(--color-secondary)] text-xs font-bold tracking-wider mb-4">LE PROVERBE DU JOUR</span>
                        <div id="proverb-of-the-day-container" class="min-h-[160px] flex flex-col justify-center">
                            <!-- Inject√© par JS -->
                            <div class="text-center py-8"><span class="loader"></span></div>
                        </div>
                        
                        <div class="mt-8 flex flex-wrap gap-4 justify-center sm:justify-start">
                            <button id="pod-explain-btn" class="px-6 py-3 rounded-xl bg-[var(--color-primary)] text-white font-semibold shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all flex items-center gap-2">
                                <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                Analyser ce proverbe
                            </button>
                            <!-- Mode Zen : Nouveau -->
                            <button id="pod-zen-mode" class="px-6 py-3 rounded-xl glass-panel text-[var(--color-text)] font-semibold hover:bg-[var(--color-bg-alt)] transition-all flex items-center gap-2 border border-[var(--color-border)]">
                                <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" /></svg>
                                Mode Zen
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Features Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass-panel p-6 rounded-2xl flex items-start gap-4 hover:border-[var(--color-secondary)] transition-colors cursor-pointer" onclick="setActiveTab('explorer-tab')">
                        <div class="p-3 bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-xl">
                            <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg mb-1">Explorer la Collection</h3>
                            <p class="text-sm text-[var(--color-text-light)]">Recherchez parmi <span id="count-display" class="font-bold text-[var(--color-primary)]">...</span> proverbes par mot-cl√©, th√®me ou √©motion.</p>
                        </div>
                    </div>
                    
                    <div class="glass-panel p-6 rounded-2xl flex items-start gap-4 hover:border-[var(--color-secondary)] transition-colors cursor-pointer" onclick="setActiveTab('ai-sage-tab')">
                        <div class="p-3 bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 rounded-xl">
                            <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg mb-1">Le Sage Artificiel</h3>
                            <p class="text-sm text-[var(--color-text-light)]">Posez une situation de vie, l'IA trouvera le proverbe ancestral adapt√©.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Tab: Explorer -->
            <section id="explorer-tab" class="tab-content">
                <div class="sticky top-20 sm:top-24 z-30 space-y-4 mb-8">
                    <div class="glass-panel rounded-2xl p-4 shadow-lg border border-[var(--color-border)]">
                         <!-- Clavier Tamazight -->
                        <div id="tamazight-keyboard" class="flex gap-1.5 overflow-x-auto pb-3 mb-2 custom-scrollbar -mx-2 px-2 sm:mx-0 sm:px-0 justify-start sm:justify-center">
                            <!-- G√©n√©r√© par JS -->
                        </div>

                        <!-- Barre de recherche -->
                        <div class="flex gap-3">
                            <div class="relative flex-grow search-wrapper">
                                <input type="text" id="search-input" placeholder="Rechercher par mot-cl√© ou th√®me..." class="w-full pl-12 pr-10 py-3 rounded-xl bg-[var(--color-bg)] border border-[var(--color-border)] focus:border-[var(--color-primary)] focus:ring-2 focus:ring-[var(--color-primary)]/20 outline-none transition-all font-ui shadow-inner">
                                <svg class="absolute left-4 top-3.5 text-[var(--color-text-light)]" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                                <button class="clear-search-btn absolute right-3 top-3.5 text-[var(--color-text-light)] hover:text-[var(--color-accent)] opacity-0">
                                    <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                </button>
                            </div>
                            <button id="random-btn" class="px-4 bg-[var(--color-secondary)] text-white rounded-xl shadow hover:bg-yellow-600 transition-colors flex items-center justify-center gap-2" aria-label="Al√©atoire">
                                <svg width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                                <span class="hidden sm:inline">Al√©atoire</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filtres -->
                    <div class="overflow-x-auto custom-scrollbar pb-2 -mx-4 px-4 sm:mx-0 sm:px-0">
                        <div id="theme-list-container" class="flex gap-2">
                            <!-- G√©n√©r√© par JS -->
                        </div>
                    </div>
                </div>
                
                <div id="results-feedback" class="mb-4 text-center text-[var(--color-text-light)] font-semibold text-sm"></div>

                <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 pb-20">
                    <div id="initial-load-message" class="md:col-span-2 xl:col-span-3 text-center p-12 text-[var(--color-text-light)] opacity-70">
                        <svg class="mx-auto mb-4" width="40" height="40" fill="none" viewBox="0 0 24 24" stroke="currentColor"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                        <p>Commencez votre recherche ou cliquez sur Al√©atoire.</p>
                    </div>
                </div>
                
                <div id="infinite-scroll-loader" class="py-10 text-center hidden">
                    <span class="loader"></span>
                </div>
                
                <div id="no-results" class="hidden text-center py-20 opacity-70">
                    <p class="text-xl font-display">üòî Aucun proverbe trouv√©.</p>
                    <p class="text-sm">Essayez de modifier vos mots-cl√©s.</p>
                </div>
            </section>

            <!-- Tab: Favoris -->
            <section id="favoris-tab" class="tab-content">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-3xl font-display text-[var(--color-primary)]">Mes Tr√©sors ‚ù§Ô∏è</h2>
                    <span id="fav-count-badge" class="bg-[var(--color-primary)] text-white text-xs font-bold px-3 py-1 rounded-full">0</span>
                </div>
                <div id="favorites-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>
                <div id="no-favorites" class="hidden flex flex-col items-center justify-center py-20 text-center opacity-60">
                    <p class="text-lg">Votre collection est vide.</p>
                    <button id="go-to-explorer-btn" class="mt-4 px-6 py-2 bg-[var(--color-primary)] text-white rounded-lg shadow font-semibold">Explorer les proverbes</button>
                </div>
            </section>

            <!-- Tab: AI Sage -->
            <section id="ai-sage-tab" class="tab-content">
                <div class="max-w-3xl mx-auto">
                    <div class="text-center mb-10">
                        <div class="w-20 h-20 mx-auto bg-gradient-to-br from-[var(--color-primary)] to-emerald-600 rounded-2xl flex items-center justify-center text-white text-4xl shadow-xl mb-4">ü§ñ</div>
                        <h2 class="text-3xl font-display font-bold mb-2">Le Sage Artificiel</h2>
                        <p class="text-[var(--color-text-light)]">Racontez votre situation, le Sage puisera dans la m√©moire des anc√™tres.</p>
                    </div>

                    <div class="glass-panel p-6 rounded-2xl shadow-xl border border-[var(--color-border)]">
                        <textarea id="ai-context-input" rows="4" class="w-full bg-[var(--color-bg)] rounded-xl p-4 border border-[var(--color-border)] focus:border-[var(--color-primary)] focus:ring-2 focus:ring-[var(--color-primary)]/20 outline-none transition-all resize-none font-ui text-lg mb-4" placeholder="Exemple : Mon ami parle beaucoup mais n'agit jamais..."></textarea>
                        
                        <div class="flex justify-between items-center">
                            <span id="ai-step-feedback" class="text-sm text-[var(--color-text-light)] font-medium italic"></span>
                            <button id="ai-suggest-btn" class="px-8 py-3 bg-[var(--color-heading)] text-[var(--color-bg)] font-bold rounded-xl hover:bg-[var(--color-primary)] transition-all shadow-lg flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                <span>Consulter le Sage</span>
                                <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                            </button>
                        </div>
                    </div>

                    <div id="ai-result-feedback" class="mt-8 space-y-6"></div>
                </div>
            </section>

             <!-- Tab: Quiz -->
             <section id="quiz-tab" class="tab-content">
                <div class="max-w-2xl mx-auto">
                    <div class="text-center mb-8">
                        <h2 class="text-3xl font-display font-bold text-[var(--color-primary)]">Quiz de Sagesse üß†</h2>
                        <p class="text-[var(--color-text-light)] mt-2">Testez votre connaissance des Inzan</p>
                    </div>
                    
                    <div id="quiz-container" class="glass-panel p-1 rounded-3xl shadow-2xl overflow-hidden relative min-h-[400px]">
                         <!-- Inject√© par JS -->
                        <div class="text-center p-8">
                            <span class="loader loader-dark"></span>
                            <p class="mt-4 text-sm text-[var(--color-text-light)]">Chargement du module de Quiz...</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer class="text-center mt-16 py-8 border-t border-[var(--color-border)] text-[var(--color-text-light)]">
            <p class="font-medium mb-2">Une collection de la sagesse populaire kabyle.</p>
            <p class="text-sm">Application d√©velopp√©e par TAMAZIRT Boussad. <button id="about-btn" class="text-[var(--color-primary)] underline hover:text-[var(--color-secondary)]">En savoir plus</button>.</p>
        </footer>

        <!-- Mobile Nav (Bottom Bar) -->
        <nav id="mobile-nav" class="sm:hidden fixed bottom-4 left-4 right-4 bg-[var(--color-bg-card)]/90 backdrop-blur-lg border border-[var(--color-border)] flex justify-around shadow-2xl z-50 rounded-2xl p-2">
            <button data-tab="accueil-tab" class="nav-btn mobile flex-1 flex flex-col items-center gap-1 p-2 rounded-lg text-[var(--color-text-light)] active">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                <span class="text-[10px] font-medium">Accueil</span>
            </button>
            <button data-tab="explorer-tab" class="nav-btn mobile flex-1 flex flex-col items-center gap-1 p-2 rounded-lg text-[var(--color-text-light)]">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                <span class="text-[10px] font-medium">Explorer</span>
            </button>
            <div class="relative -top-6">
                <button data-tab="ai-sage-tab" class="nav-btn mobile w-14 h-14 rounded-full bg-[var(--color-heading)] text-[var(--color-bg)] flex items-center justify-center shadow-lg border-4 border-[var(--color-bg)] transform transition-transform active:scale-95">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 16a1 1 0 1 1 1-1 1 1 0 0 1-1 1zm1-5.16V14a1 1 0 0 1-2 0v-2a1 1 0 0 1 1-1 1.5 1.5 0 1 0-1.5-1.5 1 1 0 0 1-2 0 3.5 3.5 0 1 1 4.5 3.34z"/></svg>
                </button>
            </div>
            <button data-tab="favoris-tab" class="nav-btn mobile flex-1 flex flex-col items-center gap-1 p-2 rounded-lg text-[var(--color-text-light)]">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
                <span class="text-[10px] font-medium">Favoris</span>
            </button>
            <button data-tab="quiz-tab" class="nav-btn mobile flex-1 flex flex-col items-center gap-1 p-2 rounded-lg text-[var(--color-text-light)]">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
                <span class="text-[10px] font-medium">Quiz</span>
            </button>
        </nav>
    </div>

    <!-- Modals -->
    <div id="modal-backdrop" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] opacity-0 pointer-events-none transition-opacity duration-300"></div>
    
    <!-- Modal Contenu G√©n√©ral -->
    <div id="modal-content" role="dialog" aria-modal="true" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-2xl max-h-[85vh] bg-[var(--color-bg-card)] rounded-2xl shadow-2xl z-[101] opacity-0 scale-95 pointer-events-none transition-all duration-300 flex flex-col border border-[var(--color-border)]">
        <header class="flex-shrink-0 p-6 pb-4 pr-12 border-b border-[var(--color-border)] bg-[var(--color-bg-alt)]/50 rounded-t-2xl">
            <h2 id="modal-title" class="text-2xl font-display font-bold text-[var(--color-heading)]"></h2>
        </header>
        <div id="modal-body" class="prose max-w-none text-[var(--color-text)] p-6 overflow-y-auto custom-scrollbar"></div>
        <button id="modal-close-btn" class="absolute top-4 right-4 p-2 rounded-full hover:bg-[var(--color-border)] transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-[var(--color-text-light)]" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
    </div>

    <!-- Modal Mode Zen -->
    <div id="zen-modal" class="fixed inset-0 z-[150] bg-[var(--color-bg)] flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-500">
        <button id="close-zen" class="absolute top-6 right-6 p-3 rounded-full bg-[var(--color-bg-alt)] hover:bg-[var(--color-border)] transition-colors z-50">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
        </button>
        <div class="max-w-4xl px-8 text-center">
             <div class="w-24 h-1 bg-[var(--color-secondary)] mx-auto mb-12"></div>
             <p id="zen-kabyle" class="text-4xl md:text-6xl font-display font-bold leading-tight mb-10 text-[var(--color-heading)] kabyle-text"></p>
             <p id="zen-french" class="text-xl md:text-2xl font-light text-[var(--color-text-light)] italic proverb-text"></p>
        </div>
    </div>
    
    <!-- Modal Statistiques -->
    <div id="stats-modal" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-md bg-[var(--color-bg-card)] rounded-3xl shadow-2xl z-[101] opacity-0 scale-95 pointer-events-none transition-all duration-300 border border-[var(--color-border)]">
        <div class="p-6 text-center">
            <h2 class="text-2xl font-display font-bold mb-6 text-[var(--color-heading)]">Mon Parcours</h2>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="p-4 rounded-2xl bg-blue-50 dark:bg-blue-900/20">
                    <p class="text-3xl font-bold text-blue-600 dark:text-blue-400" id="stat-views">0</p>
                    <p class="text-xs text-[var(--color-text-light)] uppercase tracking-wide font-bold">Vus</p>
                </div>
                <div class="p-4 rounded-2xl bg-pink-50 dark:bg-pink-900/20">
                    <p class="text-3xl font-bold text-pink-600 dark:text-pink-400" id="stat-favs">0</p>
                    <p class="text-xs text-[var(--color-text-light)] uppercase tracking-wide font-bold">Favoris</p>
                </div>
                <div class="p-4 rounded-2xl bg-yellow-50 dark:bg-yellow-900/20 col-span-2">
                    <p class="text-3xl font-bold text-yellow-600 dark:text-yellow-400" id="stat-quiz">0</p>
                    <p class="text-xs text-[var(--color-text-light)] uppercase tracking-wide font-bold">Score Quiz Max</p>
                </div>
            </div>
            <button id="close-stats" class="w-full py-3 bg-[var(--color-bg-alt)] rounded-xl font-semibold hover:bg-[var(--color-border)] transition-colors text-[var(--color-text)]">Fermer</button>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" role="status" aria-live="polite" class="fixed bottom-24 sm:bottom-10 left-1/2 -translate-x-1/2 bg-[var(--color-heading)] text-[var(--color-bg)] py-3 px-6 rounded-full shadow-2xl opacity-0 z-[1000] flex items-center gap-3 pointer-events-none">
        <p class="font-medium text-sm"></p>
    </div>

    <button id="back-to-top" title="Retour en haut" class="fixed bottom-24 sm:bottom-10 right-5 p-3 bg-[var(--color-secondary)] text-white rounded-full shadow-xl hover:bg-[var(--color-primary)] focus:outline-none transition-all opacity-0 visibility-hidden transform-gpu translate-y-5 z-50">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6"/></svg>
    </button>

<script>
document.addEventListener('DOMContentLoaded', () => {

    /* --- CONFIGURATION & CONSTANTS --- */
    const CONFIG = {
        GEMINI_KEY: "AIzaSyDEzFSMcDAy-FQXD1Op9SO-LwEUO4jG6FE", // API Key preserved
        PROVERBS_FILE: 'proverbs.json',
        BATCH_SIZE: 50,
        KEYBOARD: ['…õ','…£','·∏•','·∏ç','·πõ','·π£','·π≠','·∫ì','ƒç','«ß']
    };

    /* --- DOM ELEMENTS --- */
    const dom = {
        html: document.documentElement,
        splash: document.getElementById('splash-screen'),
        navBtns: document.querySelectorAll('.nav-btn'),
        tabs: document.querySelectorAll('.tab-content'),
        
        // Search & Explore
        searchIn: document.getElementById('search-input'),
        clearSearch: document.querySelector('.clear-search-btn'),
        resultsContainer: document.getElementById('results-container'),
        loader: document.getElementById('infinite-scroll-loader'),
        themeContainer: document.getElementById('theme-list-container'),
        resultsFeedback: document.getElementById('results-feedback'),
        initialMsg: document.getElementById('initial-load-message'),
        noResults: document.getElementById('no-results'),
        
        // Hero / POD
        podCard: document.getElementById('proverb-of-the-day-container'),
        podCount: document.getElementById('proverb-count'), // This was in original text
        podExplain: document.getElementById('pod-explain-btn'),
        podZen: document.getElementById('pod-zen-mode'),
        
        // Favorites
        favContainer: document.getElementById('favorites-container'),
        noFavs: document.getElementById('no-favorites'),
        
        // AI
        aiInput: document.getElementById('ai-context-input'),
        aiBtn: document.getElementById('ai-suggest-btn'),
        aiStep: document.getElementById('ai-step-feedback'),
        aiResult: document.getElementById('ai-result-feedback'),
        
        // Quiz
        quizContainer: document.getElementById('quiz-container'),
        
        // Utils
        toast: document.getElementById('toast'),
        backTop: document.getElementById('back-to-top'),
        themeToggle: document.getElementById('theme-toggle'),
        themeIcons: { l: document.getElementById('theme-icon-light'), d: document.getElementById('theme-icon-dark') },
        
        // Modals
        modal: {
            el: document.getElementById('modal-content'),
            back: document.getElementById('modal-backdrop'),
            title: document.getElementById('modal-title'),
            body: document.getElementById('modal-body'),
            close: document.getElementById('modal-close-btn')
        },
        zenModal: {
            el: document.getElementById('zen-modal'),
            close: document.getElementById('close-zen'),
            k: document.getElementById('zen-kabyle'),
            f: document.getElementById('zen-french')
        },
        stats: {
            el: document.getElementById('stats-modal'),
            btn: document.getElementById('stats-btn'),
            close: document.getElementById('close-stats'),
            views: document.getElementById('stat-views'),
            favs: document.getElementById('stat-favs'),
            quiz: document.getElementById('stat-quiz'),
            badge: document.getElementById('fav-count-badge')
        }
    };

    /* --- STATE MANAGEMENT --- */
    const state = {
        proverbs: [],
        favorites: new Set(JSON.parse(localStorage.getItem('inzan_favorites')) || []),
        stats: JSON.parse(localStorage.getItem('inzan_stats') || '{"views":0, "quizHigh":0}'),
        activeTheme: localStorage.getItem('inzan_theme_filter') || 'tous',
        searchQuery: '',
        currentPage: 0,
        displayedCount: 0,
        totalFiltered: 0,
        isLoading: false,
        searchTimer: null,
        isDataLoaded: false,
        aiQuiz: { questions: [], index: 0, score: 0, loading: false }
    };

    /* --- UTILS --- */
    const normalize = (str) => {
        if (!str) return '';
        return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "")
            .replace(/…£/g,"gh").replace(/…õ/g,"3").replace(/ƒç/g,"tch")
            .replace(/«ß/g,"dj").replace(/·∏•/g,"h").replace(/·∏ç/g,"d").replace(/·πõ/g,"r")
            .replace(/·π£/g,"s").replace(/·π≠/g,"t").replace(/·∫ì/g,"z")
            .replace(/[^a-z0-9\s]/g, '');
    };

    const highlight = (text, query) => {
        if (!query || !text) return text;
        const normQ = normalize(query);
        const words = normQ.split(' ').filter(w => w.length > 0);
        if (words.length === 0) return text;
        const regex = new RegExp(`(${words.join('|')})`, 'gi');
        return text.replace(regex, `<span class="search-highlight">$1</span>`);
    };

    const showToast = (msg, isError = false) => {
        dom.toast.querySelector('p').textContent = msg;
        dom.toast.classList.remove('opacity-0', 'pointer-events-none');
        dom.toast.classList.add('opacity-100', 'translate-y-0');
        if(isError) dom.toast.classList.add('bg-red-600');
        else dom.toast.classList.remove('bg-red-600');
        
        setTimeout(() => {
            dom.toast.classList.add('opacity-0', 'pointer-events-none');
            dom.toast.classList.remove('opacity-100');
        }, 3000);
    };
    
    const updateStats = (type, val = 1) => {
        if(type === 'view') state.stats.views += val;
        if(type === 'quiz' && val > state.stats.quizHigh) state.stats.quizHigh = val;
        localStorage.setItem('inzan_stats', JSON.stringify(state.stats));
        renderStats();
    };
    
    const renderStats = () => {
        dom.stats.views.textContent = state.stats.views;
        dom.stats.favs.textContent = state.favorites.size;
        dom.stats.quiz.textContent = state.stats.quizHigh;
        dom.stats.badge.textContent = state.favorites.size;
    };

    /* --- CORE FUNCTIONALITY --- */

    // 1. Cards Generation
    const createCard = (p, isHero = false, query = '') => {
        const isFav = state.favorites.has(p.id);
        const themes = (p.theme || '').split(/[,/]/).map(t => t.trim().replace(/[()]/g, '')).filter(Boolean);
        const tagsHtml = themes.map(t => 
            `<button class="card-theme-badge text-[10px] uppercase font-bold text-[var(--color-primary)] bg-[var(--color-primary)]/10 px-2 py-1 rounded-md hover:bg-[var(--color-primary)] hover:text-white transition-colors" data-theme="${normalize(t)}">${t}</button>`
        ).join('');
        
        const baseClass = isHero 
            ? "flex flex-col items-center justify-center h-full text-center" 
            : "glass-panel p-6 rounded-2xl card-hover flex flex-col justify-between animate-enter border-l-4 border-[var(--color-primary)]";
            
        const content = isHero
            ? `<p class="text-3xl sm:text-4xl font-display font-bold text-[var(--color-heading)] mb-4 italic leading-tight kabyle-text">¬´ ${p.kabyle} ¬ª</p>
               <p class="text-lg sm:text-xl text-[var(--color-text-light)] proverb-text">‚Äî ${p.francais}</p>`
            : `
            <div>
                <div class="flex justify-between items-start mb-4">
                    <span class="text-2xl text-[var(--color-secondary)] font-display opacity-50">‚ùù</span>
                    <div class="flex gap-1 flex-wrap justify-end">${tagsHtml}</div>
                </div>
                <p class="text-xl font-display font-bold text-[var(--color-heading)] mb-3 leading-relaxed kabyle-text">¬´ ${highlight(p.kabyle, query)} ¬ª</p>
                <p class="text-[var(--color-text-light)] font-serif italic border-l-2 border-[var(--color-secondary)] pl-3 mb-6 text-lg proverb-text">${highlight(p.francais, query)}</p>
            </div>
            <div class="flex justify-between items-center pt-4 border-t border-[var(--color-border)]">
                <button class="text-xs font-bold text-[var(--color-text)] hover:text-[var(--color-primary)] explain-btn transition-colors flex items-center gap-1" data-id="${p.id}">EXPLIQUER ‚ú®</button>
                <div class="flex gap-1">
                    <button class="p-2 rounded-full hover:bg-[var(--color-bg-alt)] text-[var(--color-text-light)] hover:text-[var(--color-primary)] transition-colors tts-btn" data-id="${p.id}" title="√âcouter"><svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg></button>
                    <button class="p-2 rounded-full hover:bg-[var(--color-bg-alt)] text-[var(--color-text-light)] hover:text-[var(--color-primary)] transition-colors image-btn" data-id="${p.id}" title="Image"><svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg></button>
                    <button class="p-2 rounded-full hover:bg-pink-50 text-[var(--color-text-light)] transition-colors favorite-btn ${isFav?'text-pink-500 favorited':''}" data-id="${p.id}" title="Favoris"><svg width="20" height="20" fill="${isFav?'currentColor':'none'}" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg></button>
                    <button class="p-2 rounded-full hover:bg-[var(--color-bg-alt)] text-[var(--color-text-light)] hover:text-[var(--color-primary)] transition-colors copy-btn" data-id="${p.id}" title="Copier"><svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>
                    <button class="p-2 rounded-full hover:bg-[var(--color-bg-alt)] text-[var(--color-text-light)] hover:text-[var(--color-primary)] transition-colors share-btn" data-id="${p.id}" title="Partager"><svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6.002l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.367a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" /></svg></button>
                </div>
            </div>`;

        return `<div class="${baseClass}" data-id="${p.id}">${content}</div>`;
    };

    // 2. Rendering Logic
    const filterAndRender = (reset = false) => {
        if (!state.isDataLoaded) return;
        
        // Filter
        let filtered = state.proverbs;
        
        // Theme Filter
        if(state.activeTheme !== 'tous') {
            filtered = filtered.filter(p => p.theme_norm.includes(state.activeTheme));
        }
        
        // Search Filter
        const query = dom.searchIn.value.trim();
        if(query) {
            const normQ = normalize(query);
            const keywords = normQ.split(' ').filter(k => k);
            filtered = filtered.filter(p => 
                keywords.every(k => (p.kabyle_norm + ' ' + p.francais_norm + ' ' + p.theme_norm).includes(k))
            );
        }
        
        state.totalFiltered = filtered.length;
        dom.resultsFeedback.textContent = query || state.activeTheme !== 'tous' ? `${state.totalFiltered} r√©sultat(s)` : '';

        if(reset) {
            dom.resultsContainer.innerHTML = '';
            state.currentPage = 0;
            state.displayedCount = 0;
            dom.initialMsg.classList.add('hidden');
            if(state.totalFiltered === 0 && (query || state.activeTheme !== 'tous')) {
                dom.noResults.classList.remove('hidden');
                return;
            } else {
                dom.noResults.classList.add('hidden');
            }
            // If exploring without query/theme, show initial message
            if(!query && state.activeTheme === 'tous') {
                dom.initialMsg.classList.remove('hidden');
                return; 
            }
        }
        
        const start = state.currentPage * CONFIG.BATCH_SIZE;
        const chunk = filtered.slice(start, start + CONFIG.BATCH_SIZE);
        
        if(chunk.length > 0) {
            const html = chunk.map(p => createCard(p, false, query)).join('');
            dom.resultsContainer.insertAdjacentHTML('beforeend', html);
            state.currentPage++;
            state.displayedCount += chunk.length;
        }
        
        state.isLoading = false;
        dom.loader.classList.add('hidden');
    };

    // 3. Modals & Actions
    const openModal = (title, content) => {
        dom.modal.title.textContent = title;
        dom.modal.body.innerHTML = content;
        dom.modal.back.classList.remove('opacity-0', 'pointer-events-none');
        dom.modal.el.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
        document.body.style.overflow = 'hidden';
    };
    
    const closeModal = () => {
        [dom.modal.back, dom.modal.el, dom.zenModal.el, dom.stats.el].forEach(el => {
            el.classList.add('opacity-0', 'pointer-events-none');
            if(el !== dom.modal.back && el !== dom.zenModal.el) el.classList.add('scale-95');
        });
        document.body.style.overflow = '';
    };

    const toggleFav = (id) => {
        if(state.favorites.has(id)) {
            state.favorites.delete(id);
            showToast("Retir√© des favoris üíî");
        } else {
            state.favorites.add(id);
            showToast("Ajout√© aux favoris ‚ù§Ô∏è");
        }
        localStorage.setItem('inzan_favorites', JSON.stringify([...state.favorites]));
        updateStats(); // Update badge
        
        // Update UI
        document.querySelectorAll(`.favorite-btn[data-id="${id}"]`).forEach(btn => {
            btn.classList.toggle('favorited', state.favorites.has(id));
            btn.classList.toggle('text-pink-500', state.favorites.has(id));
            btn.querySelector('svg').setAttribute('fill', state.favorites.has(id) ? 'currentColor' : 'none');
        });
        
        if(document.getElementById('favoris-tab').classList.contains('active')) renderFavorites();
    };

    const renderFavorites = () => {
        dom.favContainer.innerHTML = '';
        if(state.favorites.size === 0) {
            dom.noFavs.classList.remove('hidden');
            return;
        }
        dom.noFavs.classList.add('hidden');
        const favs = state.proverbs.filter(p => state.favorites.has(p.id));
        dom.favContainer.innerHTML = favs.map(p => createCard(p)).join('');
    };

    // 4. Gemini Integration
    const callAI = async (text, systemPrompt, isJson = false) => {
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${CONFIG.GEMINI_KEY}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    contents: [{ parts: [{ text: text }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: isJson ? { responseMimeType: "application/json" } : {}
                })
            });
            const data = await res.json();
            if(!res.ok) throw new Error(data.error?.message || 'API Error');
            return data.candidates[0].content.parts[0].text;
        } catch(e) {
            console.error(e);
            throw e;
        }
    };

    // 5. Image Generation (Canvas)
    const generateImage = (p) => {
        openModal("Aper√ßu Image HD", `<div class="text-center"><canvas id="share-canvas" width="1080" height="1080" style="max-width:100%;height:auto;border-radius:12px;box-shadow:0 10px 15px -3px rgba(0,0,0,0.1);"></canvas><a id="dl-link" class="mt-4 inline-block w-full py-3 bg-[var(--color-primary)] text-white font-bold rounded-xl shadow-lg">T√©l√©charger l'image</a></div>`);
        
        const canvas = document.getElementById('share-canvas');
        const ctx = canvas.getContext('2d');
        
        // Background Gradient
        const grad = ctx.createLinearGradient(0,0,1080,1080);
        grad.addColorStop(0, '#F9F7F3');
        grad.addColorStop(1, '#E2E8F0');
        ctx.fillStyle = grad;
        ctx.fillRect(0,0,1080,1080);
        
        // Decor
        ctx.strokeStyle = 'rgba(74, 124, 89, 0.1)';
        ctx.lineWidth = 3;
        for(let i=0; i<1080; i+=60) {
            ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(i+200, 1080); ctx.stroke();
        }
        
        // Card Body
        ctx.shadowColor = "rgba(0,0,0,0.1)"; ctx.shadowBlur = 40; ctx.shadowOffsetY = 20;
        ctx.fillStyle = "#FFFFFF";
        ctx.roundRect(100, 150, 880, 780, 40);
        ctx.fill();
        ctx.shadowColor = "transparent";
        
        // Text
        ctx.textAlign = 'center';
        ctx.fillStyle = '#4A7C59';
        ctx.font = 'bold 100px sans-serif'; 
        ctx.fillText("‚µ£", 540, 260);
        
        const wrap = (txt, y, font, col) => {
            ctx.font = font; ctx.fillStyle = col;
            const words = txt.split(' ');
            let line = '';
            for(let w of words) {
                if(ctx.measureText(line + w).width > 700) {
                    ctx.fillText(line, 540, y); line = ''; y += 70;
                }
                line += w + ' ';
            }
            ctx.fillText(line, 540, y);
            return y;
        };
        
        let y = 420;
        y = wrap(`¬´ ${p.kabyle} ¬ª`, y, 'italic bold 55px serif', '#1A202C');
        
        ctx.beginPath(); ctx.moveTo(440, y+40); ctx.lineTo(640, y+40); 
        ctx.strokeStyle = '#C79A2A'; ctx.lineWidth = 5; ctx.stroke();
        
        wrap(p.francais, y+130, '40px sans-serif', '#718096');
        
        ctx.font = 'bold 30px sans-serif'; ctx.fillStyle = '#4A7C59';
        ctx.fillText("Inzan n Teqbaylit", 540, 880);
        
        document.getElementById('dl-link').href = canvas.toDataURL('image/png');
        document.getElementById('dl-link').download = `inzan-${p.id}.png`;
    };

    // 6. Initialization
    const init = async () => {
        // Theme
        const isDark = localStorage.getItem('inzan_theme') === 'dark';
        if(isDark) {
            dom.html.classList.add('dark');
            dom.themeIcons.l.classList.add('hidden');
            dom.themeIcons.d.classList.remove('hidden');
        }
        
        // Service Worker
        registerServiceWorker();

        // Keyboard Generation
        dom.themeContainer.previousElementSibling.firstElementChild.innerHTML = CONFIG.KEYBOARD.map(c => 
            `<button class="w-10 h-10 rounded-lg glass-panel hover:bg-[var(--color-primary)] hover:text-white transition-colors text-lg font-serif shadow-sm flex-shrink-0" onclick="insertChar('${c}')">${c}</button>`
        ).join('');

        try {
            const res = await fetch(CONFIG.PROVERBS_FILE);
            const data = await res.json();
            
            state.proverbs = data.map((p,i) => ({
                ...p, id: i,
                kabyle_norm: normalize(p.kabyle),
                francais_norm: normalize(p.francais),
                theme_norm: normalize(p.theme)
            }));
            state.isDataLoaded = true;
            
            // Stats & Themes
            updateStats(); // Render stats
            const themes = [...new Set(state.proverbs.flatMap(p => (p.theme||'').split(/[,/]/).map(t=>normalize(t.trim())).filter(Boolean)))].sort();
            
            dom.themeContainer.innerHTML = 
                `<button class="theme-pill-button flex-shrink-0 px-4 py-2 rounded-full ${state.activeTheme === 'tous' ? 'bg-[var(--color-primary)] text-white shadow-md' : 'glass-panel'} text-sm font-semibold transition-colors" data-theme="tous">Tous</button>` +
                themes.map(t => `<button class="theme-pill-button flex-shrink-0 px-4 py-2 rounded-full ${state.activeTheme === t ? 'bg-[var(--color-primary)] text-white shadow-md' : 'glass-panel'} text-sm font-semibold transition-colors hover:bg-[var(--color-bg-alt)]" data-theme="${t}">${t.charAt(0).toUpperCase() + t.slice(1)}</button>`).join('');

            // POD
            const dayIdx = Math.floor(new Date().getTime() / 86400000) % state.proverbs.length;
            const pod = state.proverbs[dayIdx];
            dom.podCard.innerHTML = createCard(pod, true);
            if(dom.podCount) dom.podCount.textContent = `${state.proverbs.length} proverbes`; // Set count text
            
            // POD Actions
            dom.podExplain.onclick = () => explainProverb(pod);
            dom.podZen.onclick = () => {
                dom.zenModal.k.textContent = `¬´ ${pod.kabyle} ¬ª`;
                dom.zenModal.f.textContent = pod.francais;
                dom.zenModal.el.classList.remove('opacity-0', 'pointer-events-none');
            };

            // Remove Splash
            dom.splash.classList.add('opacity-0', 'pointer-events-none');
            
            // Init filters
            if(state.activeTheme !== 'tous') {
                filterAndRender(true);
                dom.html.scrollTo({top:0});
            }

        } catch(e) {
            console.error(e);
            dom.initialMsg.innerHTML = `<p class="text-red-500">Erreur de chargement des donn√©es. Veuillez recharger.</p>`;
            dom.splash.classList.add('hidden');
        }
    };
    
    // 7. Explainer Logic
    const explainProverb = async (p) => {
        openModal("Explication du Sage", `<div class="text-center py-8"><span class="loader"></span></div>`);
        try {
            const txt = await callAI(
                `Explique ce proverbe kabyle : "${p.kabyle}" (Sens: "${p.francais}")`,
                `Tu es un expert culturel. Explique le sens litt√©ral, imag√© et donne un exemple. Utilise du Markdown (### Titres).`
            );
            
            // Simple MD to HTML
            let html = txt.replace(/^### (.*$)/gim, '<h3 class="text-xl font-bold text-[var(--color-primary)] mt-4 mb-2">$1</h3>')
                          .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
                          .replace(/\n/g, '<br>');
            dom.modal.body.innerHTML = html;
        } catch(e) {
            dom.modal.body.innerHTML = `<p class="text-red-500">Le Sage est indisponible.</p>`;
        }
    };
    
    // 8. Event Listeners
    
    // Global Click Delegation
    document.body.addEventListener('click', (e) => {
        const t = e.target;
        
        // Navigation
        if(t.closest('.nav-btn')) {
            const btn = t.closest('.nav-btn');
            const tabId = btn.dataset.tab;
            dom.navBtns.forEach(b => b.classList.remove('active'));
            dom.tabs.forEach(c => c.classList.remove('active'));
            
            document.querySelectorAll(`[data-tab="${tabId}"]`).forEach(b => b.classList.add('active'));
            document.getElementById(tabId).classList.add('active');
            window.scrollTo({top:0, behavior:'smooth'});
            
            if(tabId === 'favoris-tab') renderFavorites();
            if(tabId === 'quiz-tab' && !document.getElementById('quiz-game')) startQuizIntro();
        }
        
        // Card Actions
        const btn = t.closest('button');
        if(!btn) return;
        
        if(btn.classList.contains('explain-btn')) explainProverb(state.proverbs[btn.dataset.id]);
        if(btn.classList.contains('favorite-btn')) toggleFav(parseInt(btn.dataset.id));
        if(btn.classList.contains('tts-btn')) speakProverb(state.proverbs[btn.dataset.id].kabyle);
        if(btn.classList.contains('image-btn')) generateImage(state.proverbs[btn.dataset.id]);
        if(btn.classList.contains('copy-btn')) {
            const p = state.proverbs[btn.dataset.id];
            navigator.clipboard.writeText(`¬´ ${p.kabyle} ¬ª\n‚Äî ${p.francais}`);
            showToast("Proverbe copi√© !");
        }
        if(btn.classList.contains('share-btn')) {
             const p = state.proverbs[btn.dataset.id];
             if(navigator.share) navigator.share({title:'Inzan', text:`${p.kabyle}\n${p.francais}`, url:location.href});
             else showToast("Partage non support√©");
        }
        if(btn.classList.contains('card-theme-badge')) {
            // Click on theme badge -> Filter
            setActiveTheme(btn.dataset.theme);
        }
        if(btn.classList.contains('theme-pill-button')) {
            setActiveTheme(btn.dataset.theme);
        }
    });

    const setActiveTheme = (theme) => {
        state.activeTheme = theme;
        localStorage.setItem('inzan_theme_filter', theme);
        
        // Update UI Pills
        document.querySelectorAll('.theme-pill-button').forEach(b => {
            if(b.dataset.theme === theme) {
                b.classList.remove('glass-panel'); 
                b.classList.add('bg-[var(--color-primary)]', 'text-white', 'shadow-md');
            } else {
                b.classList.add('glass-panel');
                b.classList.remove('bg-[var(--color-primary)]', 'text-white', 'shadow-md');
            }
        });
        
        // Go to explorer
        document.querySelector('[data-tab="explorer-tab"]').click();
        filterAndRender(true);
    };

    // Search
    dom.searchIn.addEventListener('input', (e) => {
        dom.clearSearch.classList.toggle('opacity-0', !e.target.value);
        clearTimeout(state.searchTimer);
        state.searchTimer = setTimeout(() => filterAndRender(true), 350);
    });
    
    dom.clearSearch.addEventListener('click', () => {
        dom.searchIn.value = '';
        dom.clearSearch.classList.add('opacity-0');
        filterAndRender(true);
    });
    
    // Random
    document.getElementById('random-btn').addEventListener('click', () => {
        dom.resultsContainer.innerHTML = '';
        const rand = state.proverbs[Math.floor(Math.random() * state.proverbs.length)];
        dom.resultsContainer.innerHTML = createCard(rand);
        updateStats('view');
    });
    
    // Scroll
    window.addEventListener('scroll', () => {
        dom.backTop.classList.toggle('visible', window.scrollY > 300);
        if((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500 && !state.isLoading && document.getElementById('explorer-tab').classList.contains('active')) {
            state.isLoading = true;
            dom.loader.classList.remove('hidden');
            filterAndRender();
        }
    });
    dom.backTop.onclick = () => window.scrollTo({top:0, behavior:'smooth'});

    // AI Sage
    dom.aiBtn.onclick = async () => {
        const txt = dom.aiInput.value.trim();
        if(!txt) return showToast("D√©crivez une situation.");
        
        dom.aiBtn.disabled = true;
        dom.aiBtn.innerHTML = '<span class="loader"></span>';
        dom.aiStep.textContent = "Le Sage consulte les anc√™tres...";
        
        try {
            // Etape 1 : Mots cl√©s
            const kwJson = await callAI(
                `Trouve 5 mots-cl√©s (fran√ßais/kabyle) pour cette situation: "${txt}"`,
                `Format JSON: {"keywords":["mot1"]}`, true
            );
            const keys = JSON.parse(kwJson).keywords;
            dom.aiStep.textContent = `Pistes: ${keys.join(', ')}`;
            
            // Etape 2 : Filtrage local
            const candidates = state.proverbs.filter(p => 
                keys.some(k => (p.kabyle_norm + ' ' + p.francais_norm).includes(normalize(k)))
            ).slice(0, 15);
            
            // Etape 3 : S√©lection finale
            const finalJson = await callAI(
                `Situation: "${txt}". Candidats: ${JSON.stringify(candidates.map(c=>({id:c.id, f:c.francais})))}. Choisis le meilleur.`,
                `Format JSON: {"reasoning":"...", "proverbs":[{"id":123,"justification":"..."}]}`, true
            );
            
            const result = JSON.parse(finalJson);
            let html = `<p class="italic text-center mb-6">"${result.reasoning}"</p>`;
            result.proverbs.forEach(r => {
                const full = state.proverbs.find(p => p.id === r.id);
                if(full) {
                    html += `<div class="mb-4 glass-panel p-4 rounded-xl border-l-4 border-[var(--color-secondary)]"><p class="text-sm font-bold mb-2">Conseil du Sage :</p><p class="text-sm italic mb-4">${r.justification}</p>${createCard(full).replace('glass-panel', '')}</div>`;
                }
            });
            dom.aiResult.innerHTML = html || "<p class='text-center'>Aucun proverbe sp√©cifique trouv√©.</p>";
            
        } catch(e) {
            dom.aiResult.innerHTML = "<p class='text-red-500 text-center'>Le Sage est fatigu√©.</p>";
        } finally {
            dom.aiBtn.disabled = false;
            dom.aiBtn.textContent = "‚ú® Demander conseil";
        }
    };
    
    // Quiz Functions
    const startQuizIntro = () => {
        dom.quizContainer.innerHTML = `
            <div class="text-center p-8 flex flex-col items-center justify-center h-full">
                <div class="w-20 h-20 bg-orange-100 rounded-full flex items-center justify-center text-orange-600 mb-6 text-3xl">üß†</div>
                <h3 class="text-2xl font-bold mb-4">Quiz IA Dynamique</h3>
                <p class="text-[var(--color-text-light)] mb-8">L'IA g√©n√®re 10 questions uniques bas√©es sur la base de donn√©es.</p>
                <button id="start-quiz-btn" class="w-full py-4 bg-[var(--color-primary)] text-white font-bold rounded-xl shadow-lg hover:brightness-110 transition-all">Commencer</button>
            </div>`;
        document.getElementById('start-quiz-btn').onclick = loadQuiz;
    };
    
    const loadQuiz = async () => {
        dom.quizContainer.innerHTML = `<div class="text-center p-12"><span class="loader"></span><p class="mt-4">G√©n√©ration du quiz...</p></div>`;
        try {
            const subset = state.proverbs.sort(()=>0.5-Math.random()).slice(0, 20);
            const json = await callAI(
                `G√©n√®re 5 questions QCM sur ces proverbes: ${JSON.stringify(subset.map(p=>({k:p.kabyle,f:p.francais})))}`,
                `JSON Strict: {"questions":[{"q":"Question?","opts":["A","B","C"],"a":0,"exp":"Explication"}]}`, true
            );
            state.aiQuiz.questions = JSON.parse(json).questions;
            state.aiQuiz.index = 0;
            state.aiQuiz.score = 0;
            renderQuestion();
        } catch(e) {
            startQuizIntro();
            showToast("Erreur g√©n√©ration quiz", true);
        }
    };
    
    const renderQuestion = () => {
        if(state.aiQuiz.index >= state.aiQuiz.questions.length) {
            // Fin
            updateStats('quiz', state.aiQuiz.score * 20); // Scale to 100
            dom.quizContainer.innerHTML = `
                <div class="text-center p-12">
                    <h3 class="text-3xl font-bold mb-4">Termin√© !</h3>
                    <p class="text-5xl font-bold text-[var(--color-primary)] mb-4">${state.aiQuiz.score}/${state.aiQuiz.questions.length}</p>
                    <button onclick="document.getElementById('start-quiz-btn').click()" class="px-6 py-2 bg-[var(--color-bg-alt)] rounded-lg font-bold">Rejouer</button>
                </div>`;
            return;
        }
        
        const q = state.aiQuiz.questions[state.aiQuiz.index];
        const opts = q.opts.map((o,i) => `<button class="quiz-opt w-full text-left p-4 rounded-xl border border-[var(--color-border)] hover:bg-[var(--color-bg-alt)] mb-2 transition-colors" data-i="${i}">${o}</button>`).join('');
        
        dom.quizContainer.innerHTML = `
            <div id="quiz-game" class="p-6">
                <div class="flex justify-between mb-6 text-sm font-bold opacity-60">
                    <span>Question ${state.aiQuiz.index+1}/${state.aiQuiz.questions.length}</span>
                    <span>Score: ${state.aiQuiz.score}</span>
                </div>
                <h3 class="text-xl font-bold mb-6">${q.q}</h3>
                <div id="q-opts">${opts}</div>
                <div id="q-feedback" class="hidden mt-4 p-4 rounded-xl bg-[var(--color-bg-alt)]"></div>
            </div>`;
            
        document.querySelectorAll('.quiz-opt').forEach(b => b.onclick = (e) => handleAnswer(e, q));
    };
    
    const handleAnswer = (e, q) => {
        const selected = parseInt(e.target.dataset.i);
        const isCorrect = selected === q.a;
        
        document.querySelectorAll('.quiz-opt').forEach((b,i) => {
            b.disabled = true;
            if(i === q.a) b.classList.add('bg-green-100', 'border-green-500', 'text-green-800');
            else if(i === selected) b.classList.add('bg-red-100', 'border-red-500', 'text-red-800');
        });
        
        if(isCorrect) {
            state.aiQuiz.score++;
            showToast("Correct ! üéâ");
        }
        
        const fb = document.getElementById('q-feedback');
        fb.innerHTML = `<p class="font-bold">${isCorrect?'Bien jou√© !':'Oups...'}</p><p class="text-sm">${q.exp}</p><button id="next-q" class="mt-2 w-full py-2 bg-[var(--color-heading)] text-white rounded-lg">Suivant</button>`;
        fb.classList.remove('hidden');
        document.getElementById('next-q').onclick = () => {
            state.aiQuiz.index++;
            renderQuestion();
        };
    };

    // Modals & Misc
    dom.modal.close.onclick = closeModal;
    dom.modal.back.onclick = closeModal;
    dom.zenModal.close.onclick = closeModal;
    dom.stats.close.onclick = closeModal;
    
    dom.stats.btn.onclick = () => {
        renderStats();
        dom.stats.el.classList.remove('opacity-0', 'pointer-events-none', 'scale-95');
        dom.modal.back.classList.remove('opacity-0', 'pointer-events-none');
    };
    
    document.getElementById('about-btn').onclick = () => openModal("√Ä propos", `<p>Cette collection num√©rique est un hommage √† la richesse de la sagesse populaire kabyle. Elle est bas√©e sur une partie des donn√©es patiemment r√©colt√©es par Monsieur <strong>Rem·∏çan At Men·π£ur</strong> dans son <strong>Dictionnaire de proverbes Kabyles</strong>, dont le travail a permis de pr√©server et de partager ces tr√©sors culturels.</p>`);

    // Theme Toggle Logic
    dom.themeToggle.onclick = () => {
        dom.html.classList.toggle('dark');
        const isDark = dom.html.classList.contains('dark');
        localStorage.setItem('inzan_theme', isDark ? 'dark' : 'light');
        dom.themeIcons.l.classList.toggle('hidden', isDark);
        dom.themeIcons.d.classList.toggle('hidden', !isDark);
    };

    // TTS Helper
    window.speakProverb = (text) => {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text.toLowerCase().replace(/…£/g,"rh").replace(/…õ/g,"aa").replace(/ƒç/g,"tch"));
        u.lang = 'fr-FR'; // Hack for Kabyle sounds via French engine
        window.speechSynthesis.speak(u);
        showToast("Lecture audio...");
    };

    // Start
    init();
});
</script>
</body>
</html>
